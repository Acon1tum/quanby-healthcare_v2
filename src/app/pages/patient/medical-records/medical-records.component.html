<div class="medical-records-container">
  <!-- Header Section -->
  <div class="records-header">
    <div class="header-content">
      <div class="back-section">
        <div class="header-text">
          <h1>Medical Records</h1>
          <p>Your complete health history and medical information</p>
        </div>
      </div>
      
      <div class="header-actions">
        <button class="refresh-btn" (click)="loadMedicalRecords()" [disabled]="loading">
          <i class="material-icons">refresh</i>
          {{ loading ? 'Loading...' : 'Refresh' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-state">
    <div class="spinner"></div>
    <p>Loading your medical records...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="error-state">
    <i class="material-icons">error</i>
    <p>{{ error }}</p>
    <button class="retry-btn" (click)="loadMedicalRecords()">Try Again</button>
  </div>

  <!-- Medical Records Content -->
  <div *ngIf="medicalRecords && !loading" class="records-content">
    <!-- Patient Information Section -->
    <div class="patient-info-section" *ngIf="patientInfo">
      <div class="patient-info-card">
        <div class="patient-header">
          <div class="patient-avatar">
            <i class="material-icons">person</i>
          </div>
          <div class="patient-details">
            <h2>{{ getPatientFullName() }}</h2>
            <p class="patient-age">{{ getPatientAge() }} years old â€¢ {{ patientInfo.gender }}</p>
            <p class="patient-id">Patient ID: {{ patientInfo.id }}</p>
          </div>
        </div>
        
        <div class="patient-stats">
          <div class="stat-item">
            <div class="stat-value">{{ patientInfo.height }} cm</div>
            <div class="stat-label">Height</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">{{ patientInfo.weight }} kg</div>
            <div class="stat-label">Weight</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">{{ getPatientBMI() }}</div>
            <div class="stat-label">BMI</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">{{ patientInfo.bloodType }}</div>
            <div class="stat-label">Blood Type</div>
          </div>
        </div>

        <div class="patient-info-grid">
          <div class="info-section">
            <h3>Contact Information</h3>
            <div class="info-item">
              <i class="material-icons">phone</i>
              <span>{{ patientInfo.contactNumber }}</span>
            </div>
            <div class="info-item">
              <i class="material-icons">location_on</i>
              <span>{{ patientInfo.address }}</span>
            </div>
            <div class="info-item">
              <i class="material-icons">cake</i>
              <span>{{ formatDate(patientInfo.dateOfBirth) }}</span>
            </div>
          </div>

          <div class="info-section" *ngIf="patientInfo.medicalHistory || patientInfo.allergies || patientInfo.medications">
            <h3>Medical Information</h3>
            <div class="info-item" *ngIf="patientInfo.medicalHistory">
              <i class="material-icons">medical_services</i>
              <span><strong>Medical History:</strong> {{ patientInfo.medicalHistory }}</span>
            </div>
            <div class="info-item" *ngIf="patientInfo.allergies">
              <i class="material-icons">warning</i>
              <span><strong>Allergies:</strong> {{ patientInfo.allergies }}</span>
            </div>
            <div class="info-item" *ngIf="patientInfo.medications">
              <i class="material-icons">medication</i>
              <span><strong>Current Medications:</strong> {{ patientInfo.medications }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Summary Cards -->
    <div class="summary-cards">
      <div class="summary-card">
        <div class="card-icon">
          <i class="material-icons">event</i>
        </div>
        <div class="card-content">
          <div class="card-value">{{ medicalRecords.summary.totalConsultations }}</div>
          <div class="card-label">Total Consultations</div>
        </div>
      </div>
      
      <div class="summary-card">
        <div class="card-icon">
          <i class="material-icons">monitor_heart</i>
        </div>
        <div class="card-content">
          <div class="card-value">{{ medicalRecords.summary.totalHealthScans }}</div>
          <div class="card-label">Health Scans</div>
        </div>
      </div>
      
      <div class="summary-card">
        <div class="card-icon">
          <i class="material-icons">schedule</i>
        </div>
        <div class="card-content">
          <div class="card-value">
            {{ medicalRecords.summary.lastConsultation ? formatDate(medicalRecords.summary.lastConsultation) : 'N/A' }}
          </div>
          <div class="card-label">Last Consultation</div>
        </div>
      </div>
      
      <div class="summary-card">
        <div class="card-icon">
          <i class="material-icons">favorite</i>
        </div>
        <div class="card-content">
          <div class="card-value">
            {{ medicalRecords.summary.lastHealthScan ? formatDate(medicalRecords.summary.lastHealthScan) : 'N/A' }}
          </div>
          <div class="card-label">Last Health Scan</div>
        </div>
      </div>
      
      <div class="summary-card">
        <div class="card-icon">
          <i class="material-icons">medical_information</i>
        </div>
        <div class="card-content">
          <div class="card-value">{{ medicalRecords.summary.totalMedicalRecords }}</div>
          <div class="card-label">Medical Records</div>
        </div>
      </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="nav-tabs">
      <button 
        class="tab-btn" 
        [class.active]="selectedTab === 'overview'"
        (click)="selectTab('overview')"
      >
        <i class="material-icons">dashboard</i>
        Overview
      </button>
      <button 
        class="tab-btn" 
        [class.active]="selectedTab === 'trends'"
        (click)="selectTab('trends')"
      >
        <i class="material-icons">trending_up</i>
        Health Trends
      </button>
      <button 
        class="tab-btn" 
        [class.active]="selectedTab === 'consultations'"
        (click)="selectTab('consultations')"
      >
        <i class="material-icons">event</i>
        Consultations
      </button>
      <button 
        class="tab-btn" 
        [class.active]="selectedTab === 'medical-history'"
        (click)="selectTab('medical-history')"
      >
        <i class="material-icons">medical_information</i>
        Self Check History
      </button>
    </div>

    <!-- Tab Content -->
    <div class="tab-content">
      <!-- Overview Tab -->
      <div *ngIf="selectedTab === 'overview'" class="overview-tab">
        <div class="overview-grid">
          <!-- Patient Information -->
          <div class="overview-card">
            <h3>Personal Information</h3>
            <div class="info-grid">
              <div class="info-item">
                <label>Name</label>
                <p>{{ medicalRecords.patientInfo.fullName }}</p>
              </div>
              <div class="info-item">
                <label>Gender</label>
                <p>{{ medicalRecords.patientInfo.gender }}</p>
              </div>
              <div class="info-item">
                <label>Date of Birth</label>
                <p>{{ formatDate(medicalRecords.patientInfo.dateOfBirth) }}</p>
              </div>
              <div class="info-item">
                <label>Blood Type</label>
                <p>{{ medicalRecords.patientInfo.bloodType }}</p>
              </div>
              <div class="info-item">
                <label>Height</label>
                <p>{{ medicalRecords.patientInfo.height }} cm</p>
              </div>
              <div class="info-item">
                <label>Weight</label>
                <p>{{ medicalRecords.patientInfo.weight }} kg</p>
              </div>
              <div class="info-item">
                <label>BMI</label>
                <p>{{ getBMIValue(medicalRecords.patientInfo.weight, medicalRecords.patientInfo.height) }} ({{ getBMICategory(medicalRecords.patientInfo.weight, medicalRecords.patientInfo.height) }})</p>
              </div>
            </div>
          </div>

          <!-- Medical History -->
          <div class="overview-card">
            <h3>Medical History</h3>
            <div class="info-content">
              <div class="info-item">
                <label>Medical History</label>
                <p>{{ medicalRecords.patientInfo.medicalHistory || 'No significant medical history recorded' }}</p>
              </div>
              <div class="info-item">
                <label>Allergies</label>
                <div class="tags">
                  <span *ngFor="let allergy of parseStringArray(medicalRecords.patientInfo.allergies)" class="tag">{{ allergy }}</span>
                  <span *ngIf="!parseStringArray(medicalRecords.patientInfo.allergies)?.length" class="no-data">No allergies recorded</span>
                </div>
              </div>
              <div class="info-item">
                <label>Current Medications</label>
                <div class="tags">
                  <span *ngFor="let medication of parseStringArray(medicalRecords.patientInfo.medications)" class="tag">{{ medication }}</span>
                  <span *ngIf="!parseStringArray(medicalRecords.patientInfo.medications)?.length" class="no-data">No medications recorded</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Emergency Contact -->
          <div class="overview-card" *ngIf="medicalRecords.patientInfo.emergencyContact">
            <h3>Emergency Contact</h3>
            <div class="info-grid">
              <div class="info-item">
                <label>Name</label>
                <p>{{ medicalRecords.patientInfo.emergencyContact.contactName }}</p>
              </div>
              <div class="info-item">
                <label>Relationship</label>
                <p>{{ medicalRecords.patientInfo.emergencyContact.relationship }}</p>
              </div>
              <div class="info-item">
                <label>Phone</label>
                <p>{{ medicalRecords.patientInfo.emergencyContact.contactNumber }}</p>
              </div>
              <div class="info-item" *ngIf="medicalRecords.patientInfo.emergencyContact.contactAddress">
                <label>Address</label>
                <p>{{ medicalRecords.patientInfo.emergencyContact.contactAddress }}</p>
              </div>
            </div>
          </div>

          <!-- Insurance Information -->
          <div class="overview-card" *ngIf="medicalRecords.patientInfo.insuranceInfo">
            <h3>Insurance Information</h3>
            <div class="info-grid">
              <div class="info-item">
                <label>Provider</label>
                <p>{{ medicalRecords.patientInfo.insuranceInfo.providerName }}</p>
              </div>
              <div class="info-item">
                <label>Policy Number</label>
                <p>{{ medicalRecords.patientInfo.insuranceInfo.policyNumber }}</p>
              </div>
              <div class="info-item">
                <label>Contact</label>
                <p>{{ medicalRecords.patientInfo.insuranceInfo.insuranceContact }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Consultations Tab -->
      <div *ngIf="selectedTab === 'consultations'" class="consultations-tab">
        <!-- Consultations Header -->
        <div class="consultations-header">
          <div class="header-info">
            <h3>Your Consultations</h3>
            <p>{{ consultations.length }} consultation{{ consultations.length !== 1 ? 's' : '' }} found</p>
          </div>
          <div class="header-actions">
            <button class="filter-btn" (click)="toggleFilterMenu()">
              <i class="material-icons">filter_list</i>
              Filter
            </button>
            <button class="sort-btn" (click)="toggleSortMenu()">
              <i class="material-icons">sort</i>
              Sort
            </button>
          </div>
        </div>

        <!-- Filter and Sort Menus -->
        <div class="filter-sort-container" *ngIf="showFilterMenu || showSortMenu">
          <div class="filter-menu" *ngIf="showFilterMenu">
            <h4>Filter by Status</h4>
            <div class="filter-options">
              <label class="filter-option">
                <input type="checkbox" [(ngModel)]="filters.completed" (change)="applyFilters()">
                <span class="status-badge completed">Completed</span>
              </label>
              <label class="filter-option">
                <input type="checkbox" [(ngModel)]="filters.scheduled" (change)="applyFilters()">
                <span class="status-badge scheduled">Scheduled</span>
              </label>
              <label class="filter-option">
                <input type="checkbox" [(ngModel)]="filters.inProgress" (change)="applyFilters()">
                <span class="status-badge in-progress">In Progress</span>
              </label>
            </div>
          </div>
          
          <div class="sort-menu" *ngIf="showSortMenu">
            <h4>Sort by</h4>
            <select [(ngModel)]="sortBy" (change)="applySorting()">
              <option value="date-desc">Date (Newest First)</option>
              <option value="date-asc">Date (Oldest First)</option>
              <option value="doctor">Doctor Name</option>
              <option value="status">Status</option>
            </select>
          </div>
        </div>

        <!-- Consultations List -->
        <div class="consultations-list">
          <div *ngFor="let consultation of filteredConsultations; trackBy: trackByConsultationId" 
               class="consultation-card" 
               [class.featured]="isRecentConsultation(consultation)"
               (click)="viewConsultation(consultation)">
            
            <!-- Card Header -->
            <div class="consultation-header">
              <div class="consultation-date">
                <div class="date">{{ formatDate(consultation.startTime) }}</div>
                <div class="time">{{ formatTime(consultation.startTime) }}</div>
                <div class="day-of-week">{{ getDayOfWeek(consultation.startTime) }}</div>
              </div>
              
              <div class="consultation-doctor">
                <div class="doctor-avatar">
                  <i class="material-icons">person</i>
                </div>
                <div class="doctor-info">
                  <div class="doctor-name">Dr. {{ consultation.doctor?.doctorInfo?.firstName || 'Unknown' }} {{ consultation.doctor?.doctorInfo?.lastName || 'Doctor' }}</div>
                  <div class="specialty">{{ consultation.doctor?.doctorInfo?.specialization || 'General Practice' }}</div>
                  <div class="doctor-rating" *ngIf="getDoctorRating(consultation.doctor)">
                    <i class="material-icons">star</i>
                    <span>{{ getDoctorRating(consultation.doctor) }}</span>
                  </div>
                </div>
              </div>
              
              <div class="consultation-status">
                <span class="status-badge" [ngClass]="getConsultationStatus(consultation).toLowerCase().replace(' ', '-')">
                  <i class="material-icons">{{ getConsultationStatusIcon(consultation) }}</i>
                  {{ getConsultationStatus(consultation) }}
                </span>
                <div class="priority-indicator" *ngIf="hasHighPriority(consultation)">
                  <i class="material-icons">priority_high</i>
                </div>
              </div>
            </div>
            
            <!-- Quick Info Bar -->
            <div class="consultation-quick-info">
              <div class="info-item">
                <i class="material-icons">code</i>
                <span>{{ consultation.consultationCode }}</span>
              </div>
              <div class="info-item" *ngIf="consultation.endTime">
                <i class="material-icons">schedule</i>
                <span>{{ calculateDuration(consultation.startTime, consultation.endTime) }}</span>
              </div>
              <div class="info-item" *ngIf="consultation.healthScan">
                <i class="material-icons">favorite</i>
                <span>Health Scan Available</span>
              </div>
              <div class="info-item" *ngIf="consultation.followUpDate">
                <i class="material-icons">event</i>
                <span>Follow-up: {{ formatDate(consultation.followUpDate) }}</span>
              </div>
            </div>

            <!-- Medical Summary -->
            <div class="consultation-summary" *ngIf="consultation.diagnosis || consultation.treatment || consultation.notes">
              <div class="summary-header">
                <h4>Medical Summary</h4>
                <div class="summary-indicators">
                  <span class="indicator" *ngIf="consultation.diagnosis" title="Has Diagnosis">
                    <i class="material-icons">diagnosis</i>
                  </span>
                  <span class="indicator" *ngIf="consultation.treatment" title="Has Treatment Plan">
                    <i class="material-icons">medical_services</i>
                  </span>
                  <span class="indicator" *ngIf="consultation.notes" title="Has Notes">
                    <i class="material-icons">notes</i>
                  </span>
                </div>
              </div>
              
              <div class="summary-content">
                <div class="summary-item" *ngIf="consultation.diagnosis">
                  <div class="item-header">
                    <i class="material-icons">diagnosis</i>
                    <span class="item-label">Diagnosis</span>
                  </div>
                  <p class="item-content">{{ consultation.diagnosis }}</p>
                </div>
                
                <div class="summary-item" *ngIf="consultation.treatment">
                  <div class="item-header">
                    <i class="material-icons">medical_services</i>
                    <span class="item-label">Treatment Plan</span>
                  </div>
                  <p class="item-content">{{ consultation.treatment }}</p>
                </div>
                
                <div class="summary-item" *ngIf="consultation.notes">
                  <div class="item-header">
                    <i class="material-icons">notes</i>
                    <span class="item-label">Doctor's Notes</span>
                  </div>
                  <p class="item-content">{{ consultation.notes }}</p>
                </div>
              </div>
            </div>

            <!-- Health Scan Preview -->
            <div class="health-scan-preview" *ngIf="consultation.healthScan">
              <div class="scan-header">
                <h4>Health Scan Results</h4>
                <span class="scan-date">{{ formatDate(consultation.healthScan.createdAt || consultation.startTime) }}</span>
              </div>
              <div class="scan-metrics">
                <div class="metric" *ngIf="consultation.healthScan.heartRate">
                  <span class="metric-value">{{ consultation.healthScan.heartRate }}</span>
                  <span class="metric-unit">bpm</span>
                  <span class="metric-label">Heart Rate</span>
                </div>
                <div class="metric" *ngIf="consultation.healthScan.bloodPressure">
                  <span class="metric-value">{{ consultation.healthScan.bloodPressure }}</span>
                  <span class="metric-unit">mmHg</span>
                  <span class="metric-label">Blood Pressure</span>
                </div>
                <div class="metric" *ngIf="consultation.healthScan.spO2">
                  <span class="metric-value">{{ consultation.healthScan.spO2 }}</span>
                  <span class="metric-unit">%</span>
                  <span class="metric-label">SpO2</span>
                </div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="consultation-actions">
              <button class="action-btn primary" (click)="viewConsultation(consultation); $event.stopPropagation()">
                <i class="material-icons">visibility</i>
                <span>View Details</span>
              </button>
              <button class="action-btn secondary" *ngIf="consultation.healthScan" (click)="viewHealthScan(consultation.healthScan); $event.stopPropagation()">
                <i class="material-icons">favorite</i>
                <span>Health Scan</span>
              </button>
              <button class="action-btn tertiary" (click)="copyConsultationCode(consultation.consultationCode); $event.stopPropagation()">
                <i class="material-icons">content_copy</i>
                <span>Copy Code</span>
              </button>
              <button class="action-btn danger" *ngIf="!consultation.endTime" (click)="joinConsultation(consultation); $event.stopPropagation()">
                <i class="material-icons">video_call</i>
                <span>Join Now</span>
              </button>
            </div>
          </div>
          
          <!-- Empty State -->
          <div *ngIf="!filteredConsultations?.length" class="empty-state">
            <div class="empty-icon">
              <i class="material-icons">event_available</i>
            </div>
            <h3>No Consultations Found</h3>
            <p *ngIf="consultations.length === 0">You haven't had any consultations yet. Schedule your first appointment to get started.</p>
            <p *ngIf="consultations.length > 0">No consultations match your current filters. Try adjusting your search criteria.</p>
            <div class="empty-actions">
              <button class="cta-btn primary" (click)="navigateToSchedule()">
                <i class="material-icons">add</i>
                Schedule Consultation
              </button>
              <button class="cta-btn secondary" *ngIf="consultations.length > 0" (click)="clearFilters()">
                <i class="material-icons">clear</i>
                Clear Filters
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Medical History Tab -->
      <div *ngIf="selectedTab === 'medical-history'" class="medical-history-tab">
        <div class="medical-history-list">
          <div *ngFor="let record of medicalRecords.medicalHistory" class="medical-record-card" (click)="viewMedicalRecord(record)">
            <div class="record-header">
              <div class="record-type">
                <div class="type-icon" [class]="'type-' + getRecordTypeColor(record.recordType)">
                  <i class="material-icons">{{ getRecordTypeIcon(record.recordType) }}</i>
                </div>
                <div class="type-info">
                  <div class="type-name">{{ formatRecordType(record.recordType) }}</div>
                  <div class="record-title">{{ record.title }}</div>
                </div>
              </div>
              <div class="record-meta">
                <div class="privacy-badge" [class]="'privacy-' + (isRecordPublic(record) ? 'success' : 'warning')">
                  <i class="material-icons">{{ isRecordPublic(record) ? 'public' : 'visibility_off' }}</i>
                  <span>{{ isRecordPublic(record) ? 'Public' : 'Private' }}</span>
                </div>
                <div class="record-date">{{ formatDate(record.createdAt) }}</div>
              </div>
            </div>
            
            <div class="record-content">
              <p class="record-preview">{{ getContentPreview(record.content, record.recordType) }}</p>
            </div>
            
            <div class="record-footer">
              <div class="creator-info">
                <span class="creator-label">Created by:</span>
                <span class="creator-name">
                  {{ record.creator.doctorInfo ? 'Dr. ' + record.creator.doctorInfo.firstName + ' ' + record.creator.doctorInfo.lastName : record.creator.email }}
                </span>
              </div>
              <div class="record-actions">
                <i class="material-icons">visibility</i>
              </div>
            </div>
          </div>
          
          <div *ngIf="!medicalRecords.medicalHistory?.length" class="empty-state">
            <i class="material-icons">medical_information</i>
            <p>No medical history records available</p>
          </div>
        </div>
      </div>

      <!-- Health Trends Tab -->
      <div *ngIf="selectedTab === 'trends'" class="trends-tab">
        <!-- Trends Overview Cards -->
        <div class="trends-grid">
          <div class="trend-card" *ngFor="let metric of availableMetrics" (click)="selectMetric(metric.key)" [class.selected]="selectedMetric === metric.key">
            <div class="trend-header">
              <h4>{{ metric.label }}</h4>
              <div class="trend-indicator" [class]="getTrendColor(getCurrentTrends()[metric.key].trend)">
                <i class="material-icons">{{ getTrendIcon(getCurrentTrends()[metric.key].trend) }}</i>
                <span>{{ getCurrentTrends()[metric.key].trend }}</span>
              </div>
            </div>
            <div class="trend-change">
              <span class="change-value" [class]="getTrendColor(getCurrentTrends()[metric.key].trend)">
                {{ getCurrentTrends()[metric.key].change > 0 ? '+' : '' }}{{ getCurrentTrends()[metric.key].change }}%
              </span>
            </div>
            <div class="metric-unit">{{ metric.unit }}</div>
          </div>
        </div>

        <!-- Interactive Chart Section -->
        <div class="chart-section">
          <div class="chart-header">
            <h3>{{ getSelectedMetricInfo().label }} Trend</h3>
            <div class="chart-controls">
              <div class="metric-selector">
                <label>Select Metric:</label>
                <select [(ngModel)]="selectedMetric" (change)="selectMetric(selectedMetric)">
                  <option *ngFor="let metric of availableMetrics" [value]="metric.key">
                    {{ metric.label }}
                  </option>
                </select>
              </div>
            </div>
          </div>
          
          <div class="chart-container">
            <div *ngIf="getSelectedMetricData().length > 0" class="chart-wrapper">
              <!-- Simple Line Chart using CSS and HTML -->
              <div class="simple-chart">
                <div class="chart-title">{{ getSelectedMetricInfo().label }} Over Time</div>
                <div class="chart-area">
                  <svg class="trend-chart" viewBox="0 0 800 300">
                    <!-- Chart will be rendered here -->
                    <g class="chart-grid">
                      <!-- Grid lines -->
                      <line x1="50" y1="50" x2="750" y2="50" stroke="#e0e0e0" stroke-width="1"/>
                      <line x1="50" y1="100" x2="750" y2="100" stroke="#e0e0e0" stroke-width="1"/>
                      <line x1="50" y1="150" x2="750" y2="150" stroke="#e0e0e0" stroke-width="1"/>
                      <line x1="50" y1="200" x2="750" y2="200" stroke="#e0e0e0" stroke-width="1"/>
                      <line x1="50" y1="250" x2="750" y2="250" stroke="#e0e0e0" stroke-width="1"/>
                    </g>
                    
                    <!-- Data points and line -->
                    <g class="data-line">
                      <polyline 
                        [attr.points]="getChartPoints()" 
                        fill="none" 
                        stroke="#3b82f6" 
                        stroke-width="3"
                        stroke-linecap="round"
                        stroke-linejoin="round"/>
                      
                      <!-- Data points -->
                      <circle 
                        *ngFor="let point of getChartPointsArray(); let i = index"
                        [attr.cx]="point.x" 
                        [attr.cy]="point.y" 
                        r="4" 
                        fill="#3b82f6"
                        class="data-point"
                        [attr.data-value]="getSelectedMetricData()[i].value"
                        [attr.data-date]="getSelectedMetricData()[i].date"/>
                    </g>
                    
                    <!-- Y-axis labels -->
                    <g class="y-axis-labels">
                      <text x="40" y="55" text-anchor="end" class="axis-label">{{ getMaxValue() }}</text>
                      <text x="40" y="105" text-anchor="end" class="axis-label">{{ getMaxValue() * 0.75 }}</text>
                      <text x="40" y="155" text-anchor="end" class="axis-label">{{ getMaxValue() * 0.5 }}</text>
                      <text x="40" y="205" text-anchor="end" class="axis-label">{{ getMaxValue() * 0.25 }}</text>
                      <text x="40" y="255" text-anchor="end" class="axis-label">{{ getMinValue() }}</text>
                    </g>
                    
                    <!-- X-axis labels -->
                    <g class="x-axis-labels">
                      <text *ngFor="let data of getSelectedMetricData(); let i = index"
                            [attr.x]="50 + (i * (700 / (getSelectedMetricData().length - 1)))" 
                            y="280" 
                            text-anchor="middle" 
                            class="axis-label">
                        {{ formatDateShort(data.date) }}
                      </text>
                    </g>
                  </svg>
                </div>
                
                <!-- Chart Legend -->
                <div class="chart-legend">
                  <div class="legend-item">
                    <div class="legend-color" style="background-color: #3b82f6;"></div>
                    <span>{{ getSelectedMetricInfo().label }} ({{ getSelectedMetricInfo().unit }})</span>
                  </div>
                </div>
              </div>
            </div>
            
            <div *ngIf="getSelectedMetricData().length === 0" class="no-data-chart">
              <i class="material-icons">show_chart</i>
              <p>No data available for {{ getSelectedMetricInfo().label }}</p>
              <small>Data will appear here once you have multiple health scans</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Health Scan Modal -->
<div *ngIf="selectedHealthScan" class="modal-overlay" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Health Scan Details</h3>
      <button class="close-btn" (click)="closeModal()">
        <i class="material-icons">close</i>
      </button>
    </div>
    
    <div class="modal-body">
      <div class="scan-details">
        <div class="detail-section">
          <h4>Basic Metrics</h4>
          <div class="metrics-grid">
            <div class="metric-item" *ngIf="selectedHealthScan.heartRate">
              <label>Heart Rate</label>
              <span>{{ selectedHealthScan.heartRate }} bpm</span>
            </div>
            <div class="metric-item" *ngIf="selectedHealthScan.bloodPressure">
              <label>Blood Pressure</label>
              <span>{{ selectedHealthScan.bloodPressure }}</span>
            </div>
            <div class="metric-item" *ngIf="selectedHealthScan.spO2">
              <label>SpO2</label>
              <span>{{ selectedHealthScan.spO2 }}%</span>
            </div>
            <div class="metric-item" *ngIf="selectedHealthScan.respiratoryRate">
              <label>Respiratory Rate</label>
              <span>{{ selectedHealthScan.respiratoryRate }} breaths/min</span>
            </div>
            <div class="metric-item" *ngIf="selectedHealthScan.stressLevel">
              <label>Stress Level</label>
              <span>{{ selectedHealthScan.stressLevel }}</span>
            </div>
            <div class="metric-item" *ngIf="selectedHealthScan.generalWellness">
              <label>General Wellness</label>
              <span>{{ selectedHealthScan.generalWellness }}</span>
            </div>
          </div>
        </div>

        <div class="detail-section" *ngIf="selectedHealthScan.generalRisk || selectedHealthScan.coronaryHeartDisease || selectedHealthScan.strokeRisk">
          <h4>Health Risk Assessment</h4>
          <div class="risk-grid">
            <div class="risk-item" *ngIf="selectedHealthScan.generalRisk">
              <label>General Risk</label>
              <span class="risk-level" [class]="getRiskLevel(selectedHealthScan.generalRisk).color">
                {{ getRiskLevel(selectedHealthScan.generalRisk).level }}
              </span>
              <span class="risk-value">{{ selectedHealthScan.generalRisk }}%</span>
            </div>
            <div class="risk-item" *ngIf="selectedHealthScan.coronaryHeartDisease">
              <label>Coronary Heart Disease</label>
              <span class="risk-level" [class]="getRiskLevel(selectedHealthScan.coronaryHeartDisease).color">
                {{ getRiskLevel(selectedHealthScan.coronaryHeartDisease).level }}
              </span>
              <span class="risk-value">{{ selectedHealthScan.coronaryHeartDisease }}%</span>
            </div>
            <div class="risk-item" *ngIf="selectedHealthScan.congestiveHeartFailure">
              <label>Congestive Heart Failure</label>
              <span class="risk-level" [class]="getRiskLevel(selectedHealthScan.congestiveHeartFailure).color">
                {{ getRiskLevel(selectedHealthScan.congestiveHeartFailure).level }}
              </span>
              <span class="risk-value">{{ selectedHealthScan.congestiveHeartFailure }}%</span>
            </div>
            <div class="risk-item" *ngIf="selectedHealthScan.intermittentClaudication">
              <label>Intermittent Claudication</label>
              <span class="risk-level" [class]="getRiskLevel(selectedHealthScan.intermittentClaudication).color">
                {{ getRiskLevel(selectedHealthScan.intermittentClaudication).level }}
              </span>
              <span class="risk-value">{{ selectedHealthScan.intermittentClaudication }}%</span>
            </div>
            <div class="risk-item" *ngIf="selectedHealthScan.strokeRisk">
              <label>Stroke Risk</label>
              <span class="risk-level" [class]="getRiskLevel(selectedHealthScan.strokeRisk).color">
                {{ getRiskLevel(selectedHealthScan.strokeRisk).level }}
              </span>
              <span class="risk-value">{{ selectedHealthScan.strokeRisk }}%</span>
            </div>
            <div class="risk-item" *ngIf="selectedHealthScan.covidRisk">
              <label>COVID-19 Risk</label>
              <span class="risk-level" [class]="getRiskLevel(selectedHealthScan.covidRisk).color">
                {{ getRiskLevel(selectedHealthScan.covidRisk).level }}
              </span>
              <span class="risk-value">{{ selectedHealthScan.covidRisk }}%</span>
            </div>
          </div>
        </div>

        <div class="detail-section" *ngIf="selectedHealthScan.hrvSdnn || selectedHealthScan.hrvRmsdd || selectedHealthScan.stressScore">
          <h4>Heart Rate Variability & Stress</h4>
          <div class="metrics-grid">
            <div class="metric-item" *ngIf="selectedHealthScan.hrvSdnn">
              <label>HRV SDNN</label>
              <span>{{ selectedHealthScan.hrvSdnn }} ms</span>
            </div>
            <div class="metric-item" *ngIf="selectedHealthScan.hrvRmsdd">
              <label>HRV RMSSD</label>
              <span>{{ selectedHealthScan.hrvRmsdd }} ms</span>
            </div>
            <div class="metric-item" *ngIf="selectedHealthScan.stressScore">
              <label>Stress Score</label>
              <span>{{ selectedHealthScan.stressScore }}</span>
            </div>
          </div>
        </div>

        <div class="detail-section" *ngIf="selectedHealthScan.height || selectedHealthScan.weight || selectedHealthScan.waistCircumference">
          <h4>Physical Measurements</h4>
          <div class="metrics-grid">
            <div class="metric-item" *ngIf="selectedHealthScan.height">
              <label>Height</label>
              <span>{{ selectedHealthScan.height }} cm</span>
            </div>
            <div class="metric-item" *ngIf="selectedHealthScan.weight">
              <label>Weight</label>
              <span>{{ selectedHealthScan.weight }} kg</span>
            </div>
            <div class="metric-item" *ngIf="selectedHealthScan.waistCircumference">
              <label>Waist Circumference</label>
              <span>{{ selectedHealthScan.waistCircumference }} cm</span>
            </div>
            <div class="metric-item" *ngIf="selectedHealthScan.height && selectedHealthScan.weight">
              <label>BMI</label>
              <span>{{ getBMIValue(selectedHealthScan.weight, selectedHealthScan.height) }} ({{ getBMICategory(selectedHealthScan.weight, selectedHealthScan.height) }})</span>
            </div>
          </div>
        </div>

        <div class="detail-section" *ngIf="selectedHealthScan.totalCholesterol || selectedHealthScan.hdl">
          <h4>Cholesterol Levels</h4>
          <div class="metrics-grid">
            <div class="metric-item" *ngIf="selectedHealthScan.totalCholesterol">
              <label>Total Cholesterol</label>
              <span>{{ selectedHealthScan.totalCholesterol }} mg/dL</span>
            </div>
            <div class="metric-item" *ngIf="selectedHealthScan.hdl">
              <label>HDL Cholesterol</label>
              <span>{{ selectedHealthScan.hdl }} mg/dL</span>
            </div>
          </div>
        </div>

        <div class="detail-section" *ngIf="selectedHealthScan.smoker !== undefined || selectedHealthScan.hypertension !== undefined || selectedHealthScan.bpMedication !== undefined || selectedHealthScan.antiHypertensive !== undefined || selectedHealthScan.diabetic !== undefined || selectedHealthScan.historyBloodGlucose !== undefined || selectedHealthScan.historyFamilyDiabetes !== undefined || selectedHealthScan.heartDisease !== undefined || selectedHealthScan.depression !== undefined || selectedHealthScan.parentalHypertension !== undefined || selectedHealthScan.physicalActivity !== undefined || selectedHealthScan.healthyDiet !== undefined">
          <h4>Health Conditions & Lifestyle</h4>
          <div class="conditions-grid">
            <div class="condition-item" *ngIf="selectedHealthScan.smoker !== undefined">
              <label>Smoker</label>
              <span class="condition-value" [class]="selectedHealthScan.smoker ? 'yes' : 'no'">
                {{ selectedHealthScan.smoker ? 'Yes' : 'No' }}
              </span>
            </div>
            <div class="condition-item" *ngIf="selectedHealthScan.hypertension !== undefined">
              <label>Hypertension</label>
              <span class="condition-value" [class]="selectedHealthScan.hypertension ? 'yes' : 'no'">
                {{ selectedHealthScan.hypertension ? 'Yes' : 'No' }}
              </span>
            </div>
            <div class="condition-item" *ngIf="selectedHealthScan.bpMedication !== undefined">
              <label>Blood Pressure Medication</label>
              <span class="condition-value" [class]="selectedHealthScan.bpMedication ? 'yes' : 'no'">
                {{ selectedHealthScan.bpMedication ? 'Yes' : 'No' }}
              </span>
            </div>
            <div class="condition-item" *ngIf="selectedHealthScan.antiHypertensive !== undefined">
              <label>Anti-Hypertensive Medication</label>
              <span class="condition-value" [class]="selectedHealthScan.antiHypertensive ? 'yes' : 'no'">
                {{ selectedHealthScan.antiHypertensive ? 'Yes' : 'No' }}
              </span>
            </div>
            <div class="condition-item" *ngIf="selectedHealthScan.diabetic !== undefined">
              <label>Diabetes Status</label>
              <span class="condition-value" [class]="selectedHealthScan.diabetic > 0 ? 'yes' : 'no'">
                {{ getDiabetesStatus(selectedHealthScan.diabetic) }}
              </span>
            </div>
            <div class="condition-item" *ngIf="selectedHealthScan.historyBloodGlucose !== undefined">
              <label>History of High Blood Glucose</label>
              <span class="condition-value" [class]="selectedHealthScan.historyBloodGlucose ? 'yes' : 'no'">
                {{ selectedHealthScan.historyBloodGlucose ? 'Yes' : 'No' }}
              </span>
            </div>
            <div class="condition-item" *ngIf="selectedHealthScan.historyFamilyDiabetes !== undefined">
              <label>Family History of Diabetes</label>
              <span class="condition-value" [class]="selectedHealthScan.historyFamilyDiabetes > 0 ? 'yes' : 'no'">
                {{ getFamilyHistoryStatus(selectedHealthScan.historyFamilyDiabetes, 'diabetes') }}
              </span>
            </div>
            <div class="condition-item" *ngIf="selectedHealthScan.heartDisease !== undefined">
              <label>Heart Disease</label>
              <span class="condition-value" [class]="selectedHealthScan.heartDisease ? 'yes' : 'no'">
                {{ selectedHealthScan.heartDisease ? 'Yes' : 'No' }}
              </span>
            </div>
            <div class="condition-item" *ngIf="selectedHealthScan.depression !== undefined">
              <label>Depression</label>
              <span class="condition-value" [class]="selectedHealthScan.depression ? 'yes' : 'no'">
                {{ selectedHealthScan.depression ? 'Yes' : 'No' }}
              </span>
            </div>
            <div class="condition-item" *ngIf="selectedHealthScan.parentalHypertension !== undefined">
              <label>Parental History of Hypertension</label>
              <span class="condition-value" [class]="selectedHealthScan.parentalHypertension > 0 ? 'yes' : 'no'">
                {{ getFamilyHistoryStatus(selectedHealthScan.parentalHypertension, 'hypertension') }}
              </span>
            </div>
            <div class="condition-item" *ngIf="selectedHealthScan.physicalActivity !== undefined">
              <label>Physical Activity</label>
              <span class="condition-value" [class]="selectedHealthScan.physicalActivity ? 'yes' : 'no'">
                {{ selectedHealthScan.physicalActivity ? 'Yes' : 'No' }}
              </span>
            </div>
            <div class="condition-item" *ngIf="selectedHealthScan.healthyDiet !== undefined">
              <label>Healthy Diet</label>
              <span class="condition-value" [class]="selectedHealthScan.healthyDiet ? 'yes' : 'no'">
                {{ selectedHealthScan.healthyDiet ? 'Yes' : 'No' }}
              </span>
            </div>
          </div>
        </div>

        <div class="detail-section">
          <h4>Consultation Details</h4>
          <div class="consultation-info">
            <p><strong>Date:</strong> {{ formatDate(selectedHealthScan.consultation.startTime) }}</p>
            <p><strong>Time:</strong> {{ formatTime(selectedHealthScan.consultation.startTime) }}</p>
            <p><strong>Doctor:</strong> Dr. {{ selectedHealthScan.consultation.doctor?.doctorInfo?.firstName || 'Unknown' }} {{ selectedHealthScan.consultation.doctor?.doctorInfo?.lastName || 'Doctor' }}</p>
            <p><strong>Specialization:</strong> {{ selectedHealthScan.consultation.doctor?.doctorInfo?.specialization || 'General Practice' }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Consultation Modal -->
<div *ngIf="selectedConsultation" class="modal-overlay" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Consultation Details</h3>
      <button class="close-btn" (click)="closeModal()">
        <i class="material-icons">close</i>
      </button>
    </div>
    
    <div class="modal-body">
      <div class="consultation-details">
        <div class="detail-section">
          <h4>Appointment Information</h4>
          <div class="info-grid">
            <div class="info-item">
              <label>Date</label>
              <span>{{ formatDate(selectedConsultation.startTime) }}</span>
            </div>
            <div class="info-item">
              <label>Start Time</label>
              <span>{{ formatTime(selectedConsultation.startTime) }}</span>
            </div>
            <div class="info-item" *ngIf="selectedConsultation.endTime">
              <label>End Time</label>
              <span>{{ formatTime(selectedConsultation.endTime) }}</span>
            </div>
            <div class="info-item">
              <label>Duration</label>
              <span *ngIf="selectedConsultation.endTime">
                {{ calculateDuration(selectedConsultation.startTime, selectedConsultation.endTime) }}
              </span>
              <span *ngIf="!selectedConsultation.endTime">Ongoing</span>
            </div>
          </div>
        </div>

        <div class="detail-section">
          <h4>Doctor Information</h4>
          <div class="doctor-info">
            <p><strong>Name:</strong> Dr. {{ selectedConsultation.doctor?.doctorInfo?.firstName || 'Unknown' }} {{ selectedConsultation.doctor?.doctorInfo?.lastName || 'Doctor' }}</p>
            <p><strong>Specialization:</strong> {{ selectedConsultation.doctor?.doctorInfo?.specialization || 'General Practice' }}</p>
          </div>
        </div>

        <div class="detail-section" *ngIf="selectedConsultation.notes || selectedConsultation.diagnosis || selectedConsultation.treatment">
          <h4>Medical Information</h4>
          <div class="medical-info">
            <div class="info-item" *ngIf="selectedConsultation.notes">
              <label>Doctor's Notes</label>
              <div class="notes-content">
                <p>{{ selectedConsultation.notes }}</p>
              </div>
            </div>
            <div class="info-item" *ngIf="selectedConsultation.diagnosis">
              <label>Diagnosis</label>
              <div class="diagnosis-content">
                <p>{{ selectedConsultation.diagnosis }}</p>
              </div>
            </div>
            <div class="info-item" *ngIf="selectedConsultation.treatment">
              <label>Treatment Plan</label>
              <div class="treatment-content">
                <p>{{ selectedConsultation.treatment }}</p>
              </div>
            </div>
            <div class="info-item" *ngIf="selectedConsultation.followUpDate">
              <label>Follow-up Date</label>
              <div class="followup-content">
                <p><strong>Next Appointment:</strong> {{ formatDate(selectedConsultation.followUpDate) }}</p>
              </div>
            </div>
          </div>
        </div>

        <div class="detail-section" *ngIf="selectedConsultation.healthScan">
          <h4>Health Scan</h4>
          <div class="scan-summary">
            <p>This consultation included a comprehensive health scan.</p>
            <button class="view-scan-btn" (click)="viewHealthScan(selectedConsultation.healthScan)">
              View Scan Details
            </button>
          </div>
        </div>

        <div class="detail-section">
                      <h4>Consultation Access</h4>
          <div class="consultation-link">
            <p><strong>Consultation Code:</strong> {{ selectedConsultation.consultationCode }}</p>
                          <button class="copy-code-btn" (click)="copyToClipboard(selectedConsultation.consultationCode)">
                <i class="material-icons">content_copy</i>
                Copy Code
              </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Medical Record Modal -->
<div *ngIf="selectedMedicalRecord" class="modal-overlay" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ selectedMedicalRecord.title }}</h3>
      <button class="close-btn" (click)="closeModal()">
        <i class="material-icons">close</i>
      </button>
    </div>
    
    <div class="modal-body">
      <div class="medical-record-details">
        <div class="detail-section">
          <h4>Record Information</h4>
          <div class="info-grid">
            <div class="info-item">
              <label>Type</label>
              <span class="record-type-badge" [class]="'type-' + getRecordTypeColor(selectedMedicalRecord.recordType)">
                <i class="material-icons">{{ getRecordTypeIcon(selectedMedicalRecord.recordType) }}</i>
                {{ formatRecordType(selectedMedicalRecord.recordType) }}
              </span>
            </div>
            <div class="info-item">
              <label>Privacy</label>
              <span class="privacy-badge" [class]="'privacy-' + getPrivacyColor(selectedMedicalRecord.isPublic, selectedMedicalRecord.isSensitive)">
                <i class="material-icons">{{ getPrivacyIcon(selectedMedicalRecord.isPublic, selectedMedicalRecord.isSensitive) }}</i>
                {{ getPrivacyText(selectedMedicalRecord.isPublic, selectedMedicalRecord.isSensitive) }}
              </span>
              <div class="privacy-actions" *ngIf="selectedMedicalRecord.consultationId">
                <button class="mini-btn" [disabled]="updatingPrivacy || selectedMedicalRecord.isPublic === true" (click)="toggleRecordPrivacy(selectedMedicalRecord, true)">
                  <i class="material-icons">public</i>
                  Make Public
                </button>
                <button class="mini-btn" [disabled]="updatingPrivacy || selectedMedicalRecord.isPublic === false" (click)="toggleRecordPrivacy(selectedMedicalRecord, false)">
                  <i class="material-icons">visibility_off</i>
                  Make Private
                </button>
              </div>
            </div>
            <div class="info-item">
              <label>Created</label>
              <span>{{ formatDate(selectedMedicalRecord.createdAt) }}</span>
            </div>
            <div class="info-item">
              <label>Last Updated</label>
              <span>{{ formatDate(selectedMedicalRecord.updatedAt) }}</span>
            </div>
          </div>
        </div>

        <div class="detail-section">
          <h4>Content</h4>
          <div class="record-content-full" [innerHTML]="formatMedicalRecordContent(selectedMedicalRecord.content, selectedMedicalRecord.recordType)"></div>
        </div>

        <div class="detail-section">
          <h4>Creator Information</h4>
          <div class="creator-details">
            <p><strong>Created by:</strong> 
              {{ selectedMedicalRecord.creator.doctorInfo ? 'Dr. ' + selectedMedicalRecord.creator.doctorInfo.firstName + ' ' + selectedMedicalRecord.creator.doctorInfo.lastName : selectedMedicalRecord.creator.email }}
            </p>
            <p><strong>Role:</strong> {{ selectedMedicalRecord.creator.role }}</p>
          </div>
        </div>

        <div class="detail-section" *ngIf="selectedMedicalRecord.privacySettings?.length">
          <h4>Privacy Settings</h4>
          <div class="privacy-settings">
            <div *ngFor="let setting of selectedMedicalRecord.privacySettings" class="privacy-setting">
              <div class="setting-info">
                <span class="setting-type">{{ formatPrivacySettingType(setting.settingType) }}</span>
                <span class="setting-status" [class]="setting.isEnabled ? 'enabled' : 'disabled'">
                  {{ setting.isEnabled ? 'Enabled' : 'Disabled' }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
