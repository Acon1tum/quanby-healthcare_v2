<div class="header-spacer"></div>

<div class="medical-records-container">
  <!-- Header Section -->
  <div class="records-header">
    <div class="header-content">
      <div class="back-section">
        <button class="back-btn" (click)="onBack()">
          <i class="material-icons">arrow_back</i>
        </button>
        <div class="header-text">
          <h1>Medical Records</h1>
          <p>Your complete health history and medical information</p>
        </div>
      </div>
      
      <div class="header-actions">
        <button class="refresh-btn" (click)="loadMedicalRecords()" [disabled]="loading">
          <i class="material-icons">refresh</i>
          {{ loading ? 'Loading...' : 'Refresh' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-state">
    <div class="spinner"></div>
    <p>Loading your medical records...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="error-state">
    <i class="material-icons">error</i>
    <p>{{ error }}</p>
    <button class="retry-btn" (click)="loadMedicalRecords()">Try Again</button>
  </div>

  <!-- Medical Records Content -->
  <div *ngIf="medicalRecords && !loading" class="records-content">
    <!-- Summary Cards -->
    <div class="summary-cards">
      <div class="summary-card">
        <div class="card-icon">
          <i class="material-icons">event</i>
        </div>
        <div class="card-content">
          <div class="card-value">{{ medicalRecords.summary.totalConsultations }}</div>
          <div class="card-label">Total Consultations</div>
        </div>
      </div>
      
      <div class="summary-card">
        <div class="card-icon">
          <i class="material-icons">monitor_heart</i>
        </div>
        <div class="card-content">
          <div class="card-value">{{ medicalRecords.summary.totalHealthScans }}</div>
          <div class="card-label">Health Scans</div>
        </div>
      </div>
      
      <div class="summary-card">
        <div class="card-icon">
          <i class="material-icons">schedule</i>
        </div>
        <div class="card-content">
          <div class="card-value">
            {{ medicalRecords.summary.lastConsultation ? formatDate(medicalRecords.summary.lastConsultation) : 'N/A' }}
          </div>
          <div class="card-label">Last Consultation</div>
        </div>
      </div>
      
      <div class="summary-card">
        <div class="card-icon">
          <i class="material-icons">favorite</i>
        </div>
        <div class="card-content">
          <div class="card-value">
            {{ medicalRecords.summary.lastHealthScan ? formatDate(medicalRecords.summary.lastHealthScan) : 'N/A' }}
          </div>
          <div class="card-label">Last Health Scan</div>
        </div>
      </div>
      
      <div class="summary-card">
        <div class="card-icon">
          <i class="material-icons">medical_information</i>
        </div>
        <div class="card-content">
          <div class="card-value">{{ medicalRecords.summary.totalMedicalRecords }}</div>
          <div class="card-label">Medical Records</div>
        </div>
      </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="nav-tabs">
      <button 
        class="tab-btn" 
        [class.active]="selectedTab === 'overview'"
        (click)="selectTab('overview')"
      >
        <i class="material-icons">dashboard</i>
        Overview
      </button>
      <button 
        class="tab-btn" 
        [class.active]="selectedTab === 'health-scans'"
        (click)="selectTab('health-scans')"
      >
        <i class="material-icons">monitor_heart</i>
        Health Scans
      </button>
      <button 
        class="tab-btn" 
        [class.active]="selectedTab === 'consultations'"
        (click)="selectTab('consultations')"
      >
        <i class="material-icons">event</i>
        Consultations
      </button>
      <button 
        class="tab-btn" 
        [class.active]="selectedTab === 'medical-history'"
        (click)="selectTab('medical-history')"
      >
        <i class="material-icons">medical_information</i>
        Medical History
      </button>
      <button 
        class="tab-btn" 
        [class.active]="selectedTab === 'trends'"
        (click)="selectTab('trends')"
      >
        <i class="material-icons">trending_up</i>
        Health Trends
      </button>
    </div>

    <!-- Tab Content -->
    <div class="tab-content">
      <!-- Overview Tab -->
      <div *ngIf="selectedTab === 'overview'" class="overview-tab">
        <div class="overview-grid">
          <!-- Patient Information -->
          <div class="overview-card">
            <h3>Personal Information</h3>
            <div class="info-grid">
              <div class="info-item">
                <label>Name</label>
                <p>{{ medicalRecords.patientInfo.fullName }}</p>
              </div>
              <div class="info-item">
                <label>Gender</label>
                <p>{{ medicalRecords.patientInfo.gender }}</p>
              </div>
              <div class="info-item">
                <label>Date of Birth</label>
                <p>{{ formatDate(medicalRecords.patientInfo.dateOfBirth) }}</p>
              </div>
              <div class="info-item">
                <label>Blood Type</label>
                <p>{{ medicalRecords.patientInfo.bloodType }}</p>
              </div>
              <div class="info-item">
                <label>Height</label>
                <p>{{ medicalRecords.patientInfo.height }} cm</p>
              </div>
              <div class="info-item">
                <label>Weight</label>
                <p>{{ medicalRecords.patientInfo.weight }} kg</p>
              </div>
              <div class="info-item">
                <label>BMI</label>
                <p>{{ getBMIValue(medicalRecords.patientInfo.weight, medicalRecords.patientInfo.height) }} ({{ getBMICategory(medicalRecords.patientInfo.weight, medicalRecords.patientInfo.height) }})</p>
              </div>
            </div>
          </div>

          <!-- Medical History -->
          <div class="overview-card">
            <h3>Medical History</h3>
            <div class="info-content">
              <div class="info-item">
                <label>Medical History</label>
                <p>{{ medicalRecords.patientInfo.medicalHistory || 'No significant medical history recorded' }}</p>
              </div>
              <div class="info-item">
                <label>Allergies</label>
                <div class="tags">
                  <span *ngFor="let allergy of parseStringArray(medicalRecords.patientInfo.allergies)" class="tag">{{ allergy }}</span>
                  <span *ngIf="!parseStringArray(medicalRecords.patientInfo.allergies)?.length" class="no-data">No allergies recorded</span>
                </div>
              </div>
              <div class="info-item">
                <label>Current Medications</label>
                <div class="tags">
                  <span *ngFor="let medication of parseStringArray(medicalRecords.patientInfo.medications)" class="tag">{{ medication }}</span>
                  <span *ngIf="!parseStringArray(medicalRecords.patientInfo.medications)?.length" class="no-data">No medications recorded</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Emergency Contact -->
          <div class="overview-card" *ngIf="medicalRecords.patientInfo.emergencyContact">
            <h3>Emergency Contact</h3>
            <div class="info-grid">
              <div class="info-item">
                <label>Name</label>
                <p>{{ medicalRecords.patientInfo.emergencyContact.contactName }}</p>
              </div>
              <div class="info-item">
                <label>Relationship</label>
                <p>{{ medicalRecords.patientInfo.emergencyContact.relationship }}</p>
              </div>
              <div class="info-item">
                <label>Phone</label>
                <p>{{ medicalRecords.patientInfo.emergencyContact.contactNumber }}</p>
              </div>
              <div class="info-item" *ngIf="medicalRecords.patientInfo.emergencyContact.contactAddress">
                <label>Address</label>
                <p>{{ medicalRecords.patientInfo.emergencyContact.contactAddress }}</p>
              </div>
            </div>
          </div>

          <!-- Insurance Information -->
          <div class="overview-card" *ngIf="medicalRecords.patientInfo.insuranceInfo">
            <h3>Insurance Information</h3>
            <div class="info-grid">
              <div class="info-item">
                <label>Provider</label>
                <p>{{ medicalRecords.patientInfo.insuranceInfo.providerName }}</p>
              </div>
              <div class="info-item">
                <label>Policy Number</label>
                <p>{{ medicalRecords.patientInfo.insuranceInfo.policyNumber }}</p>
              </div>
              <div class="info-item">
                <label>Contact</label>
                <p>{{ medicalRecords.patientInfo.insuranceInfo.insuranceContact }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Health Scans Tab -->
      <div *ngIf="selectedTab === 'health-scans'" class="health-scans-tab">
        <div class="scans-list">
          <div *ngFor="let scan of medicalRecords.healthScans" class="scan-card" (click)="viewHealthScan(scan)">
            <div class="scan-header">
              <div class="scan-date">
                <div class="date">{{ formatDate(scan.consultation.startTime) }}</div>
                <div class="time">{{ formatTime(scan.consultation.startTime) }}</div>
              </div>
              <div class="scan-doctor">
                <div class="doctor-name">Dr. {{ scan.consultation.doctor.doctorInfo.firstName }} {{ scan.consultation.doctor.doctorInfo.lastName }}</div>
                <div class="specialty">{{ scan.consultation.doctor.doctorInfo.specialization }}</div>
              </div>
              <div class="scan-actions">
                <i class="material-icons">visibility</i>
              </div>
            </div>
            
            <div class="scan-metrics">
              <div class="metric" *ngIf="scan.heartRate">
                <i class="material-icons">favorite</i>
                <span>{{ scan.heartRate }} bpm</span>
              </div>
              <div class="metric" *ngIf="scan.bloodPressure">
                <i class="material-icons">monitor_heart</i>
                <span>{{ scan.bloodPressure }}</span>
              </div>
              <div class="metric" *ngIf="scan.spO2">
                <i class="material-icons">air</i>
                <span>{{ scan.spO2 }}%</span>
              </div>
              <div class="metric" *ngIf="scan.generalWellness">
                <i class="material-icons">star</i>
                <span>{{ scan.generalWellness }}</span>
              </div>
            </div>
          </div>
          
          <div *ngIf="!medicalRecords.healthScans?.length" class="empty-state">
            <i class="material-icons">monitor_heart</i>
            <p>No health scans available</p>
          </div>
        </div>
      </div>

      <!-- Consultations Tab -->
      <div *ngIf="selectedTab === 'consultations'" class="consultations-tab">
        <div class="consultations-list">
          <div *ngFor="let consultation of medicalRecords.consultations" class="consultation-card" (click)="viewConsultation(consultation)">
            <div class="consultation-header">
              <div class="consultation-date">
                <div class="date">{{ formatDate(consultation.startTime) }}</div>
                <div class="time">{{ formatTime(consultation.startTime) }}</div>
              </div>
              <div class="consultation-doctor">
                <div class="doctor-name">Dr. {{ consultation.doctor.doctorInfo.firstName }} {{ consultation.doctor.doctorInfo.lastName }}</div>
                <div class="specialty">{{ consultation.doctor.doctorInfo.specialization }}</div>
              </div>
              <div class="consultation-status">
                <span class="status-badge" [class.has-scan]="consultation.healthScan">
                  {{ consultation.healthScan ? 'With Scan' : 'No Scan' }}
                </span>
              </div>
            </div>
            
            <div class="consultation-duration" *ngIf="consultation.endTime">
              <i class="material-icons">schedule</i>
              <span>{{ formatTime(consultation.startTime) }} - {{ formatTime(consultation.endTime) }}</span>
            </div>
          </div>
          
          <div *ngIf="!medicalRecords.consultations?.length" class="empty-state">
            <i class="material-icons">event</i>
            <p>No consultations available</p>
          </div>
        </div>
      </div>

      <!-- Medical History Tab -->
      <div *ngIf="selectedTab === 'medical-history'" class="medical-history-tab">
        <div class="medical-history-list">
          <div *ngFor="let record of medicalRecords.medicalHistory" class="medical-record-card" (click)="viewMedicalRecord(record)">
            <div class="record-header">
              <div class="record-type">
                <div class="type-icon" [class]="'type-' + getRecordTypeColor(record.recordType)">
                  <i class="material-icons">{{ getRecordTypeIcon(record.recordType) }}</i>
                </div>
                <div class="type-info">
                  <div class="type-name">{{ formatRecordType(record.recordType) }}</div>
                  <div class="record-title">{{ record.title }}</div>
                </div>
              </div>
              <div class="record-meta">
                <div class="privacy-badge" [class]="'privacy-' + getPrivacyColor(record.isPublic, record.isSensitive)">
                  <i class="material-icons">{{ getPrivacyIcon(record.isPublic, record.isSensitive) }}</i>
                  <span>{{ getPrivacyText(record.isPublic, record.isSensitive) }}</span>
                </div>
                <div class="record-date">{{ formatDate(record.createdAt) }}</div>
              </div>
            </div>
            
            <div class="record-content">
              <p class="record-preview">{{ getContentPreview(record.content, record.recordType) }}</p>
            </div>
            
            <div class="record-footer">
              <div class="creator-info">
                <span class="creator-label">Created by:</span>
                <span class="creator-name">
                  {{ record.creator.doctorInfo ? 'Dr. ' + record.creator.doctorInfo.firstName + ' ' + record.creator.doctorInfo.lastName : record.creator.email }}
                </span>
              </div>
              <div class="record-actions">
                <i class="material-icons">visibility</i>
              </div>
            </div>
          </div>
          
          <div *ngIf="!medicalRecords.medicalHistory?.length" class="empty-state">
            <i class="material-icons">medical_information</i>
            <p>No medical history records available</p>
          </div>
        </div>
      </div>

      <!-- Health Trends Tab -->
      <div *ngIf="selectedTab === 'trends'" class="trends-tab">
        <div class="trends-grid">
          <div class="trend-card" *ngFor="let metric of ['heartRate', 'bloodPressure', 'spO2', 'weight', 'stressLevel', 'generalWellness']">
            <div class="trend-header">
              <h4>{{ formatMetricName(metric) }}</h4>
              <div class="trend-indicator" [class]="getTrendColor(medicalRecords.healthTrends[metric].trend)">
                <i class="material-icons">{{ getTrendIcon(medicalRecords.healthTrends[metric].trend) }}</i>
                <span>{{ medicalRecords.healthTrends[metric].trend }}</span>
              </div>
            </div>
            <div class="trend-change">
              <span class="change-value" [class]="getTrendColor(medicalRecords.healthTrends[metric].trend)">
                {{ medicalRecords.healthTrends[metric].change > 0 ? '+' : '' }}{{ medicalRecords.healthTrends[metric].change }}%
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Health Scan Modal -->
<div *ngIf="selectedHealthScan" class="modal-overlay" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Health Scan Details</h3>
      <button class="close-btn" (click)="closeModal()">
        <i class="material-icons">close</i>
      </button>
    </div>
    
    <div class="modal-body">
      <div class="scan-details">
        <div class="detail-section">
          <h4>Basic Metrics</h4>
          <div class="metrics-grid">
            <div class="metric-item" *ngIf="selectedHealthScan.heartRate">
              <label>Heart Rate</label>
              <span>{{ selectedHealthScan.heartRate }} bpm</span>
            </div>
            <div class="metric-item" *ngIf="selectedHealthScan.bloodPressure">
              <label>Blood Pressure</label>
              <span>{{ selectedHealthScan.bloodPressure }}</span>
            </div>
            <div class="metric-item" *ngIf="selectedHealthScan.spO2">
              <label>SpO2</label>
              <span>{{ selectedHealthScan.spO2 }}%</span>
            </div>
            <div class="metric-item" *ngIf="selectedHealthScan.respiratoryRate">
              <label>Respiratory Rate</label>
              <span>{{ selectedHealthScan.respiratoryRate }} breaths/min</span>
            </div>
            <div class="metric-item" *ngIf="selectedHealthScan.stressLevel">
              <label>Stress Level</label>
              <span>{{ selectedHealthScan.stressLevel }}</span>
            </div>
            <div class="metric-item" *ngIf="selectedHealthScan.generalWellness">
              <label>General Wellness</label>
              <span>{{ selectedHealthScan.generalWellness }}</span>
            </div>
          </div>
        </div>

        <div class="detail-section" *ngIf="selectedHealthScan.generalRisk || selectedHealthScan.coronaryHeartDisease || selectedHealthScan.strokeRisk">
          <h4>Health Risk Assessment</h4>
          <div class="risk-grid">
            <div class="risk-item" *ngIf="selectedHealthScan.generalRisk">
              <label>General Risk</label>
              <span class="risk-level" [class]="getRiskLevel(selectedHealthScan.generalRisk).color">
                {{ getRiskLevel(selectedHealthScan.generalRisk).level }}
              </span>
              <span class="risk-value">{{ selectedHealthScan.generalRisk }}%</span>
            </div>
            <div class="risk-item" *ngIf="selectedHealthScan.coronaryHeartDisease">
              <label>Coronary Heart Disease</label>
              <span class="risk-level" [class]="getRiskLevel(selectedHealthScan.coronaryHeartDisease).color">
                {{ getRiskLevel(selectedHealthScan.coronaryHeartDisease).level }}
              </span>
              <span class="risk-value">{{ selectedHealthScan.coronaryHeartDisease }}%</span>
            </div>
            <div class="risk-item" *ngIf="selectedHealthScan.congestiveHeartFailure">
              <label>Congestive Heart Failure</label>
              <span class="risk-level" [class]="getRiskLevel(selectedHealthScan.congestiveHeartFailure).color">
                {{ getRiskLevel(selectedHealthScan.congestiveHeartFailure).level }}
              </span>
              <span class="risk-value">{{ selectedHealthScan.congestiveHeartFailure }}%</span>
            </div>
            <div class="risk-item" *ngIf="selectedHealthScan.intermittentClaudication">
              <label>Intermittent Claudication</label>
              <span class="risk-level" [class]="getRiskLevel(selectedHealthScan.intermittentClaudication).color">
                {{ getRiskLevel(selectedHealthScan.intermittentClaudication).level }}
              </span>
              <span class="risk-value">{{ selectedHealthScan.intermittentClaudication }}%</span>
            </div>
            <div class="risk-item" *ngIf="selectedHealthScan.strokeRisk">
              <label>Stroke Risk</label>
              <span class="risk-level" [class]="getRiskLevel(selectedHealthScan.strokeRisk).color">
                {{ getRiskLevel(selectedHealthScan.strokeRisk).level }}
              </span>
              <span class="risk-value">{{ selectedHealthScan.strokeRisk }}%</span>
            </div>
            <div class="risk-item" *ngIf="selectedHealthScan.covidRisk">
              <label>COVID-19 Risk</label>
              <span class="risk-level" [class]="getRiskLevel(selectedHealthScan.covidRisk).color">
                {{ getRiskLevel(selectedHealthScan.covidRisk).level }}
              </span>
              <span class="risk-value">{{ selectedHealthScan.covidRisk }}%</span>
            </div>
          </div>
        </div>

        <div class="detail-section" *ngIf="selectedHealthScan.hrvSdnn || selectedHealthScan.hrvRmsdd || selectedHealthScan.stressScore">
          <h4>Heart Rate Variability & Stress</h4>
          <div class="metrics-grid">
            <div class="metric-item" *ngIf="selectedHealthScan.hrvSdnn">
              <label>HRV SDNN</label>
              <span>{{ selectedHealthScan.hrvSdnn }} ms</span>
            </div>
            <div class="metric-item" *ngIf="selectedHealthScan.hrvRmsdd">
              <label>HRV RMSSD</label>
              <span>{{ selectedHealthScan.hrvRmsdd }} ms</span>
            </div>
            <div class="metric-item" *ngIf="selectedHealthScan.stressScore">
              <label>Stress Score</label>
              <span>{{ selectedHealthScan.stressScore }}</span>
            </div>
          </div>
        </div>

        <div class="detail-section" *ngIf="selectedHealthScan.height || selectedHealthScan.weight || selectedHealthScan.waistCircumference">
          <h4>Physical Measurements</h4>
          <div class="metrics-grid">
            <div class="metric-item" *ngIf="selectedHealthScan.height">
              <label>Height</label>
              <span>{{ selectedHealthScan.height }} cm</span>
            </div>
            <div class="metric-item" *ngIf="selectedHealthScan.weight">
              <label>Weight</label>
              <span>{{ selectedHealthScan.weight }} kg</span>
            </div>
            <div class="metric-item" *ngIf="selectedHealthScan.waistCircumference">
              <label>Waist Circumference</label>
              <span>{{ selectedHealthScan.waistCircumference }} cm</span>
            </div>
            <div class="metric-item" *ngIf="selectedHealthScan.height && selectedHealthScan.weight">
              <label>BMI</label>
              <span>{{ getBMIValue(selectedHealthScan.weight, selectedHealthScan.height) }} ({{ getBMICategory(selectedHealthScan.weight, selectedHealthScan.height) }})</span>
            </div>
          </div>
        </div>

        <div class="detail-section" *ngIf="selectedHealthScan.totalCholesterol || selectedHealthScan.hdl">
          <h4>Cholesterol Levels</h4>
          <div class="metrics-grid">
            <div class="metric-item" *ngIf="selectedHealthScan.totalCholesterol">
              <label>Total Cholesterol</label>
              <span>{{ selectedHealthScan.totalCholesterol }} mg/dL</span>
            </div>
            <div class="metric-item" *ngIf="selectedHealthScan.hdl">
              <label>HDL Cholesterol</label>
              <span>{{ selectedHealthScan.hdl }} mg/dL</span>
            </div>
          </div>
        </div>

        <div class="detail-section" *ngIf="selectedHealthScan.smoker !== undefined || selectedHealthScan.hypertension !== undefined || selectedHealthScan.diabetic !== undefined || selectedHealthScan.heartDisease !== undefined || selectedHealthScan.depression !== undefined">
          <h4>Health Conditions & Lifestyle</h4>
          <div class="conditions-grid">
            <div class="condition-item" *ngIf="selectedHealthScan.smoker !== undefined">
              <label>Smoker</label>
              <span class="condition-value" [class]="selectedHealthScan.smoker ? 'yes' : 'no'">
                {{ selectedHealthScan.smoker ? 'Yes' : 'No' }}
              </span>
            </div>
            <div class="condition-item" *ngIf="selectedHealthScan.hypertension !== undefined">
              <label>Hypertension</label>
              <span class="condition-value" [class]="selectedHealthScan.hypertension ? 'yes' : 'no'">
                {{ selectedHealthScan.hypertension ? 'Yes' : 'No' }}
              </span>
            </div>
            <div class="condition-item" *ngIf="selectedHealthScan.diabetic !== undefined">
              <label>Diabetes Status</label>
              <span class="condition-value">
                {{ selectedHealthScan.diabetic === 0 ? 'No Diabetes' : selectedHealthScan.diabetic === 1 ? 'Prediabetes' : 'Diabetic' }}
              </span>
            </div>
            <div class="condition-item" *ngIf="selectedHealthScan.heartDisease !== undefined">
              <label>Heart Disease</label>
              <span class="condition-value" [class]="selectedHealthScan.heartDisease ? 'yes' : 'no'">
                {{ selectedHealthScan.heartDisease ? 'Yes' : 'No' }}
              </span>
            </div>
            <div class="condition-item" *ngIf="selectedHealthScan.depression !== undefined">
              <label>Depression</label>
              <span class="condition-value" [class]="selectedHealthScan.depression ? 'yes' : 'no'">
                {{ selectedHealthScan.depression ? 'Yes' : 'No' }}
              </span>
            </div>
            <div class="condition-item" *ngIf="selectedHealthScan.physicalActivity !== undefined">
              <label>Physical Activity</label>
              <span class="condition-value" [class]="selectedHealthScan.physicalActivity ? 'yes' : 'no'">
                {{ selectedHealthScan.physicalActivity ? 'Yes' : 'No' }}
              </span>
            </div>
            <div class="condition-item" *ngIf="selectedHealthScan.healthyDiet !== undefined">
              <label>Healthy Diet</label>
              <span class="condition-value" [class]="selectedHealthScan.healthyDiet ? 'yes' : 'no'">
                {{ selectedHealthScan.healthyDiet ? 'Yes' : 'No' }}
              </span>
            </div>
          </div>
        </div>

        <div class="detail-section">
          <h4>Consultation Details</h4>
          <div class="consultation-info">
            <p><strong>Date:</strong> {{ formatDate(selectedHealthScan.consultation.startTime) }}</p>
            <p><strong>Time:</strong> {{ formatTime(selectedHealthScan.consultation.startTime) }}</p>
            <p><strong>Doctor:</strong> Dr. {{ selectedHealthScan.consultation.doctor.doctorInfo.firstName }} {{ selectedHealthScan.consultation.doctor.doctorInfo.lastName }}</p>
            <p><strong>Specialization:</strong> {{ selectedHealthScan.consultation.doctor.doctorInfo.specialization }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Consultation Modal -->
<div *ngIf="selectedConsultation" class="modal-overlay" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Consultation Details</h3>
      <button class="close-btn" (click)="closeModal()">
        <i class="material-icons">close</i>
      </button>
    </div>
    
    <div class="modal-body">
      <div class="consultation-details">
        <div class="detail-section">
          <h4>Appointment Information</h4>
          <div class="info-grid">
            <div class="info-item">
              <label>Date</label>
              <span>{{ formatDate(selectedConsultation.startTime) }}</span>
            </div>
            <div class="info-item">
              <label>Start Time</label>
              <span>{{ formatTime(selectedConsultation.startTime) }}</span>
            </div>
            <div class="info-item" *ngIf="selectedConsultation.endTime">
              <label>End Time</label>
              <span>{{ formatTime(selectedConsultation.endTime) }}</span>
            </div>
            <div class="info-item">
              <label>Duration</label>
              <span *ngIf="selectedConsultation.endTime">
                {{ calculateDuration(selectedConsultation.startTime, selectedConsultation.endTime) }}
              </span>
              <span *ngIf="!selectedConsultation.endTime">Ongoing</span>
            </div>
          </div>
        </div>

        <div class="detail-section">
          <h4>Doctor Information</h4>
          <div class="doctor-info">
            <p><strong>Name:</strong> Dr. {{ selectedConsultation.doctor.doctorInfo.firstName }} {{ selectedConsultation.doctor.doctorInfo.lastName }}</p>
            <p><strong>Specialization:</strong> {{ selectedConsultation.doctor.doctorInfo.specialization }}</p>
          </div>
        </div>

        <div class="detail-section" *ngIf="selectedConsultation.notes || selectedConsultation.diagnosis || selectedConsultation.treatment">
          <h4>Medical Information</h4>
          <div class="medical-info">
            <div class="info-item" *ngIf="selectedConsultation.notes">
              <label>Doctor's Notes</label>
              <div class="notes-content">
                <p>{{ selectedConsultation.notes }}</p>
              </div>
            </div>
            <div class="info-item" *ngIf="selectedConsultation.diagnosis">
              <label>Diagnosis</label>
              <div class="diagnosis-content">
                <p>{{ selectedConsultation.diagnosis }}</p>
              </div>
            </div>
            <div class="info-item" *ngIf="selectedConsultation.treatment">
              <label>Treatment Plan</label>
              <div class="treatment-content">
                <p>{{ selectedConsultation.treatment }}</p>
              </div>
            </div>
            <div class="info-item" *ngIf="selectedConsultation.followUpDate">
              <label>Follow-up Date</label>
              <div class="followup-content">
                <p><strong>Next Appointment:</strong> {{ formatDate(selectedConsultation.followUpDate) }}</p>
              </div>
            </div>
          </div>
        </div>

        <div class="detail-section" *ngIf="selectedConsultation.healthScan">
          <h4>Health Scan</h4>
          <div class="scan-summary">
            <p>This consultation included a comprehensive health scan.</p>
            <button class="view-scan-btn" (click)="viewHealthScan(selectedConsultation.healthScan)">
              View Scan Details
            </button>
          </div>
        </div>

        <div class="detail-section">
                      <h4>Consultation Access</h4>
          <div class="consultation-link">
            <p><strong>Consultation Code:</strong> {{ selectedConsultation.consultationCode }}</p>
                          <button class="copy-code-btn" (click)="copyToClipboard(selectedConsultation.consultationCode)">
                <i class="material-icons">content_copy</i>
                Copy Code
              </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Medical Record Modal -->
<div *ngIf="selectedMedicalRecord" class="modal-overlay" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ selectedMedicalRecord.title }}</h3>
      <button class="close-btn" (click)="closeModal()">
        <i class="material-icons">close</i>
      </button>
    </div>
    
    <div class="modal-body">
      <div class="medical-record-details">
        <div class="detail-section">
          <h4>Record Information</h4>
          <div class="info-grid">
            <div class="info-item">
              <label>Type</label>
              <span class="record-type-badge" [class]="'type-' + getRecordTypeColor(selectedMedicalRecord.recordType)">
                <i class="material-icons">{{ getRecordTypeIcon(selectedMedicalRecord.recordType) }}</i>
                {{ formatRecordType(selectedMedicalRecord.recordType) }}
              </span>
            </div>
            <div class="info-item">
              <label>Privacy</label>
              <span class="privacy-badge" [class]="'privacy-' + getPrivacyColor(selectedMedicalRecord.isPublic, selectedMedicalRecord.isSensitive)">
                <i class="material-icons">{{ getPrivacyIcon(selectedMedicalRecord.isPublic, selectedMedicalRecord.isSensitive) }}</i>
                {{ getPrivacyText(selectedMedicalRecord.isPublic, selectedMedicalRecord.isSensitive) }}
              </span>
            </div>
            <div class="info-item">
              <label>Created</label>
              <span>{{ formatDate(selectedMedicalRecord.createdAt) }}</span>
            </div>
            <div class="info-item">
              <label>Last Updated</label>
              <span>{{ formatDate(selectedMedicalRecord.updatedAt) }}</span>
            </div>
          </div>
        </div>

        <div class="detail-section">
          <h4>Content</h4>
          <div class="record-content-full" [innerHTML]="formatMedicalRecordContent(selectedMedicalRecord.content, selectedMedicalRecord.recordType)"></div>
        </div>

        <div class="detail-section">
          <h4>Creator Information</h4>
          <div class="creator-details">
            <p><strong>Created by:</strong> 
              {{ selectedMedicalRecord.creator.doctorInfo ? 'Dr. ' + selectedMedicalRecord.creator.doctorInfo.firstName + ' ' + selectedMedicalRecord.creator.doctorInfo.lastName : selectedMedicalRecord.creator.email }}
            </p>
            <p><strong>Role:</strong> {{ selectedMedicalRecord.creator.role }}</p>
          </div>
        </div>

        <div class="detail-section" *ngIf="selectedMedicalRecord.privacySettings?.length">
          <h4>Privacy Settings</h4>
          <div class="privacy-settings">
            <div *ngFor="let setting of selectedMedicalRecord.privacySettings" class="privacy-setting">
              <div class="setting-info">
                <span class="setting-type">{{ formatPrivacySettingType(setting.settingType) }}</span>
                <span class="setting-status" [class]="setting.isEnabled ? 'enabled' : 'disabled'">
                  {{ setting.isEnabled ? 'Enabled' : 'Disabled' }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
