<div class="patient-profile-container main-content" [class.modal-open]="showVerificationModal">
  <!-- Header Section -->
  <div class="profile-header">
    <div class="header-content">
      <div class="back-section">
        <button class="back-btn" (click)="onBack()">
          <i class="material-icons">arrow_back</i>
        </button>
        <div class="header-text">
          <h1>My Profile</h1>
          <p>Manage your personal and medical information</p>
        </div>
      </div>
      
      <div class="header-actions">
        <button *ngIf="!isEditing" class="verify-btn" (click)="openVerificationModal()">
          <i class="material-icons">verified_user</i>
          Verify Identity
        </button>
        <button *ngIf="!isEditing" class="edit-btn" (click)="onEdit()">
          <i class="material-icons">edit</i>
          Edit Profile
        </button>
        <div *ngIf="isEditing" class="edit-actions">
          <button class="cancel-btn" (click)="onCancel()">
            <i class="material-icons">close</i>
            Cancel
          </button>
          <button class="save-btn" (click)="onSave()">
            <i class="material-icons">save</i>
            Save Changes
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile Content -->
  <div class="profile-content">
    <!-- Personal Information Section -->
    <div class="profile-section">
      <div class="section-header">
        <h2>Personal Information</h2>
        <p>Your basic personal details and contact information</p>
      </div>
      
      <div class="section-content">
        <div class="profile-image-section">
          <div class="profile-image-container">
            <img 
              [src]="profile.personalInfo.profileImage || '/assets/default-avatar.jpg'" 
              [alt]="fullName"
              class="profile-image"
            >
            <div class="image-overlay" *ngIf="isEditing">
              <input 
                type="file" 
                #imageInput 
                (change)="onImageSelect($event)" 
                accept="image/*"
                class="image-input"
              >
              <button class="upload-btn" (click)="imageInput.click()">
                <i class="material-icons">photo_camera</i>
              </button>
            </div>
          </div>
          
          <div class="image-actions" *ngIf="isEditing">
            <button 
              *ngIf="selectedImage" 
              class="upload-confirm-btn" 
              (click)="onUploadImage()"
            >
              <i class="material-icons">cloud_upload</i>
              Upload
            </button>
            <button 
              *ngIf="profile.personalInfo.profileImage" 
              class="remove-image-btn" 
              (click)="onRemoveImage()"
            >
              <i class="material-icons">delete</i>
              Remove
            </button>
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label>Full Name</label>
            <input 
              *ngIf="isEditing"
              type="text" 
              [formControlName]="'fullName'"
              class="form-control"
              [class.error]="getFieldError('personalInfo', 'fullName')"
            >
            <p *ngIf="!isEditing" class="info-value">{{ profile.personalInfo.fullName }}</p>
            <span *ngIf="isEditing" class="error-message">{{ getFieldError('personalInfo', 'fullName') }}</span>
          </div>

          <div class="form-group">
            <label>Email</label>
            <input 
              *ngIf="isEditing"
              type="email" 
              [formControlName]="'email'"
              class="form-control"
              [class.error]="getFieldError('personalInfo', 'email')"
            >
            <p *ngIf="!isEditing" class="info-value">{{ profile.personalInfo.email }}</p>
            <span *ngIf="isEditing" class="error-message">{{ getFieldError('personalInfo', 'email') }}</span>
          </div>

          <div class="form-group">
            <label>Phone</label>
            <input 
              *ngIf="isEditing"
              type="tel" 
              [formControlName]="'contactNumber'"
              class="form-control"
              [class.error]="getFieldError('personalInfo', 'contactNumber')"
            >
            <p *ngIf="!isEditing" class="info-value">{{ profile.personalInfo.contactNumber }}</p>
            <span *ngIf="isEditing" class="error-message">{{ getFieldError('personalInfo', 'contactNumber') }}</span>
          </div>

          <div class="form-group">
            <label>Date of Birth</label>
            <input 
              *ngIf="isEditing"
              type="date" 
              [formControlName]="'dateOfBirth'"
              class="form-control"
              [class.error]="getFieldError('personalInfo', 'dateOfBirth')"
            >
            <p *ngIf="!isEditing" class="info-value">{{ profile.personalInfo.dateOfBirth | date:'mediumDate' }} ({{ age }} years old)</p>
            <span *ngIf="isEditing" class="error-message">{{ getFieldError('personalInfo', 'dateOfBirth') }}</span>
          </div>

          <div class="form-group">
            <label>Gender</label>
            <select 
              *ngIf="isEditing"
              [formControlName]="'gender'"
              class="form-control"
              [class.error]="getFieldError('personalInfo', 'gender')"
            >
              <option *ngFor="let gender of genderOptions" [value]="gender">{{ gender }}</option>
            </select>
            <p *ngIf="!isEditing" class="info-value">{{ profile.personalInfo.gender }}</p>
            <span *ngIf="isEditing" class="error-message">{{ getFieldError('personalInfo', 'gender') }}</span>
          </div>

          <div class="form-group">
            <label>Blood Type</label>
            <select 
              *ngIf="isEditing"
              [formControlName]="'bloodType'"
              class="form-control"
              [class.error]="getFieldError('personalInfo', 'bloodType')"
            >
              <option *ngFor="let bloodType of bloodTypeOptions" [value]="bloodType">{{ bloodType }}</option>
            </select>
            <p *ngIf="!isEditing" class="info-value">{{ profile.personalInfo.bloodType }}</p>
            <span *ngIf="isEditing" class="error-message">{{ getFieldError('personalInfo', 'bloodType') }}</span>
          </div>
        </div>

        <!-- Physical Measurements -->
        <div class="form-grid">
          <div class="form-group">
            <label>Height (cm)</label>
            <input 
              *ngIf="isEditing"
              type="number" 
              [formControlName]="'height'"
              class="form-control"
              [class.error]="getFieldError('personalInfo', 'height')"
              min="100" max="250"
            >
            <p *ngIf="!isEditing" class="info-value">{{ profile.personalInfo.height }} cm</p>
            <span *ngIf="isEditing" class="error-message">{{ getFieldError('personalInfo', 'height') }}</span>
          </div>

          <div class="form-group">
            <label>Weight (kg)</label>
            <input 
              *ngIf="isEditing"
              type="number" 
              [formControlName]="'weight'"
              class="form-control"
              [class.error]="getFieldError('personalInfo', 'weight')"
              min="20" max="300"
            >
            <p *ngIf="!isEditing" class="info-value">{{ profile.personalInfo.weight }} kg</p>
            <span *ngIf="isEditing" class="error-message">{{ getFieldError('personalInfo', 'weight') }}</span>
          </div>

          <div class="form-group">
            <label>BMI</label>
            <p class="info-value">{{ calculateBMI() }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Medical Information Section -->
    <div class="profile-section">
      <div class="section-header">
        <h2>Medical Information</h2>
        <p>Your medical history, allergies, and current medications</p>
      </div>
      
      <div class="section-content">
        <!-- Medical History -->
        <div class="form-group full-width">
          <label>Medical History</label>
          <textarea 
            *ngIf="isEditing"
            [formControlName]="'medicalHistory'"
            class="form-control"
            [class.error]="getFieldError('personalInfo', 'medicalHistory')"
            rows="4"
            placeholder="Describe any significant medical conditions, surgeries, or health events..."
          ></textarea>
          <p *ngIf="!isEditing" class="info-value">{{ profile.personalInfo.medicalHistory || 'No medical history recorded' }}</p>
          <span *ngIf="isEditing" class="error-message">{{ getFieldError('personalInfo', 'medicalHistory') }}</span>
        </div>

        <!-- Allergies -->
        <div class="list-section">
          <label>Allergies</label>
          <div *ngIf="!isEditing" class="info-list">
            <span *ngFor="let allergy of profile.personalInfo.allergies" class="info-tag">{{ allergy }}</span>
            <span *ngIf="!profile.personalInfo.allergies?.length" class="no-data">No allergies recorded</span>
          </div>
          <div *ngIf="isEditing" class="editable-list">
            <div *ngFor="let allergy of profile.personalInfo.allergies; let i = index" class="list-item">
              <input type="text" [value]="allergy" (blur)="onInputChange(profile.personalInfo.allergies, i, $event)" class="form-control">
              <button class="remove-item-btn" (click)="onRemoveItem(profile.personalInfo.allergies, i)">
                <i class="material-icons">remove_circle</i>
              </button>
            </div>
            <div class="add-item">
              <input type="text" #newAllergy placeholder="Add new allergy" class="form-control">
              <button class="add-item-btn" (click)="onAddItem(profile.personalInfo.allergies, newAllergy.value || ''); newAllergy.value = ''">
                <i class="material-icons">add_circle</i>
              </button>
            </div>
          </div>
        </div>

        <!-- Current Medications -->
        <div class="list-section">
          <label>Current Medications</label>
          <div *ngIf="!isEditing" class="info-list">
            <span *ngFor="let medication of profile.personalInfo.medications" class="info-tag">{{ medication }}</span>
            <span *ngIf="!profile.personalInfo.medications?.length" class="no-data">No medications recorded</span>
          </div>
          <div *ngIf="isEditing" class="editable-list">
            <div *ngFor="let medication of profile.personalInfo.medications; let i = index" class="list-item">
              <input type="text" [value]="medication" (blur)="onInputChange(profile.personalInfo.medications, i, $event)" class="form-control">
              <button class="remove-item-btn" (click)="onRemoveItem(profile.personalInfo.medications, i)">
                <i class="material-icons">remove_circle</i>
              </button>
            </div>
            <div class="add-item">
              <input type="text" #newMedication placeholder="Add new medication" class="form-control">
              <button class="add-item-btn" (click)="onAddItem(profile.personalInfo.medications, newMedication.value || ''); newMedication.value = ''">
                <i class="material-icons">add_circle</i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Contact Information Section -->
    <div class="profile-section">
      <div class="section-header">
        <h2>Contact Information</h2>
        <p>Your address and emergency contact details</p>
      </div>
      
      <div class="section-content">
        <div class="form-group full-width">
          <label>Address</label>
          <input 
            *ngIf="isEditing"
            type="text" 
            [formControlName]="'address'"
            class="form-control"
            [class.error]="getFieldError('personalInfo', 'address')"
          >
          <p *ngIf="!isEditing" class="info-value">{{ profile.personalInfo.address }}</p>
          <span *ngIf="isEditing" class="error-message">{{ getFieldError('personalInfo', 'address') }}</span>
        </div>

        <!-- Emergency Contact -->
        <div class="emergency-contact">
          <h3>Emergency Contact</h3>
          <div class="form-grid">
            <div class="form-group">
              <label>Contact Name</label>
              <input 
                *ngIf="isEditing"
                type="text" 
                [formControlName]="'emergencyContact.contactName'"
                class="form-control"
                [class.error]="getFieldError('emergencyContact', 'contactName')"
              >
              <p *ngIf="!isEditing" class="info-value">{{ profile.emergencyContact?.contactName || 'Not specified' }}</p>
              <span *ngIf="isEditing" class="error-message">{{ getFieldError('emergencyContact', 'contactName') }}</span>
            </div>

            <div class="form-group">
              <label>Relationship</label>
              <input 
                *ngIf="isEditing"
                type="text" 
                [formControlName]="'emergencyContact.relationship'"
                class="form-control"
                [class.error]="getFieldError('emergencyContact', 'relationship')"
                placeholder="e.g., Spouse, Parent, Sibling"
              >
              <p *ngIf="!isEditing" class="info-value">{{ profile.emergencyContact?.relationship || 'Not specified' }}</p>
              <span *ngIf="isEditing" class="error-message">{{ getFieldError('emergencyContact', 'relationship') }}</span>
            </div>

            <div class="form-group">
              <label>Contact Number</label>
              <input 
                *ngIf="isEditing"
                type="tel" 
                [formControlName]="'emergencyContact.contactNumber'"
                class="form-control"
                [class.error]="getFieldError('emergencyContact', 'contactNumber')"
              >
              <p *ngIf="!isEditing" class="info-value">{{ profile.emergencyContact?.contactNumber || 'Not specified' }}</p>
              <span *ngIf="isEditing" class="error-message">{{ getFieldError('emergencyContact', 'contactNumber') }}</span>
            </div>

            <div class="form-group">
              <label>Contact Address</label>
              <input 
                *ngIf="isEditing"
                type="text" 
                [formControlName]="'emergencyContact.contactAddress'"
                class="form-control"
                [class.error]="getFieldError('emergencyContact', 'contactAddress')"
              >
              <p *ngIf="!isEditing" class="info-value">{{ profile.emergencyContact?.contactAddress || 'Not specified' }}</p>
              <span *ngIf="isEditing" class="error-message">{{ getFieldError('emergencyContact', 'contactAddress') }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Insurance Information Section -->
    <div class="profile-section">
      <div class="section-header">
        <h2>Insurance Information</h2>
        <p>Your health insurance details and coverage information</p>
      </div>
      
      <div class="section-content">
        <div class="form-grid">
          <div class="form-group">
            <label>Insurance Provider</label>
            <input 
              *ngIf="isEditing"
              type="text" 
              [formControlName]="'insuranceInfo.providerName'"
              class="form-control"
              [class.error]="getFieldError('insuranceInfo', 'providerName')"
            >
            <p *ngIf="!isEditing" class="info-value">{{ profile.insuranceInfo?.providerName || 'Not specified' }}</p>
            <span *ngIf="isEditing" class="error-message">{{ getFieldError('insuranceInfo', 'providerName') }}</span>
          </div>

          <div class="form-group">
            <label>Policy Number</label>
            <input 
              *ngIf="isEditing"
              type="text" 
              [formControlName]="'insuranceInfo.policyNumber'"
              class="form-control"
              [class.error]="getFieldError('insuranceInfo', 'policyNumber')"
            >
            <p *ngIf="!isEditing" class="info-value">{{ profile.insuranceInfo?.policyNumber || 'Not specified' }}</p>
            <span *ngIf="isEditing" class="error-message">{{ getFieldError('insuranceInfo', 'policyNumber') }}</span>
          </div>

          <div class="form-group">
            <label>Insurance Contact</label>
            <input 
              *ngIf="isEditing"
              type="text" 
              [formControlName]="'insuranceInfo.insuranceContact'"
              class="form-control"
              [class.error]="getFieldError('insuranceInfo', 'insuranceContact')"
              placeholder="Phone number or email"
            >
            <p *ngIf="!isEditing" class="info-value">{{ profile.insuranceInfo?.insuranceContact || 'Not specified' }}</p>
            <span *ngIf="isEditing" class="error-message">{{ getFieldError('insuranceInfo', 'insuranceContact') }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Health Metrics Section -->
    <div class="profile-section">
      <div class="section-header">
        <h2>Health Metrics</h2>
        <p>Your current health measurements and vital signs</p>
      </div>
      
      <div class="section-content">
        <div class="info-grid">
          <div class="info-item">
            <label>BMI</label>
            <p class="info-value">{{ calculateBMI() }}</p>
          </div>
          
          <div class="info-item">
            <label>BMI Category</label>
            <p class="info-value">{{ getBMICategory() }}</p>
          </div>
          
          <div class="info-item">
            <label>Ideal Weight Range</label>
            <p class="info-value">{{ getIdealWeightRange() }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Preferences Section -->
    <div class="profile-section">
      <div class="section-header">
        <h2>Preferences</h2>
        <p>Your communication and healthcare preferences</p>
      </div>
      
      <div class="section-content">
        <div class="form-grid">
          <div class="form-group">
            <label>Preferred Language</label>
            <select 
              *ngIf="isEditing"
              [formControlName]="'preferences.language'"
              class="form-control"
              [class.error]="getFieldError('preferences', 'language')"
            >
              <option *ngFor="let lang of languageOptions" [value]="lang">{{ lang }}</option>
            </select>
            <p *ngIf="!isEditing" class="info-value">{{ profile.preferences.language || 'English' }}</p>
            <span *ngIf="isEditing" class="error-message">{{ getFieldError('preferences', 'language') }}</span>
          </div>

          <div class="form-group">
            <label>Communication Preference</label>
            <select 
              *ngIf="isEditing"
              [formControlName]="'preferences.communicationMethod'"
              class="form-control"
              [class.error]="getFieldError('preferences', 'communicationMethod')"
            >
              <option *ngFor="let method of communicationOptions" [value]="method">{{ method }}</option>
            </select>
            <p *ngIf="!isEditing" class="info-value">{{ profile.preferences.communicationMethod || 'Email' }}</p>
            <span *ngIf="isEditing" class="error-message">{{ getFieldError('preferences', 'communicationMethod') }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Verification Modal -->
<div class="verification-modal-overlay" *ngIf="showVerificationModal" (click)="closeVerificationModal($event)">
  <div class="verification-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Identity Verification</h2>
      <button class="close-btn" (click)="closeVerificationModal()">
        <i class="material-icons">close</i>
      </button>
    </div>
    
    <div class="modal-content">
      <p class="modal-description">
        Please upload your PhilHealth ID and take a selfie to verify your identity.
      </p>
      
      <!-- PhilHealth ID Upload Section -->
      <div class="upload-section">
        <h3>PhilHealth ID Upload</h3>
        <div class="upload-area" [class.has-file]="philhealthIdFile" (click)="triggerIdUpload()">
          <input 
            type="file" 
            #idFileInput 
            (change)="onPhilhealthIdSelect($event)" 
            accept="image/*,.pdf"
            class="file-input"
          >
          <div *ngIf="!philhealthIdFile" class="upload-placeholder">
            <i class="material-icons">cloud_upload</i>
            <p>Click to upload PhilHealth ID</p>
            <span>Supports JPG, PNG, PDF (Max 5MB)</span>
          </div>
          <div *ngIf="philhealthIdFile" class="uploaded-file">
            <i class="material-icons">description</i>
            <div class="file-info">
              <p class="file-name">{{ philhealthIdFile.name }}</p>
              <p class="file-size">{{ formatFileSize(philhealthIdFile.size) }}</p>
            </div>
            <button class="remove-file-btn" (click)="removePhilhealthId($event)">
              <i class="material-icons">close</i>
            </button>
          </div>
        </div>
      </div>
      
      <!-- Selfie Capture Section -->
      <div class="selfie-section">
        <h3>Selfie Verification</h3>
        <div class="camera-container">
          <div *ngIf="!capturedSelfie" class="camera-placeholder" (click)="openLivenessModal()">
            <i class="material-icons">face</i>
            <p>Click to start liveness check</p>
            <span>We'll verify you're a real person with a quick test</span>
          </div>
          
          <div *ngIf="capturedSelfie" class="captured-image">
            <img [src]="capturedSelfie" alt="Captured selfie" class="selfie-image">
            <div class="image-actions">
              <button class="retake-btn" (click)="openLivenessModal()">
                <i class="material-icons">refresh</i>
                Retake
              </button>
              <div class="verification-badge">
                <i class="material-icons">verified</i>
                <span>Liveness Verified</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="cancel-modal-btn" (click)="closeVerificationModal()">
        Cancel
      </button>
      <button 
        class="submit-verification-btn" 
        [disabled]="!canSubmitVerification() || isSubmittingVerification"
        (click)="submitVerification()"
      >
        <i class="material-icons" *ngIf="!isSubmittingVerification">verified_user</i>
        <i class="material-icons" *ngIf="isSubmittingVerification">hourglass_empty</i>
        {{ isSubmittingVerification ? 'Submitting...' : 'Submit Verification' }}
      </button>
    </div>
  </div>
</div>

<!-- Liveness Check Modal -->
<div class="liveness-modal-overlay" *ngIf="showLivenessModal" (click)="closeLivenessModal($event)">
  <div class="liveness-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Liveness Check</h2>
      <button class="close-btn" (click)="closeLivenessModal()">
        <i class="material-icons">close</i>
      </button>
    </div>
    
    <div class="modal-content">
      <div class="liveness-instructions">
        <h3>Follow the color sequence</h3>
        <p>Look at the camera and follow the colored flashes. This helps us verify you're a real person.</p>
      </div>
      
      <div class="camera-container">
        <div class="camera-preview">
          <video #videoElement autoplay playsinline class="camera-video"></video>
          
          <!-- Color Flash Overlay -->
          <div class="color-flash-overlay" [class]="'flash-' + currentFlashColor" *ngIf="currentFlashColor"></div>
          
          <!-- Progress Indicator -->
          <div class="progress-indicator" *ngIf="isLivenessCheckActive">
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="(currentFlashIndex / flashSequence.length) * 100"></div>
            </div>
            <p class="progress-text">
              {{ currentFlashIndex + 1 }} of {{ flashSequence.length }} - {{ currentFlashColor | titlecase }}
            </p>
          </div>
          
          <!-- Completion Message -->
          <div class="completion-message" *ngIf="livenessCheckComplete">
            <i class="material-icons">check_circle</i>
            <h3>Liveness Check Complete!</h3>
            <p>You can now capture your selfie</p>
          </div>
        </div>
        
        <!-- Camera Controls -->
        <div class="camera-controls">
          <button 
            *ngIf="!livenessCheckComplete" 
            class="cancel-btn" 
            (click)="closeLivenessModal()"
          >
            <i class="material-icons">close</i>
            Cancel
          </button>
          
          <button 
            *ngIf="livenessCheckComplete" 
            class="capture-btn" 
            (click)="captureLivenessSelfie()"
          >
            <i class="material-icons">camera_alt</i>
            Capture Selfie
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
