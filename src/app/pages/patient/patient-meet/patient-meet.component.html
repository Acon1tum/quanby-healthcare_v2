<div class="meet-container">
  <!-- Join Meeting Interface (shown when not joined) -->
  <div *ngIf="!isJoined" class="join-interface">
    
    <div class="join-card">
      <!-- Medical Animation -->
    <div class="medical-animation-container">
      <div #medicalAnimation class="medical-animation"></div>
    </div>
      <h2>Join Patient Meeting</h2>
      
      <div class="room-id-section">
        <div class="room-id-display">
          <div class="room-code">
            <input 
              type="text" 
              [(ngModel)]="roomId" 
              placeholder="Enter Room ID" 
              class="room-input"
              [disabled]="isJoining"
            >
          </div>
        </div>
        <!-- Join Meeting Button on the right -->
        <div class="start-meeting-container">
          <button 
            (click)="join()" 
            class="btn btn-primary start-meeting-btn"
            [disabled]="!roomId.trim() || isJoining"
          >
            <span *ngIf="!isJoining">Join Meeting</span>
            <span *ngIf="isJoining">Joining...</span>
          </button>
        </div>
        <p>Enter a room ID to join a video consultation with your doctor</p>
        <p class="room-instructions">Ask your doctor for the room code to join the meeting</p>
        
        <div *ngIf="errorMessage" class="error-message">
          {{ errorMessage }}
        </div>
      </div>
    </div>
  </div>

  <!-- Video Meeting Interface (shown when joined) -->
  <div *ngIf="isJoined" class="meeting-interface">
    <!-- Room Status -->
    <div class="room-status">
      <div class="status-item">
        <strong>Room ID:</strong> {{ roomId }}
      </div>
      <div class="status-item">
        <strong>Your Role:</strong> {{ currentRole }}
      </div>
      <div class="status-item">
        <strong>Participants:</strong> {{ participants }}/2
      </div>
    </div>

    <!-- Video Controls (top) - hidden in minimalist layout -->
    <div class="video-controls top-controls hide-mobile">
      <button (click)="leave()" class="btn btn-danger">Leave Meeting</button>
      <button (click)="toggleCamera()" class="btn" [ngClass]="isCameraOn ? 'btn-warning' : 'btn-success'">
        <span *ngIf="isCameraOn">📷 Turn Off Camera</span>
        <span *ngIf="!isCameraOn">📷 Turn On Camera</span>
      </button>
      <button (click)="toggleMicrophone()" class="btn" [ngClass]="isMicrophoneOn ? 'btn-warning' : 'btn-success'">
        <span *ngIf="isMicrophoneOn">🎤 Turn Off Microphone</span>
        <span *ngIf="!isMicrophoneOn">🎤 Turn On Microphone</span>
      </button>
      <button (click)="refreshLocalVideo()" class="btn btn-info">🔄 Refresh Local Video</button>
      <button (click)="refreshRemoteStream()" class="btn btn-secondary">Refresh Remote Stream</button>
      <button (click)="reinitializeAudio()" class="btn btn-warning">🎤 Fix Audio Echo</button>
      <button (click)="recoverConnection()" class="btn btn-danger">🔧 Recover Connection</button>
      <button (click)="debugRemoteStream()" class="btn btn-dark">🔍 Debug Remote</button>
    </div>

    <!-- Video Container -->
    <div class="meeting-layout">
      <div class="video-container">
        <!-- Remote Video (main) -->
        <div class="video-wrapper remote-main">
          <h3>Remote Video (Doctor)</h3>
          <div class="video-container-relative">
            <video 
              #remoteVideo 
              autoplay 
              playsinline
              class="video-element"
              *ngIf="remoteStream"
            ></video>

            <!-- Local Video (overlay preview) - positioned inside remote video -->
            <div class="video-wrapper local-preview">
              <div class="video-container-relative">
                <video 
                  #localVideo 
                  autoplay 
                  muted 
                  playsinline
                  class="video-element local-video"
                  *ngIf="localStream"
                ></video>
                <div *ngIf="!localStream && isJoined" class="video-loading">
                  <div class="loading-spinner"></div>
                  <p>Initializing camera...</p>
                </div>
                <div *ngIf="!isCameraOn && localStream" class="camera-off-overlay">
                  <div class="camera-off-icon">📷</div>
                  <p>Camera Off</p>
                </div>
              </div>
            </div>
          <!-- In-video overlay actions dropdown -->
          <div class="remote-overlay-actions" *ngIf="isJoined">
            <button class="overlay-toggle" (click)="toggleOverlayMenu()" title="More actions">⋮</button>
            <div class="overlay-menu" *ngIf="showOverlayMenu" (click)="closeOverlayMenu()">
              <button (click)="toggleCamera(); closeOverlayMenu()" class="btn btn-ghost">
                <span *ngIf="isCameraOn">📷 Turn Off Camera</span>
                <span *ngIf="!isCameraOn">📷 Turn On Camera</span>
              </button>
              <button (click)="toggleMicrophone(); closeOverlayMenu()" class="btn btn-ghost">
                <span *ngIf="isMicrophoneOn">🎤 Turn Off Microphone</span>
                <span *ngIf="!isMicrophoneOn">🎤 Turn On Microphone</span>
              </button>
              <button (click)="refreshRemoteStream(); closeOverlayMenu()" class="btn btn-ghost">Refresh Remote</button>
              <button (click)="refreshLocalVideo(); closeOverlayMenu()" class="btn btn-ghost">Refresh Local</button>
              <button (click)="debugRemoteStream(); closeOverlayMenu()" class="btn btn-ghost">Debug</button>
            </div>
          </div>
          <!-- Bottom-center control group -->
          <div class="remote-overlay-leave" *ngIf="isJoined">
            <div class="overlay-control-group">
              <button (click)="toggleCamera()" class="icon-btn icon-neutral" [attr.aria-label]="isCameraOn ? 'Turn off camera' : 'Turn on camera'" [title]="isCameraOn ? 'Turn off camera' : 'Turn on camera'">
                <img class="icon-img" [src]="isCameraOn ? '/camera-on.png' : '/camera-off.png'" [alt]="isCameraOn ? 'Camera on' : 'Camera off'" />
              </button>
              <button (click)="toggleMicrophone()" class="icon-btn icon-neutral" [attr.aria-label]="isMicrophoneOn ? 'Turn off microphone' : 'Turn on microphone'" [title]="isMicrophoneOn ? 'Turn off microphone' : 'Turn on microphone'">
                <img class="icon-img" [src]="isMicrophoneOn ? '/mic.png' : '/mute.png'" [alt]="isMicrophoneOn ? 'Microphone on' : 'Microphone off'" />
              </button>
              <button (click)="leave()" class="icon-btn icon-danger" aria-label="End call" title="End call">
                <img class="icon-img" src="/end-call.png" alt="End call" />
              </button>
              <!-- Show Doctor Details toggle when sidebar is collapsed -->
              <button 
                *ngIf="!showDoctorSidebar"
                class="icon-btn icon-neutral" 
                (click)="showDoctorSidebar = true" 
                aria-label="Show doctor details" 
                title="Doctor Details"
              >
                👨‍⚕️
              </button>
            </div>
          </div>
          <div *ngIf="!remoteStream" class="waiting-message">
            <p>Waiting for doctor to join...</p>
          </div>
          </div>
        </div>
        
      </div>
      
      <!-- Doctor Details Sidebar (moved next to video container) -->
      <!-- Mobile backdrop wrapper -->
      <div class="doctor-details-backdrop" *ngIf="isJoined && showDoctorSidebar" (click)="showDoctorSidebar = false"></div>
      
      <div class="doctor-details-sidebar" *ngIf="isJoined && showDoctorSidebar" (click)="$event.stopPropagation()">
        <div class="doctor-details-header">
          <h3>👨‍⚕️ Doctor Details</h3>
          <div class="header-actions">
            <button 
              class="btn btn-sm btn-outline-secondary" 
              (click)="showDoctorSidebar = false" 
              title="Collapse sidebar"
            >⤢</button>
          </div>
          <div class="mobile-dropdown">
            <button 
              class="mobile-dropdown-toggle" 
              (click)="refreshDoctorDetails()"
              title="Toggle details"
            >
              🔄
            </button>
          </div>
        </div>
        
        <div class="doctor-details-content">
          <div class="doctor-section" *ngIf="doctorDetails">
            <h4>Basic Information</h4>
            <div class="doctor-info-grid">
              <div class="info-item" *ngIf="doctorDetails?.specialization">
                <span class="info-label">Doctor Name:</span>
                <span class="info-value">{{ doctorDetails.name }}</span>
              </div>
              <div class="info-item" *ngIf="doctorDetails?.specialization">
                <span class="info-label">Specialization:</span>
                <span class="info-value">{{ doctorDetails.specialization }}</span>
              </div>
              <div class="info-item" *ngIf="doctorDetails?.bio">
                <span class="info-label">Bio:</span>
                <span class="info-value">{{ doctorDetails.bio }}</span>
              </div>
            </div>
          </div>
        </div>

        <div class="doctor-details-actions">
          <button 
            class="btn btn-primary"
            (click)="openPrescriptionDiagnosisModal()"
            title="View prescriptions and diagnoses from doctor"
          >
            Prescriptions & Diagnoses
          </button>
        </div>
      </div>
      
      <!-- Mobile Video Controls (shown below video on mobile) -->
      <div class="mobile-video-controls" *ngIf="isJoined">
        <div class="overlay-control-group">
          <!-- Camera toggle -->
          <button (click)="toggleCamera()" class="icon-btn icon-neutral" [attr.aria-label]="isCameraOn ? 'Turn off camera' : 'Turn on camera'" [title]="isCameraOn ? 'Turn off camera' : 'Turn on camera'">
            <img class="icon-img" [src]="isCameraOn ? '/camera-on.png' : '/camera-off.png'" [alt]="isCameraOn ? 'Camera on' : 'Camera off'" />
          </button>

          <!-- Microphone toggle -->
          <button (click)="toggleMicrophone()" class="icon-btn icon-neutral" [attr.aria-label]="isMicrophoneOn ? 'Turn off microphone' : 'Turn on microphone'" [title]="isMicrophoneOn ? 'Turn off microphone' : 'Turn on microphone'">
            <img class="icon-img" [src]="isMicrophoneOn ? '/mic.png' : '/mute.png'" [alt]="isMicrophoneOn ? 'Microphone on' : 'Microphone off'" />
          </button>

          <!-- End Call -->
          <button (click)="leave()" class="icon-btn icon-danger" aria-label="End call" title="End call">
            <img class="icon-img" src="/end-call.png" alt="End call" />
          </button>

          <!-- Show Doctor Details button when sidebar is collapsed -->
          <button 
            *ngIf="!showDoctorSidebar"
            class="icon-btn icon-neutral" 
            (click)="showDoctorSidebar = true" 
            aria-label="Show doctor details" 
            title="Doctor Details"
          >
            👨‍⚕️
          </button>
        </div>
      </div>
      
    </div>

    <!-- Meeting Footer Controls (minimalist) -->
    
  </div>

  <!-- Face Scan Request Modal -->
  <div *ngIf="showFaceScanRequest" class="face-scan-request-modal">
    <div class="face-scan-request-content">
      <div class="face-scan-request-header">
        <h3>🔍 Face Scan Request</h3>
      </div>
      
      <div class="face-scan-request-message">
        <p>{{ faceScanStatus }}</p>
      </div>
      
      <div class="face-scan-request-actions">
        <button 
          (click)="startFaceScan()" 
          class="btn btn-primary"
        >
          Start Face Scan
        </button>
        <button 
          (click)="showFaceScanRequest = false" 
          class="btn btn-secondary"
        >
          Decline
        </button>
      </div>
    </div>
  </div>

  <!-- Face Scan Modal -->
  <div *ngIf="showFaceScanModal" class="face-scan-modal">
    <div class="face-scan-modal-content">
      <div class="face-scan-header">
        <h3>{{ isFaceScanComplete ? 'Face Scan Complete!' : 'Face Scan in Progress' }}</h3>
        <button (click)="closeFaceScanModal()" class="btn-close">&times;</button>
      </div>
      
      <!-- Status only shown during scanning, not when complete -->
      <div *ngIf="!isFaceScanComplete" class="face-scan-status">
        <p>{{ faceScanStatus }}</p>
        
        <!-- Scan Time Remaining Display -->
        <div *ngIf="scanTimeRemaining > 0" class="scan-timer-display">
          <div class="timer-container">
            <div class="timer-icon">⏱️</div>
            <div class="timer-text">
              <span class="timer-label">Time Remaining:</span>
              <span class="timer-value">{{ scanTimeRemaining }} seconds</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Face Scan iframe (only show when scanning, not when complete) -->
      <div *ngIf="faceScanIframeUrl && !isFaceScanComplete" class="face-scan-iframe-container">
        <iframe
          #faceScanIframe
          [src]="faceScanIframeUrl"
          title="Face Scan Interface"
          allow="camera; microphone"
          class="face-scan-iframe"
        ></iframe>
      </div>
      
      <!-- Scan Results (only show when complete) -->
      <div *ngIf="isFaceScanComplete && faceScanResults" class="scan-results">
        <div class="results-header">
          <h4>✅ Face Scan Complete!</h4>
          <div class="results-actions">
            <button 
              (click)="showRawResults = !showRawResults" 
              class="btn btn-sm btn-outline-secondary"
              title="Toggle between formatted and raw results"
            >
              {{ showRawResults ? 'Show Formatted' : 'Show Raw Data' }}
            </button>
            <button 
              (click)="saveHealthScanResultsManually()" 
              class="btn btn-sm btn-success"
              [disabled]="isSavingToDatabase"
              title="Save health data to your profile"
            >
              <span *ngIf="!isSavingToDatabase">💾 Save to Profile</span>
              <span *ngIf="isSavingToDatabase">💾 Saving...</span>
            </button>
          </div>
        </div>
        
        <!-- Save Status -->
        <div *ngIf="saveStatus" class="save-status" [ngClass]="{'success': showSaveSuccessModal, 'error': showSaveErrorModal}">
          <span *ngIf="isSavingToDatabase" class="saving-indicator">
            <div class="spinner"></div>
            {{ saveStatus }}
          </span>
          <span *ngIf="!isSavingToDatabase" class="save-message">
            {{ saveStatus }}
          </span>
        </div>
        
        <div class="results-content">
          <div *ngIf="!showRawResults">
            <app-health-report-display [results]="faceScanResults"></app-health-report-display>
          </div>
          <div *ngIf="showRawResults">
            <h5>Raw JSON Data</h5>
            <pre>{{ faceScanResults | json }}</pre>
          </div>
        </div>
      </div>
      
      <div class="face-scan-actions">
        <button 
          *ngIf="!isFaceScanComplete" 
          (click)="closeFaceScanModal()" 
          class="btn btn-secondary"
        >
          Cancel Scan
        </button>
        <button 
          (click)="closeFaceScanModal()" 
          class="btn btn-primary"
        >
          {{ isFaceScanComplete ? 'Close' : 'Cancel' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Save Success Modal -->
  <div *ngIf="showSaveSuccessModal" class="save-success-modal">
    <div class="save-success-content">
      <div class="save-success-header">
        <h3>✅ Success!</h3>
      </div>
      <div class="save-success-message">
        <p>{{ saveStatus }}</p>
        <p>Your health data has been saved to your profile and can be accessed by your doctor.</p>
      </div>
      <div class="save-success-actions">
        <button (click)="closeSaveSuccessModal()" class="btn btn-primary">OK</button>
      </div>
    </div>
  </div>

  <!-- Save Error Modal -->
  <div *ngIf="showSaveErrorModal" class="save-error-modal">
    <div class="save-error-content">
      <div class="save-error-header">
        <h3>❌ Save Failed</h3>
      </div>
      <div class="save-error-message">
        <p>{{ saveStatus }}</p>
      </div>
      <div class="save-error-actions">
        <button (click)="retrySaveHealthScanResults()" class="btn btn-warning">Retry</button>
        <button (click)="closeSaveErrorModal()" class="btn btn-secondary">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Notification Toast -->
  <div *ngIf="showNotification" class="notification-toast" [ngClass]="'notification-' + notificationType">
    <div class="notification-content">
      <div class="notification-icon">
        <span *ngIf="notificationType === 'prescription'">💊</span>
        <span *ngIf="notificationType === 'diagnosis'">🔍</span>
        <span *ngIf="notificationType === 'info'">ℹ️</span>
      </div>
      <div class="notification-message">
        <h4>{{ notificationMessage }}</h4>
        <p *ngIf="notificationData && notificationData.status">{{ notificationData.status }}</p>
      </div>
      <div class="notification-actions">
        <button 
          (click)="hideNotification()" 
          class="btn btn-sm btn-secondary"
        >
          Dismiss
        </button>
      </div>
    </div>
  </div>

  <!-- Details Modal -->
  <div *ngIf="showDetailsModal" class="details-modal">
    <div class="details-modal-content">
      <div class="details-header">
        <h3>
          <span *ngIf="detailsType === 'prescription'">💊 Prescription Details</span>
          <span *ngIf="detailsType === 'diagnosis'">🔍 Diagnosis Details</span>
        </h3>
        <button (click)="closeDetailsModal()" class="btn-close">&times;</button>
      </div>
      
      <div class="details-content">
        <div *ngIf="detailsType === 'prescription'" class="prescription-details">
          <div class="detail-item">
            <strong>Medication:</strong> {{ detailsData?.medicationName || 'Not specified' }}
          </div>
          <div class="detail-item">
            <strong>Dosage:</strong> {{ detailsData?.dosage || 'Not specified' }}
          </div>
          <div class="detail-item">
            <strong>Frequency:</strong> {{ detailsData?.frequency || 'Not specified' }}
          </div>
          <div class="detail-item">
            <strong>Duration:</strong> {{ detailsData?.duration || 'Not specified' }}
          </div>
          <div class="detail-item" *ngIf="detailsData?.instructions">
            <strong>Instructions:</strong> {{ detailsData.instructions }}
          </div>
          <div class="detail-item" *ngIf="detailsData?.quantity">
            <strong>Quantity:</strong> {{ detailsData.quantity }}
          </div>
          <div class="detail-item" *ngIf="detailsData?.refills !== undefined && detailsData?.refills !== null">
            <strong>Refills:</strong> {{ detailsData.refills }}
          </div>
          <div class="detail-item" *ngIf="detailsData?.notes">
            <strong>Doctor's Notes:</strong> {{ detailsData.notes }}
          </div>
        </div>
        
        <div *ngIf="detailsType === 'diagnosis'" class="diagnosis-details">
          <div class="detail-item">
            <strong>Diagnosis Name:</strong> {{ detailsData?.diagnosisName || 'Not specified' }}
          </div>
          <div class="detail-item" *ngIf="detailsData?.diagnosisCode">
            <strong>Code:</strong> {{ detailsData.diagnosisCode }}
          </div>
          <div class="detail-item" *ngIf="detailsData?.severity">
            <strong>Severity:</strong> {{ detailsData.severity }}
          </div>
          <div class="detail-item" *ngIf="detailsData?.status">
            <strong>Status:</strong> {{ detailsData.status }}
          </div>
          <div class="detail-item" *ngIf="detailsData?.description">
            <strong>Description:</strong> {{ detailsData.description }}
          </div>
          <div class="detail-item" *ngIf="detailsData?.treatmentPlan">
            <strong>Treatment Plan:</strong> {{ detailsData.treatmentPlan }}
          </div>
          <div class="detail-item" *ngIf="detailsData?.notes">
            <strong>Notes:</strong> {{ detailsData.notes }}
          </div>
        </div>
        
        <div *ngIf="!detailsData" class="no-details">
          <p>No detailed information available.</p>
        </div>
      </div>
      
      <div class="details-actions">
        <button (click)="closeDetailsModal()" class="btn btn-primary">Close</button>
      </div>
    </div>
  </div>

  <!-- Prescription and Diagnosis Modal -->
  <div *ngIf="showPrescriptionDiagnosisModal" class="prescription-diagnosis-modal">
    <div class="prescription-diagnosis-modal-content">
      <div class="prescription-diagnosis-header">
        <h3>Prescriptions & Diagnoses</h3>
        <button (click)="closePrescriptionDiagnosisModal()" class="btn-close">&times;</button>
      </div>
      
      <div class="prescription-diagnosis-content">
        <!-- Prescriptions Section -->
        <div class="section">
          <h4>Prescriptions</h4>
          <div *ngIf="isLoadingPrescriptions" class="loading-section">
            <div class="loading-spinner"></div>
            <p>Loading prescriptions...</p>
          </div>
          <div *ngIf="!isLoadingPrescriptions && prescriptions.length === 0" class="empty-section">
            <p>N/A</p>
          </div>
          <div *ngIf="!isLoadingPrescriptions && prescriptions.length > 0" class="items-list">
            <div *ngFor="let prescription of prescriptions" class="item-card prescription-card" (click)="viewPrescriptionDetails(prescription)">
              <div class="item-header">
                <h5>{{ prescription.doctor.doctorInfo.firstName }} {{ prescription.doctor.doctorInfo.lastName }}</h5>
                <span class="item-date">{{ prescription.prescribedAt | date:'short' }}</span>
              </div>
              <div class="item-details">
                <p><strong>Medication Name:</strong> {{ prescription.medicationName }}</p>
                <p><strong>Dosage:</strong> {{ prescription.dosage }}</p>
                <p><strong>Frequency:</strong> {{ prescription.frequency }}</p>
                <p><strong>Duration:</strong> {{ prescription.duration }}</p>
                <p *ngIf="prescription.quantity"><strong>Quantity:</strong> {{ prescription.quantity }}</p>
                <p *ngIf="prescription.refills !== undefined && prescription.refills !== null"><strong>Refills:</strong> {{ prescription.refills }}</p>
                <p *ngIf="prescription.instructions"><strong>Instructions:</strong> {{ prescription.instructions }}</p>
                <p *ngIf="prescription.notes"><strong>Doctor's Notes:</strong> {{ prescription.notes }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Diagnoses Section -->
        <div class="section">
          <h4>Diagnoses</h4>
          <div *ngIf="isLoadingDiagnoses" class="loading-section">
            <div class="loading-spinner"></div>
            <p>Loading diagnoses...</p>
          </div>
          <div *ngIf="!isLoadingDiagnoses && diagnoses.length === 0" class="empty-section">
            <p>N/A</p>
          </div>
          <div *ngIf="!isLoadingDiagnoses && diagnoses.length > 0" class="items-list">
            <div *ngFor="let diagnosis of diagnoses" class="item-card diagnosis-card" (click)="viewDiagnosisDetails(diagnosis)">
              <div class="item-header">
                <h5>{{ diagnosis.doctor.doctorInfo.firstName }} {{ diagnosis.doctor.doctorInfo.lastName }}</h5>
                <span class="item-severity" [ngClass]="'severity-' + diagnosis.severity.toLowerCase()">{{ diagnosis.severity }}</span>
              </div>
              <div class="item-details">
                <p><strong>Diagnosis Name:</strong> {{ diagnosis.diagnosisName }}</p>
                <p><strong>Severity:</strong> {{ diagnosis.severity }}</p>
                <p *ngIf="diagnosis.diagnosisCode"><strong>Code:</strong> {{ diagnosis.diagnosisCode }}</p>
                <p *ngIf="diagnosis.status"><strong>Status:</strong> {{ diagnosis.status }}</p>
                <p *ngIf="diagnosis.description"><strong>Description:</strong> {{ diagnosis.description }}</p>
                <p *ngIf="diagnosis.notes"><strong>Notes:</strong> {{ diagnosis.notes }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="prescription-diagnosis-actions">
        <button (click)="closePrescriptionDiagnosisModal()" class="btn btn-primary">Close</button>
      </div>
    </div>
  </div>
</div>
