<div class="meet-container">
  <!-- Join Meeting Interface (shown when not joined) -->
  <div *ngIf="!isJoined" class="join-interface">
    <div class="join-card">
      <h2>Join Patient Meeting</h2>
      <p>Enter a room ID to join a video consultation with your doctor</p>
      
      <div class="input-group">
        <input 
          type="text" 
          [(ngModel)]="roomId" 
          placeholder="Enter Room ID" 
          class="room-input"
          [disabled]="isJoining"
        >
      </div>
      
      <div class="button-group">
        <button 
          (click)="join()" 
          class="btn btn-primary"
          [disabled]="!roomId.trim() || isJoining"
        >
          <span *ngIf="!isJoining">Join Meeting</span>
          <span *ngIf="isJoining">Joining...</span>
        </button>
      </div>
      
      <div *ngIf="errorMessage" class="error-message">
        {{ errorMessage }}
      </div>
    </div>
  </div>

  <!-- Video Meeting Interface (shown when joined) -->
  <div *ngIf="isJoined" class="meeting-interface">
    <!-- Room Status -->
    <div class="room-status">
      <div class="status-item">
        <strong>Room ID:</strong> {{ roomId }}
      </div>
      <div class="status-item">
        <strong>Your Role:</strong> {{ currentRole }}
      </div>
      <div class="status-item">
        <strong>Participants:</strong> {{ participants }}/2
      </div>
    </div>

    <!-- Video Controls (top) - hidden in minimalist layout -->
    <div class="video-controls top-controls hide-mobile">
      <button (click)="leave()" class="btn btn-danger">Leave Meeting</button>
      <button (click)="toggleCamera()" class="btn" [ngClass]="isCameraOn ? 'btn-warning' : 'btn-success'">
        <span *ngIf="isCameraOn">üì∑ Turn Off Camera</span>
        <span *ngIf="!isCameraOn">üì∑ Turn On Camera</span>
      </button>
      <button (click)="refreshLocalVideo()" class="btn btn-info">üîÑ Refresh Local Video</button>
      <button (click)="refreshRemoteStream()" class="btn btn-secondary">Refresh Remote Stream</button>
      <button (click)="debugRemoteStream()" class="btn btn-dark">üîç Debug Remote</button>
    </div>

    <!-- Video Container -->
    <div class="video-container">
      <!-- Local Video -->
      <div class="video-wrapper">
        <h3>Local Video (You - Patient)</h3>
        <div class="video-container-relative">
          <video 
            #localVideo 
            autoplay 
            muted 
            playsinline
            class="video-element local-video"
            *ngIf="localStream"
          ></video>
          <div *ngIf="!localStream && isJoined" class="video-loading">
            <div class="loading-spinner"></div>
            <p>Initializing camera...</p>
          </div>
          <div *ngIf="!isCameraOn && localStream" class="camera-off-overlay">
            <div class="camera-off-icon">üì∑</div>
            <p>Camera Off</p>
          </div>
        </div>
      </div>

      <!-- Remote Video -->
      <div class="video-wrapper">
        <h3>Remote Video (Doctor)</h3>
        <div class="video-container-relative">
          <video 
            #remoteVideo 
            autoplay 
            playsinline
            class="video-element local-video"
            *ngIf="remoteStream"
          ></video>
          <div *ngIf="!remoteStream" class="waiting-message">
            <p>Waiting for doctor to join...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Meeting Footer Controls (minimalist) -->
    <div class="meeting-footer">
      <div class="footer-actions">
        <button (click)="toggleCamera()" class="btn btn-ghost">
          <span *ngIf="isCameraOn">üì∑ Turn Off Camera</span>
          <span *ngIf="!isCameraOn">üì∑ Turn On Camera</span>
        </button>
        <button (click)="refreshRemoteStream()" class="btn btn-ghost">Refresh Remote</button>
        <button (click)="refreshLocalVideo()" class="btn btn-ghost">Refresh Local</button>
        <button (click)="debugRemoteStream()" class="btn btn-ghost">Debug</button>
        
        <span class="spacer"></span>
        
        <button (click)="leave()" class="btn btn-danger">Leave</button>
      </div>
    </div>
  </div>

  <!-- Face Scan Request Modal -->
  <div *ngIf="showFaceScanRequest" class="face-scan-request-modal">
    <div class="face-scan-request-content">
      <div class="face-scan-request-header">
        <h3>üîç Face Scan Request</h3>
      </div>
      
      <div class="face-scan-request-message">
        <p>{{ faceScanStatus }}</p>
      </div>
      
      <div class="face-scan-request-actions">
        <button 
          (click)="startFaceScan()" 
          class="btn btn-primary"
        >
          Start Face Scan
        </button>
        <button 
          (click)="showFaceScanRequest = false" 
          class="btn btn-secondary"
        >
          Decline
        </button>
      </div>
    </div>
  </div>

  <!-- Face Scan Modal -->
  <div *ngIf="showFaceScanModal" class="face-scan-modal">
    <div class="face-scan-modal-content">
      <div class="face-scan-header">
        <h3>{{ isFaceScanComplete ? 'Face Scan Complete!' : 'Face Scan in Progress' }}</h3>
        <button (click)="closeFaceScanModal()" class="btn-close">&times;</button>
      </div>
      
      <!-- Status only shown during scanning, not when complete -->
      <div *ngIf="!isFaceScanComplete" class="face-scan-status">
        <p>{{ faceScanStatus }}</p>
        
        <!-- Scan Time Remaining Display -->
        <div *ngIf="scanTimeRemaining > 0" class="scan-timer-display">
          <div class="timer-container">
            <div class="timer-icon">‚è±Ô∏è</div>
            <div class="timer-text">
              <span class="timer-label">Time Remaining:</span>
              <span class="timer-value">{{ scanTimeRemaining }} seconds</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Face Scan iframe (only show when scanning, not when complete) -->
      <div *ngIf="faceScanIframeUrl && !isFaceScanComplete" class="face-scan-iframe-container">
        <iframe
          #faceScanIframe
          [src]="faceScanIframeUrl"
          title="Face Scan Interface"
          allow="camera; microphone"
          class="face-scan-iframe"
        ></iframe>
      </div>
      
      <!-- Scan Results (only show when complete) -->
      <div *ngIf="isFaceScanComplete && faceScanResults" class="scan-results">
        <div class="results-header">
          <h4>‚úÖ Face Scan Complete!</h4>
          <div class="results-actions">
            <button 
              (click)="showRawResults = !showRawResults" 
              class="btn btn-sm btn-outline-secondary"
              title="Toggle between formatted and raw results"
            >
              {{ showRawResults ? 'Show Formatted' : 'Show Raw Data' }}
            </button>
            <button 
              (click)="saveHealthScanResultsManually()" 
              class="btn btn-sm btn-success"
              [disabled]="isSavingToDatabase"
              title="Save health data to your profile"
            >
              <span *ngIf="!isSavingToDatabase">üíæ Save to Profile</span>
              <span *ngIf="isSavingToDatabase">üíæ Saving...</span>
            </button>
          </div>
        </div>
        
        <!-- Save Status -->
        <div *ngIf="saveStatus" class="save-status" [ngClass]="{'success': showSaveSuccessModal, 'error': showSaveErrorModal}">
          <span *ngIf="isSavingToDatabase" class="saving-indicator">
            <div class="spinner"></div>
            {{ saveStatus }}
          </span>
          <span *ngIf="!isSavingToDatabase" class="save-message">
            {{ saveStatus }}
          </span>
        </div>
        
        <div class="results-content">
          <div *ngIf="!showRawResults">
            <app-health-report-display [results]="faceScanResults"></app-health-report-display>
          </div>
          <div *ngIf="showRawResults">
            <h5>Raw JSON Data</h5>
            <pre>{{ faceScanResults | json }}</pre>
          </div>
        </div>
      </div>
      
      <div class="face-scan-actions">
        <button 
          *ngIf="!isFaceScanComplete" 
          (click)="closeFaceScanModal()" 
          class="btn btn-secondary"
        >
          Cancel Scan
        </button>
        <button 
          (click)="closeFaceScanModal()" 
          class="btn btn-primary"
        >
          {{ isFaceScanComplete ? 'Close' : 'Cancel' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Save Success Modal -->
  <div *ngIf="showSaveSuccessModal" class="save-success-modal">
    <div class="save-success-content">
      <div class="save-success-header">
        <h3>‚úÖ Success!</h3>
      </div>
      <div class="save-success-message">
        <p>{{ saveStatus }}</p>
        <p>Your health data has been saved to your profile and can be accessed by your doctor.</p>
      </div>
      <div class="save-success-actions">
        <button (click)="closeSaveSuccessModal()" class="btn btn-primary">OK</button>
      </div>
    </div>
  </div>

  <!-- Save Error Modal -->
  <div *ngIf="showSaveErrorModal" class="save-error-modal">
    <div class="save-error-content">
      <div class="save-error-header">
        <h3>‚ùå Save Failed</h3>
      </div>
      <div class="save-error-message">
        <p>{{ saveStatus }}</p>
      </div>
      <div class="save-error-actions">
        <button (click)="retrySaveHealthScanResults()" class="btn btn-warning">Retry</button>
        <button (click)="closeSaveErrorModal()" class="btn btn-secondary">Cancel</button>
      </div>
    </div>
  </div>
</div>
