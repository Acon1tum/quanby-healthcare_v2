<div class="schedule-page">
  <div class="top-actions">
    <h2>My Appointments</h2>
    <button class="btn btn-ghost" (click)="openNewAppointmentModal()">
      <span class="icon-plus">+</span>
      Request New Appointment
    </button>
  </div>
  
  <div class="card">
    <table class="appointments-table">
      <thead>
        <tr>
          <th>Appointment ID</th>
          <th>Doctor</th>
          <th>Specialty</th>
          <th>Reason</th>
          <th>Scheduled</th>
          <th>Start</th>
          <th>End</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let appt of paginatedAppointments">
          <td>{{ appt.id }}</td>
          <td>{{ appt.doctor }}</td>
          <td>{{ appt.specialty }}</td>
          <td>{{ appt.reason }}</td>
          <td>{{ appt.scheduledAt | date:'MMM d, y, h:mm a' }}</td>
          <td>{{ appt.start | date:'MMM d, y, h:mm a' }}</td>
          <td>{{ appt.end | date:'MMM d, y, h:mm a' }}</td>
          <td>
            <span class="badge" [ngClass]="getStatusColor(appt.status)">{{ appt.status }}</span>
          </td>
          <td>
            <div class="row-actions">
              <button class="btn btn-reschedule" (click)="rescheduleAppointment(appt)" [disabled]="appt.status === 'cancelled' || appt.status === 'completed'">Reschedule</button>
              <button class="btn btn-cancel" (click)="cancelAppointment(appt)" [disabled]="appt.status === 'cancelled' || appt.status === 'completed'">Cancel</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
    
    <!-- Pagination Controls -->
    <div class="pagination-container" *ngIf="totalPages > 1">
      <div class="pagination-info">
        Showing {{ (currentPage - 1) * itemsPerPage + 1 }} to {{ getEndIndex() }} of {{ appointments.length }} appointments
      </div>
      <div class="pagination-controls">
        <button 
          class="btn btn-ghost pagination-btn" 
          (click)="previousPage()" 
          [disabled]="currentPage === 1"
          title="Previous page">
          ‹
        </button>
        
        <button 
          *ngFor="let page of getPageNumbers()" 
          class="btn pagination-btn" 
          [class.btn-active]="page === currentPage"
          [class.btn-ghost]="page !== currentPage"
          (click)="goToPage(page)">
          {{ page }}
        </button>
        
        <button 
          class="btn btn-ghost pagination-btn" 
          (click)="nextPage()" 
          [disabled]="currentPage === totalPages"
          title="Next page">
          ›
        </button>
      </div>
    </div>
  </div>

  <div class="calendar-header">
    <h3>{{ current | date:'MMMM y' }}</h3>
    <div class="calendar-nav">
      <button class="btn btn-ghost" (click)="prevMonth()">‹</button>
      <button class="btn btn-ghost" (click)="nextMonth()">›</button>
    </div>
  </div>

  <div class="calendar card">
    <div class="calendar-grid">
      <div class="dow" *ngFor="let d of ['Mon','Tue','Wed','Thu','Fri','Sat','Sun']">{{ d }}</div>
      <ng-container *ngFor="let week of weeks">
        <div class="day" *ngFor="let c of week" [class.out]="!c.inMonth" [class.appt]="c.hasAppt">
          <span class="num">{{ c.date.getDate() }}</span>
          <div class="appointment-indicator" *ngIf="c.hasAppt">
            <span class="appointment-count">{{ c.appointmentCount }}</span>
          </div>
        </div>
      </ng-container>
    </div>
  </div>

  <div class="calendar-legend">
    <div class="legend-item">
      <div class="legend-color appt"></div>
      <span>Appointments</span>
    </div>
  </div>

  <!-- Reschedule Modal -->
  <div class="modal-backdrop" *ngIf="showRescheduleModal" (click)="closeRescheduleModal()"></div>
  <div class="modal" *ngIf="showRescheduleModal" role="dialog" aria-modal="true">
    <div class="modal-header">
      <h3>Request Reschedule</h3>
      <button class="btn btn-ghost" (click)="closeRescheduleModal()">✕</button>
    </div>
    <div class="modal-body">
      <label>New date</label>
      <input type="date" [(ngModel)]="rescheduleDate" />
      <label>New time</label>
      <input type="time" [(ngModel)]="rescheduleTime" />
      <label>Reason</label>
      <textarea [(ngModel)]="rescheduleReason" rows="3"></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" (click)="closeRescheduleModal()">Cancel</button>
      <button class="btn btn-accept" [disabled]="!rescheduleDate || !rescheduleTime || !rescheduleReason.trim()" (click)="submitReschedule()">Submit</button>
    </div>
  </div>

  <!-- Cancel Modal -->
  <div class="modal-backdrop" *ngIf="showCancelModal" (click)="closeCancelModal()"></div>
  <div class="modal" *ngIf="showCancelModal" role="dialog" aria-modal="true">
    <div class="modal-header">
      <h3>Cancel Appointment</h3>
      <button class="btn btn-ghost" (click)="closeCancelModal()">✕</button>
    </div>
    <div class="modal-body">
      <label>Reason (optional)</label>
      <textarea [(ngModel)]="cancelReason" rows="3"></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" (click)="closeCancelModal()">Close</button>
      <button class="btn btn-cancel" (click)="submitCancel()">Cancel Appointment</button>
    </div>
  </div>

  <!-- New Appointment Modal -->
  <div class="modal-backdrop" *ngIf="showNewAppointmentModal" (click)="closeNewAppointmentModal()"></div>
  <div class="modal" *ngIf="showNewAppointmentModal" role="dialog" aria-modal="true">
    <div class="modal-header">
      <h3>Request New Appointment</h3>
      <button class="btn btn-ghost" (click)="closeNewAppointmentModal()">✕</button>
    </div>
    <div class="modal-body">
      <label>Select Doctor</label>
      <select [(ngModel)]="newApptDoctorId" (change)="onDoctorSelected()">
        <option value="">Choose a doctor...</option>
        <option *ngFor="let doctor of availableDoctors" [value]="doctor.id">
          {{ doctor.name }} - {{ doctor.specialization }}
        </option>
      </select>
      <label>Date</label>
      <input 
        type="date" 
        [(ngModel)]="newApptDate" 
        [min]="getMinDate()"
        [max]="getMaxDate()"
        (change)="onDateSelected()"
        [class.invalid-date]="newApptDate && !isDateAvailable(newApptDate)"
      />
      <small *ngIf="newApptDate && !isDateAvailable(newApptDate)" class="error-text">
        Doctor is not available on this date
      </small>
      <label>Time</label>
      <input type="time" [(ngModel)]="newApptTime" />
      <label>Reason</label>
      <textarea [(ngModel)]="newApptReason" rows="3"></textarea>
      <label>Priority</label>
      <select [(ngModel)]="newApptPriority">
        <option value="NORMAL">Normal</option>
        <option value="LOW">Low</option>
        <option value="HIGH">High</option>
        <option value="URGENT">Urgent</option>
      </select>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" (click)="closeNewAppointmentModal()">Cancel</button>
      <button class="btn btn-accept" [disabled]="!newApptDoctorId || !newApptDate || !newApptTime || !newApptReason.trim() || (newApptDate && !isDateAvailable(newApptDate))" (click)="submitNewAppointment()">Submit Request</button>
    </div>
  </div>
</div>

<!-- Error Modal -->
<div *ngIf="showErrorModal" class="modal-backdrop" (click)="closeErrorModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Notification</h3>
      <button class="btn btn-ghost" (click)="closeErrorModal()">×</button>
    </div>
    <div class="modal-body">
      <p>{{ errorMessage }}</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-accept" (click)="closeErrorModal()">OK</button>
    </div>
  </div>
</div>
