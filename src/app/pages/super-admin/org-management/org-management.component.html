<div class="org-management-dashboard">
  <!-- Header Section -->
  <header class="dashboard-header">
    <div class="header-content">
      <div class="welcome-section">
        <h1>{{ getGreeting() }}, {{ getSuperAdminDisplayName() }}</h1>
        <p class="subtitle">Organization Management â€¢ {{ currentDate | date:'EEEE, MMMM d, y' }}</p>
      </div>
      <div class="time-display">
        <div class="current-time">{{ currentDate | date:'h:mm a' }}</div>
      </div>
    </div>
  </header>

  <!-- Statistics Overview -->
  <section class="stats-overview">
    <div class="stats-grid">
      <div class="stat-card" [class.loading]="isLoadingStats">
        <div class="stat-icon">
          <i class="material-icons">business</i>
        </div>
        <div class="stat-content">
          <div class="stat-value">
            <span *ngIf="!isLoadingStats">{{ orgStats.totalOrganizations }}</span>
            <i *ngIf="isLoadingStats" class="material-icons rotating">refresh</i>
          </div>
          <div class="stat-label">Total Organizations</div>
        </div>
      </div>
      <div class="stat-card" [class.loading]="isLoadingStats">
        <div class="stat-icon">
          <i class="material-icons">check_circle</i>
        </div>
        <div class="stat-content">
          <div class="stat-value">
            <span *ngIf="!isLoadingStats">{{ orgStats.activeOrganizations }}</span>
            <i *ngIf="isLoadingStats" class="material-icons rotating">refresh</i>
          </div>
          <div class="stat-label">Active Organizations</div>
        </div>
      </div>
      <div class="stat-card" [class.loading]="isLoadingStats">
        <div class="stat-icon">
          <i class="material-icons">medical_services</i>
        </div>
        <div class="stat-content">
          <div class="stat-value">
            <span *ngIf="!isLoadingStats">{{ orgStats.totalDoctors }}</span>
            <i *ngIf="isLoadingStats" class="material-icons rotating">refresh</i>
          </div>
          <div class="stat-label">Total Doctors</div>
        </div>
      </div>
      <div class="stat-card" [class.loading]="isLoadingStats">
        <div class="stat-icon">
          <i class="material-icons">people</i>
        </div>
        <div class="stat-content">
          <div class="stat-value">
            <span *ngIf="!isLoadingStats">{{ orgStats.totalPatients }}</span>
            <i *ngIf="isLoadingStats" class="material-icons rotating">refresh</i>
          </div>
          <div class="stat-label">Total Patients</div>
        </div>
      </div>
    </div>
    <div class="stats-error" *ngIf="statsError">
      <i class="material-icons">error</i>
      <span>{{ statsError }}</span>
    </div>
  </section>

  

  <!-- Main Dashboard Content -->
  <div class="dashboard-content" [class.has-sidebar]="selectedOrganization">
    <!-- Left Column - Organizations List -->
    <div class="content-main">
      <!-- Organizations List -->
      <div class="content-card">
        <div class="card-header">
          <h3>Organizations</h3>
          <div class="header-actions">
            <button 
              class="refresh-button" 
              (click)="refreshOrganizations()"
              [disabled]="isLoadingOrganizations"
              title="Refresh organizations"
            >
              <i class="material-icons" [class.rotating]="isLoadingOrganizations">
                {{ isLoadingOrganizations ? 'refresh' : 'refresh' }}
              </i>
            </button>
            <button class="text-button" (click)="handleQuickAction('add')">
              Add Organization
            </button>
          </div>
        </div>

        <!-- Search and Filter Controls -->
        <div class="search-controls">
          <div class="search-input">
            <i class="material-icons">search</i>
            <input 
              type="text" 
              placeholder="Search organizations..." 
              [(ngModel)]="searchTerm"
            >
          </div>
          <select [(ngModel)]="filterStatus" class="filter-select">
            <option value="all">All Organizations</option>
            <option value="active">Active Only</option>
            <option value="inactive">Inactive Only</option>
          </select>
        </div>

        <div class="organizations-list">
          <!-- Loading State -->
          <div class="loading-state" *ngIf="isLoadingOrganizations">
            <i class="material-icons rotating">refresh</i>
            <p>Loading organizations...</p>
          </div>
          
          <!-- Error State -->
          <div class="error-state" *ngIf="organizationsError && !isLoadingOrganizations">
            <i class="material-icons">error</i>
            <p>{{ organizationsError }}</p>
            <button class="secondary-button" (click)="refreshOrganizations()">
              <i class="material-icons">refresh</i>
              Try Again
            </button>
          </div>
          
          <!-- Organizations Table -->
          <div *ngIf="!isLoadingOrganizations && !organizationsError">
            <div class="organizations-table-wrapper">
              <table class="organizations-table">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Address</th>
                    <th>Contact</th>
                    <th>Status</th>
                    <th>Doctors</th>
                    <th>Patients</th>
                    <th class="actions-col">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr 
                    *ngFor="let organization of getFilteredOrganizations(); trackBy: trackByOrganizationId"
                    [class.selected]="selectedOrganization?.id === organization.id"
                    (click)="selectOrganization(organization)"
                  >
                    <td>
                      <div class="org-name">{{ organization.name }}</div>
                      <div class="org-desc" *ngIf="organization.description">{{ organization.description }}</div>
                    </td>
                    <td>
                      <div class="muted" *ngIf="organization.address">{{ organization.address }}</div>
                    </td>
                    <td>
                      <div class="muted" *ngIf="organization.phone">{{ organization.phone }}</div>
                      <div class="muted" *ngIf="organization.email">{{ organization.email }}</div>
                    </td>
                    <td>
                      <span class="status-badge status-{{ getStatusColor(organization.isActive) }}">
                        {{ getStatusText(organization.isActive) }}
                      </span>
                    </td>
                    <td>{{ organization.doctorCount || 0 }}</td>
                    <td>{{ organization.patientCount || 0 }}</td>
                    <td class="row-actions" (click)="$event.stopPropagation()">
                      <button 
                        class="action-btn edit-btn" 
                        (click)="editOrganization(organization)"
                        title="Edit Organization"
                      >
                        <i class="material-icons">edit</i>
                      </button>
                      <button 
                        class="action-btn toggle-btn" 
                        [class.active]="organization.isActive"
                        (click)="toggleOrganizationStatus(organization)"
                        [title]="organization.isActive ? 'Deactivate' : 'Activate'"
                      >
                        <i class="material-icons">{{ organization.isActive ? 'pause' : 'play_arrow' }}</i>
                      </button>
                      <button 
                        class="action-btn delete-btn" 
                        (click)="deleteOrganization(organization)"
                        title="Delete Organization"
                      >
                        <i class="material-icons">delete</i>
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          
          <!-- Empty State -->
          <div class="empty-state" *ngIf="!isLoadingOrganizations && getFilteredOrganizations().length === 0">
            <i class="material-icons">business</i>
            <p *ngIf="searchTerm || filterStatus !== 'all'">No organizations found matching your criteria</p>
            <p *ngIf="!searchTerm && filterStatus === 'all'">No organizations registered yet</p>
            <button class="secondary-button" (click)="handleQuickAction('add')">
              <i class="material-icons">add</i>
              Add First Organization
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column - Organization Details & Secondary Content -->
    <div class="content-sidebar">
      <!-- Selected Organization Details -->
      <div class="content-card" *ngIf="selectedOrganization">
        <div class="card-header">
          <h3>{{ selectedOrganization.name }}</h3>
          <button class="text-button" (click)="editOrganization(selectedOrganization)">
            Edit
          </button>
        </div>
        <div class="organization-details-panel">
          <div class="detail-section">
            <h4>Contact Information</h4>
            <div class="detail-item" *ngIf="selectedOrganization.address">
              <i class="material-icons">location_on</i>
              <span>{{ selectedOrganization.address }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedOrganization.phone">
              <i class="material-icons">phone</i>
              <span>{{ selectedOrganization.phone }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedOrganization.email">
              <i class="material-icons">email</i>
              <span>{{ selectedOrganization.email }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedOrganization.website">
              <i class="material-icons">language</i>
              <a [href]="selectedOrganization.website" target="_blank">{{ selectedOrganization.website }}</a>
            </div>
          </div>

          <div class="detail-section">
            <h4>Statistics</h4>
            <div class="stat-row">
              <span class="stat-label">Doctors:</span>
              <span class="stat-value">{{ selectedOrganization.doctorCount || 0 }}</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Patients:</span>
              <span class="stat-value">{{ selectedOrganization.patientCount || 0 }}</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Status:</span>
              <span class="status-badge status-{{ getStatusColor(selectedOrganization.isActive) }}">
                {{ getStatusText(selectedOrganization.isActive) }}
              </span>
            </div>
          </div>

          <div class="detail-section">
            <h4>Doctors</h4>
            <div class="doctors-list">
              <!-- Loading State -->
              <div class="loading-state" *ngIf="isLoadingDoctors">
                <i class="material-icons rotating">refresh</i>
                <p>Loading doctors...</p>
              </div>
              
              <!-- Doctors List -->
              <div *ngIf="!isLoadingDoctors">
                <div 
                  *ngFor="let doctor of organizationDoctors; trackBy: trackByDoctorId" 
                  class="doctor-item"
                >
                  <div class="doctor-info">
                    <div class="doctor-name">{{ doctor.name }}</div>
                    <div class="doctor-specialization">{{ doctor.specialization }}</div>
                  </div>
                </div>
              </div>
              
              <!-- Empty State -->
              <div class="empty-state" *ngIf="!isLoadingDoctors && organizationDoctors.length === 0">
                <i class="material-icons">medical_services</i>
                <p>No doctors assigned</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      
    </div>
  </div>
</div>

<!-- Organization Modal -->
<div class="modal-overlay" *ngIf="showModal" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ modalTitle }}</h2>
      <button class="close-button" (click)="closeModal()">
        <i class="material-icons">close</i>
      </button>
    </div>
    
    <div class="modal-body">
      <form (ngSubmit)="onSubmit()" #organizationForm="ngForm">
        <div class="form-group">
          <label for="name">Organization Name *</label>
          <input 
            type="text" 
            id="name" 
            name="name" 
            [(ngModel)]="formData.name" 
            (input)="onInputChange($event, 'name')"
            required
            class="form-input"
            [class.error]="!fieldValid.name"
            placeholder="Enter organization name"
          >
          <div class="field-error" *ngIf="!fieldValid.name && formErrors.name">
            <i class="material-icons">error</i>
            <span>{{ formErrors.name }}</span>
          </div>
        </div>

        <div class="form-group">
          <label for="description">Description</label>
          <textarea 
            id="description" 
            name="description" 
            [(ngModel)]="formData.description" 
            (input)="onInputChange($event, 'description')"
            class="form-textarea"
            [class.error]="!fieldValid.description"
            placeholder="Enter organization description"
            rows="3"
            maxlength="500"
          ></textarea>
          <div class="field-footer">
            <div class="field-error" *ngIf="!fieldValid.description && formErrors.description">
              <i class="material-icons">error</i>
              <span>{{ formErrors.description }}</span>
            </div>
            <div class="character-count" [class.warning]="formData.description.length > 400">
              {{ formData.description.length }}/500
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="address">Address</label>
          <input 
            type="text" 
            id="address" 
            name="address" 
            [(ngModel)]="formData.address" 
            (input)="onInputChange($event, 'address')"
            class="form-input"
            [class.error]="!fieldValid.address"
            placeholder="Enter organization address"
          >
          <div class="field-error" *ngIf="!fieldValid.address && formErrors.address">
            <i class="material-icons">error</i>
            <span>{{ formErrors.address }}</span>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="phone">Phone</label>
            <input 
              type="tel" 
              id="phone" 
              name="phone" 
              [(ngModel)]="formData.phone" 
              (input)="onInputChange($event, 'phone')"
              class="form-input"
              [class.error]="!fieldValid.phone"
              maxlength="11"
              inputmode="numeric"
              pattern="\\d{11}"
              placeholder="Enter phone number"
            >
            <div class="field-error" *ngIf="!fieldValid.phone && formErrors.phone">
              <i class="material-icons">error</i>
              <span>{{ formErrors.phone }}</span>
            </div>
          </div>

          <div class="form-group">
            <label for="email">Email</label>
            <input 
              type="email" 
              id="email" 
              name="email" 
              [(ngModel)]="formData.email" 
              (input)="onInputChange($event, 'email')"
              class="form-input"
              [class.error]="!fieldValid.email"
              placeholder="Enter email address"
            >
            <div class="field-error" *ngIf="!fieldValid.email && formErrors.email">
              <i class="material-icons">error</i>
              <span>{{ formErrors.email }}</span>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="website">Website</label>
          <input 
            type="url" 
            id="website" 
            name="website" 
            [(ngModel)]="formData.website" 
            (input)="onInputChange($event, 'website')"
            class="form-input"
            [class.error]="!fieldValid.website"
            placeholder="Enter website URL"
          >
          <div class="field-error" *ngIf="!fieldValid.website && formErrors.website">
            <i class="material-icons">error</i>
            <span>{{ formErrors.website }}</span>
          </div>
        </div>

        <div class="form-group" *ngIf="modalMode === 'edit'">
          <label class="checkbox-label">
            <input 
              type="checkbox" 
              [(ngModel)]="formData.isActive" 
              name="isActive"
            >
            <span class="checkmark"></span>
            Active Organization
          </label>
        </div>

        <div class="error-message" *ngIf="submitError">
          <i class="material-icons">error</i>
          <span>{{ submitError }}</span>
        </div>
      </form>
    </div>
    
    <div class="modal-footer">
      <button 
        type="button" 
        class="secondary-button" 
        (click)="closeModal()"
        [disabled]="isSubmitting"
      >
        Cancel
      </button>
      <button 
        type="button" 
        class="primary-button" 
        (click)="onSubmit()"
        [disabled]="isSubmitting || !isFormValid()"
      >
        <i class="material-icons" *ngIf="isSubmitting" class="rotating">refresh</i>
        <span *ngIf="!isSubmitting">{{ modalMode === 'create' ? 'Create' : 'Update' }}</span>
        <span *ngIf="isSubmitting">Processing...</span>
      </button>
    </div>
  </div>
</div>