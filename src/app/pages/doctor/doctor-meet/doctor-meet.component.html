<div class="meet-container">
  <!-- Join Meeting Interface (shown when not joined) -->
  <div *ngIf="!isJoined" class="join-interface">
    <div class="join-card">
      <h2>Create Doctor Meeting</h2>
      <p>Generate a room ID to start a video consultation with a patient</p>
      
      <div class="room-id-section">
        <div class="room-id-display">
          <div class="room-code">
            <span class="room-code-text">{{ roomId }}</span>
            <button 
              (click)="copyRoomIdToClipboard()" 
              class="btn btn-icon btn-outline-primary"
              title="Copy room code to clipboard"
            >
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg>
            </button>
            <button 
              (click)="generateNewRoomId()" 
              class="btn btn-icon btn-outline-secondary"
              title="Generate new room code"
            >
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
                <path d="M21 3v5h-5"></path>
                <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
                <path d="M3 21v-5h5"></path>
              </svg>
            </button>
          </div>
        </div>
        <p class="room-instructions">Share this code with your patient to join the meeting</p>
        
        <div *ngIf="copySuccessMessage" class="success-message">
          {{ copySuccessMessage }}
        </div>
      </div>
      
      <div class="button-group">
        <button 
          (click)="join()" 
          class="btn btn-primary"
          [disabled]="!roomId.trim() || isJoining"
        >
          <span *ngIf="!isJoining">Start Meeting</span>
          <span *ngIf="isJoining">Starting...</span>
        </button>
      </div>
      
      <div *ngIf="errorMessage" class="error-message">
        {{ errorMessage }}
      </div>
    </div>
  </div>

  <!-- Video Meeting Interface (shown when joined) -->
  <div *ngIf="isJoined" class="meeting-interface">
    <!-- Room Status -->
    <div class="room-status">
      <div class="status-item">
        <strong>Room ID:</strong> {{ roomId }}
      </div>
      <div class="status-item">
        <strong>Your Role:</strong> {{ currentRole }}
      </div>
      <div class="status-item">
        <strong>Participants:</strong> {{ participants }}/2
      </div>
    </div>

    <!-- Video Controls (top) - hidden in minimalist layout -->
    <div class="video-controls top-controls hide-mobile">
      <button (click)="leave()" class="btn btn-danger">Leave Meeting</button>
      <button (click)="toggleCamera()" class="btn" [ngClass]="isCameraOn ? 'btn-warning' : 'btn-success'">
        <span *ngIf="isCameraOn">üì∑ Turn Off Camera</span>
        <span *ngIf="!isCameraOn">üì∑ Turn On Camera</span>
      </button>
      <button (click)="refreshLocalVideo()" class="btn btn-info">üîÑ Refresh Local Video</button>
      <button (click)="refreshRemoteStream()" class="btn btn-secondary">Refresh Remote Stream</button>
      <button (click)="debugRemoteStream()" class="btn btn-dark">üîç Debug Remote</button>
      
      <!-- Face Scan Button - Only visible when patient is connected -->
      <button 
        *ngIf="remoteStream" 
        (click)="startFaceScan()" 
        class="btn btn-primary"
        [disabled]="isFaceScanning"
        title="Start face scan for patient health assessment"
      >
        <span *ngIf="!isFaceScanning">üîç Start Face Scan</span>
        <span *ngIf="isFaceScanning">‚è≥ Scanning...</span>
      </button>
      
      <!-- Prescription Button - Only visible when patient is connected -->
      <button 
        *ngIf="remoteStream" 
        (click)="openPrescriptionModal()" 
        class="btn btn-success"
        title="Create prescription for patient"
      >
        üíä Write Prescription
      </button>
    </div>

    <!-- Video Container -->
    <div class="video-container">
      <!-- Local Video -->
      <div class="video-wrapper">
        <h3>Local Video (You - Doctor)</h3>
        <div class="video-container-relative">
          <video 
            #localVideo 
            autoplay 
            muted 
            playsinline
            class="video-element local-video"
            *ngIf="localStream"
          ></video>
          <div *ngIf="!localStream && isJoined" class="video-loading">
            <div class="loading-spinner"></div>
            <p>Initializing camera...</p>
          </div>
          <div *ngIf="!isCameraOn && localStream" class="camera-off-overlay">
            <div class="camera-off-icon">üì∑</div>
            <p>Camera Off</p>
          </div>
        </div>
      </div>

      <!-- Remote Video -->
      <div class="video-wrapper">
        <h3>Remote Video (Patient)</h3>
        <div class="video-container-relative">
          <video 
            #remoteVideo 
            autoplay 
            playsinline
            class="video-element local-video"
            *ngIf="remoteStream"
          ></video>
          <div *ngIf="!remoteStream" class="waiting-message">
            <p>Waiting for patient to join...</p>
            <!-- Debug connection status -->
            <div class="connection-status-debug" *ngIf="!remoteStream">
              <details>
                <summary>üîß Connection Debug (Click to expand)</summary>
                <div class="debug-info">
                  <p><strong>Room:</strong> {{ roomId }}</p>
                  <p><strong>Status:</strong> {{ getConnectionStatus() }}</p>
                </div>
              </details>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Meeting Footer Controls (minimalist) -->
    <div class="meeting-footer">
      <div class="footer-actions">
        <button (click)="toggleCamera()" class="btn btn-ghost">
          <span *ngIf="isCameraOn">üì∑ Turn Off Camera</span>
          <span *ngIf="!isCameraOn">üì∑ Turn On Camera</span>
        </button>
        <button (click)="refreshRemoteStream()" class="btn btn-ghost">Refresh Remote</button>
        <button (click)="refreshLocalVideo()" class="btn btn-ghost">Refresh Local</button>
        <button (click)="debugRemoteStream()" class="btn btn-ghost">Debug</button>
        
        <!-- Face Scan Button in footer for mobile -->
        <button 
          *ngIf="remoteStream" 
          (click)="startFaceScan()" 
          class="btn btn-ghost btn-primary"
          [disabled]="isFaceScanning"
          title="Start face scan for patient health assessment"
        >
          <span *ngIf="!isFaceScanning">üîç Face Scan</span>
          <span *ngIf="isFaceScanning">‚è≥ Scanning...</span>
        </button>
        
        <!-- Prescription Button in footer for mobile -->
        <button 
          *ngIf="remoteStream" 
          (click)="openPrescriptionModal()" 
          class="btn btn-ghost btn-success"
          title="Create prescription for patient"
        >
          üíä Prescription
        </button>
        
        <span class="spacer"></span>
        
        <button (click)="leave()" class="btn btn-danger">Leave</button>
      </div>
    </div>
  </div>

  <!-- Face Scan Modal -->
  <div *ngIf="showFaceScanModal" class="face-scan-modal">
    <div class="face-scan-modal-content">
      <div class="face-scan-header">
        <h3>{{ isFaceScanComplete ? 'Face Scan Complete!' : 'Face Scan in Progress' }}</h3>
        <button (click)="closeFaceScanModal()" class="btn-close">&times;</button>
      </div>
      
      <!-- Status only shown during scanning, not when complete -->
      <div *ngIf="!isFaceScanComplete" class="face-scan-status">
        <p>{{ faceScanStatus }}</p>
      </div>
      
      <!-- Face Scan iframe (only show when scanning, not when complete) -->
      <div *ngIf="faceScanIframeUrl && !isFaceScanComplete" class="face-scan-iframe-container">
        <iframe
          #faceScanIframe
          [src]="faceScanIframeUrl"
          title="Face Scan Interface"
          allow="camera; microphone"
          class="face-scan-iframe"
        ></iframe>
      </div>
      
      <!-- Scan Results (only show when complete) -->
      <div *ngIf="isFaceScanComplete && faceScanResults" class="scan-results">
        <div class="results-header">
          <h4>‚úÖ Face Scan Complete!</h4>
          <button 
            (click)="showRawResults = !showRawResults" 
            class="btn btn-sm btn-outline-secondary"
            title="Toggle between formatted and raw results"
          >
            {{ showRawResults ? 'Show Formatted' : 'Show Raw Data' }}
          </button>
        </div>
        <div class="results-content">
          <div *ngIf="!showRawResults">
            <app-health-report-display [results]="faceScanResults"></app-health-report-display>
          </div>
          <div *ngIf="showRawResults">
            <h5>Raw JSON Data</h5>
            <pre>{{ faceScanResults | json }}</pre>
          </div>
        </div>
      </div>
      
      <div class="face-scan-actions">
        <button 
          *ngIf="!isFaceScanComplete" 
          (click)="closeFaceScanModal()" 
          class="btn btn-secondary"
        >
          Cancel Scan
        </button>
        <button 
          (click)="closeFaceScanModal()" 
          class="btn btn-primary"
        >
          {{ isFaceScanComplete ? 'Close' : 'Cancel' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Prescription Modal -->
  <div *ngIf="showPrescriptionModal" class="prescription-modal">
    <div class="prescription-modal-content">
      <div class="prescription-header">
        <h3>üíä Write Prescription</h3>
        <button (click)="closePrescriptionModal()" class="btn-close">&times;</button>
      </div>
      
      <form (ngSubmit)="submitPrescription()" class="prescription-form">
        <!-- Error Message -->
        <div *ngIf="prescriptionError" class="alert alert-error">
          {{ prescriptionError }}
        </div>
        
        <!-- Success Message -->
        <div *ngIf="prescriptionSuccess" class="alert alert-success">
          {{ prescriptionSuccess }}
        </div>
        
        <!-- Patient and Consultation Info Display -->
        <div class="consultation-info" *ngIf="currentPatient">
          <div class="info-item">
            <strong>Patient:</strong> {{ currentPatient.fullName }}
          </div>
          <div class="info-item" *ngIf="currentConsultation">
            <strong>Consultation ID:</strong> {{ currentConsultation.id }}
          </div>
          <div class="info-item" *ngIf="!currentConsultation && consultationId">
            <strong>Status:</strong> Creating consultation...
          </div>
          <div class="info-item" *ngIf="!currentConsultation && !consultationId">
            <strong>Mode:</strong> Direct Prescription (No Consultation)
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="medicationName">Medication Name *</label>
            <input 
              type="text" 
              id="medicationName"
              [(ngModel)]="prescriptionForm.medicationName" 
              name="medicationName"
              class="form-control"
              placeholder="e.g., Amoxicillin"
              required
            >
          </div>
          
          <div class="form-group">
            <!-- Empty div for layout balance -->
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="dosage">Dosage *</label>
            <input 
              type="text" 
              id="dosage"
              [(ngModel)]="prescriptionForm.dosage" 
              name="dosage"
              class="form-control"
              placeholder="e.g., 500mg"
              required
            >
          </div>
          
          <div class="form-group">
            <label for="frequency">Frequency *</label>
            <select 
              id="frequency"
              [(ngModel)]="prescriptionForm.frequency" 
              name="frequency"
              class="form-control"
              required
            >
              <option value="">Select frequency</option>
              <option value="Once daily">Once daily</option>
              <option value="Twice daily">Twice daily</option>
              <option value="Three times daily">Three times daily</option>
              <option value="Four times daily">Four times daily</option>
              <option value="Every 6 hours">Every 6 hours</option>
              <option value="Every 8 hours">Every 8 hours</option>
              <option value="Every 12 hours">Every 12 hours</option>
              <option value="As needed">As needed</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="duration">Duration *</label>
            <input 
              type="text" 
              id="duration"
              [(ngModel)]="prescriptionForm.duration" 
              name="duration"
              class="form-control"
              placeholder="e.g., 7 days, 2 weeks"
              required
            >
          </div>
          
          <div class="form-group">
            <label for="quantity">Quantity</label>
            <input 
              type="number" 
              id="quantity"
              [(ngModel)]="prescriptionForm.quantity" 
              name="quantity"
              class="form-control"
              placeholder="e.g., 30"
              min="1"
            >
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="refills">Refills</label>
            <input 
              type="number" 
              id="refills"
              [(ngModel)]="prescriptionForm.refills" 
              name="refills"
              class="form-control"
              placeholder="0"
              min="0"
            >
          </div>
          
          <div class="form-group">
            <label for="prescribedAt">Prescribed Date</label>
            <input 
              type="datetime-local" 
              id="prescribedAt"
              [(ngModel)]="prescriptionForm.prescribedAt" 
              name="prescribedAt"
              class="form-control"
            >
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="expiresAt">Expiration Date</label>
            <input 
              type="datetime-local" 
              id="expiresAt"
              [(ngModel)]="prescriptionForm.expiresAt" 
              name="expiresAt"
              class="form-control"
            >
          </div>
          
          <div class="form-group">
            <!-- Empty div for layout balance -->
          </div>
        </div>

        <div class="form-group">
          <label for="instructions">Instructions</label>
          <textarea 
            id="instructions"
            [(ngModel)]="prescriptionForm.instructions" 
            name="instructions"
            class="form-control"
            rows="3"
            placeholder="e.g., Take with food, avoid alcohol"
          ></textarea>
        </div>

        <div class="form-group">
          <label for="notes">Doctor's Notes</label>
          <textarea 
            id="notes"
            [(ngModel)]="prescriptionForm.notes" 
            name="notes"
            class="form-control"
            rows="2"
            placeholder="Additional notes about this prescription"
          ></textarea>
        </div>

        <div class="prescription-actions">
          <button 
            type="button" 
            (click)="closePrescriptionModal()" 
            class="btn btn-secondary"
          >
            Cancel
          </button>
          <button 
            type="submit" 
            class="btn btn-success"
            [disabled]="isSubmittingPrescription"
          >
            <span *ngIf="!isSubmittingPrescription">üíä Submit Prescription</span>
            <span *ngIf="isSubmittingPrescription">‚è≥ Submitting...</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Prescriptions List Modal (if needed) -->
  <div *ngIf="prescriptions.length > 0" class="prescriptions-list">
    <h4>Recent Prescriptions</h4>
    <div class="prescription-item" *ngFor="let prescription of prescriptions; let i = index">
      <div class="prescription-info">
        <strong>{{ prescription.medicationName }}</strong> - {{ prescription.dosage }}
        <br>
        <small>{{ prescription.frequency }} for {{ prescription.duration }}</small>
      </div>
      <div class="prescription-actions">
        <button (click)="editPrescription(i)" class="btn btn-sm btn-outline-primary">Edit</button>
        <button (click)="deletePrescription(i)" class="btn btn-sm btn-outline-danger">Delete</button>
      </div>
    </div>
  </div>
</div>
