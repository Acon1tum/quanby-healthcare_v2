<div class="meet-container">
  <!-- Join Meeting Interface (shown when not joined) -->
  <div *ngIf="!isJoined" class="join-interface">
    
    <div class="join-card">
      <!-- Medical Animation -->
    <div class="medical-animation-container">
      <div #medicalAnimation class="medical-animation"></div>
    </div>
      <h2>Create Doctor Meeting</h2>
      
      <div class="room-id-section">
        <div class="room-id-display">
          <div class="room-code">
            <ng-container *ngIf="!showRejoinInput; else rejoinInputTpl">
              <span class="room-code-text">{{ roomId }}</span>
            <button 
              (click)="copyRoomIdToClipboard()" 
              class="btn btn-icon btn-outline-primary" style="margin-left: -10px; margin-right: -10px;"
              title="Copy room code to clipboard"
            >
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg>
            </button>
            <button 
              (click)="generateNewRoomId()" 
              class="btn btn-icon btn-outline-secondary" style="margin-left: -10px; margin-right: -10px;"
              title="Generate new room code"
            >
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
                <path d="M21 3v5h-5"></path>
                <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
                <path d="M3 21v-5h5"></path>
              </svg>
            </button>
            </ng-container>
            <ng-template #rejoinInputTpl>
              <input
                type="text"
                class="room-input"
                [(ngModel)]="rejoinRoomId"
                placeholder="Enter room code to rejoin"
                [disabled]="isJoining"
              >
              <button
                type="button"
                class="btn btn-secondary"
                (click)="rejoinUsingCode()"
                [disabled]="!rejoinRoomId.trim() || isJoining"
              >
                Join
              </button>
            </ng-template>
          </div>
        </div>
        <!-- Start Meeting Button on the right -->
        <div class="start-meeting-container" *ngIf="!showRejoinInput">
          <button 
            (click)="join()" 
            class="btn btn-primary start-meeting-btn"
            [disabled]="!roomId.trim() || isJoining"
          >
            <span *ngIf="!isJoining">Start Meeting</span>
            <span *ngIf="isJoining">Starting...</span>
          </button>
        </div>
        
        <!-- Rejoin via code toggle -->
        <div class="rejoin-section">
          <button 
            type="button"
            class="btn btn-outline-primary"
            style="font-size: 15px;"
            (click)="toggleRejoinInput()"
            [disabled]="isJoining"
            title="Enter a room code to rejoin an existing meeting"
          >
            {{ showRejoinInput ? 'Create Code' : 'Rejoin via Code' }}
          </button>
        </div>
        <p>Generate a room ID to start a video consultation with a patient</p>
        <p class="room-instructions">Share this code with your patient to join the meeting</p>
        
        <div *ngIf="copySuccessMessage" class="success-message">
          {{ copySuccessMessage }}
        </div>
      </div>
      
      <div *ngIf="errorMessage" class="error-message">
        {{ errorMessage }}
      </div>
    </div>
  </div>

  <!-- Video Meeting Interface (shown when joined) -->
  <div *ngIf="isJoined" class="meeting-interface">
    <!-- Room Status -->
    <div class="room-status">
      <div class="status-info">
        <div class="status-item">
          <strong>Room ID:</strong> {{ roomId }}
        </div>
        <div class="status-item">
          <strong>Your Role:</strong> {{ currentRole }}
        </div>
        <div class="status-item">
          <strong>Participants:</strong> {{ participants }}/2
        </div>
      </div>
      <div class="status-actions"></div>
    </div>

    <!-- Video Controls (top) - hidden in minimalist layout -->
    <div class="video-controls top-controls hide-mobile">
      <button (click)="leave()" class="btn btn-danger">Leave Meeting</button>
      <button (click)="toggleCamera()" class="btn" [ngClass]="isCameraOn ? 'btn-warning' : 'btn-success'">
        <span *ngIf="isCameraOn">📷 Turn Off Camera</span>
        <span *ngIf="!isCameraOn">📷 Turn On Camera</span>
      </button>
      <button (click)="refreshLocalVideo()" class="btn btn-info">🔄 Refresh Local Video</button>
      <button (click)="refreshRemoteStream()" class="btn btn-secondary">Refresh Remote Stream</button>
      <button (click)="debugRemoteStream()" class="btn btn-dark">🔍 Debug Remote</button>
      
      <!-- Face Scan Button - Only visible when patient is connected -->
      <button 
        *ngIf="remoteStream" 
        (click)="startFaceScan()" 
        class="btn btn-primary"
        [disabled]="isFaceScanning"
        title="Start face scan for patient health assessment"
      >
        <span *ngIf="!isFaceScanning">🔍 Start Face Scan</span>
        <span *ngIf="isFaceScanning">⏳ Scanning...</span>
      </button>
      
      <!-- Prescription Button - Only visible when patient is connected -->
      <button 
        *ngIf="remoteStream" 
        (click)="openPrescriptionModal()" 
        class="btn btn-success"
        title="Create prescription for patient"
      >
        💊 Write Prescription
      </button>
      
      <button 
        *ngIf="remoteStream" 
        (click)="openDiagnosisModal()" 
        class="btn btn-warning"
        title="Create diagnosis for patient"
      >
        🔍 Create Diagnosis
      </button>
      
      <button 
        *ngIf="remoteStream" 
        (click)="openLabRequestModal()" 
        class="btn btn-info"
        title="Request lab tests for patient"
      >
        🧪 Lab Request
      </button>
    </div>

    <!-- Video Container with Patient Details Sidebar -->
    <div class="meeting-layout" [class.sidebar-collapsed]="isSidebarCollapsed">
      <!-- Main Video Area -->
      <div class="video-container">
        <!-- Remote Video (main) -->
        <div class="video-wrapper remote-main">
          <h3>Remote Video (Patient)</h3>
          <div class="video-container-relative">
            <video 
              #remoteVideo 
              autoplay 
              playsinline
              class="video-element"
              *ngIf="remoteStream"
            ></video>
            
            <!-- Local Video (overlay preview) - positioned inside remote video -->
            <div class="video-wrapper local-preview">
              <div class="video-container-relative">
                <video 
                  #localVideo 
                  autoplay 
                  muted 
                  playsinline
                  class="video-element local-video"
                  *ngIf="localStream"
                ></video>
                <div *ngIf="!localStream && isJoined" class="video-loading">
                  <div class="loading-spinner"></div>
                  <p>Initializing camera...</p>
                </div>
                <div *ngIf="!isCameraOn && localStream" class="camera-off-overlay">
                  <p>Camera Off</p>
                </div>
              </div>
            </div>
            
            <!-- In-video overlay actions dropdown -->
            <div class="remote-overlay-actions" *ngIf="isJoined">
              <button class="overlay-toggle" (click)="toggleOverlayMenu()" title="More actions">⋮</button>
              <div class="overlay-menu" *ngIf="showOverlayMenu" (click)="closeOverlayMenu()">
                <button (click)="toggleCamera(); closeOverlayMenu()" class="btn btn-ghost">
                  <span *ngIf="isCameraOn">📷 Turn Off Camera</span>
                  <span *ngIf="!isCameraOn">📷 Turn On Camera</span>
                </button>
                <button (click)="toggleMicrophone(); closeOverlayMenu()" class="btn btn-ghost">
                  <span *ngIf="isMicrophoneOn">🎤 Turn Off Microphone</span>
                  <span *ngIf="!isMicrophoneOn">🎤 Turn On Microphone</span>
                </button>
                <button (click)="reinitializeAudio(); closeOverlayMenu()" class="btn btn-ghost">🎤 Fix Audio Echo</button>
                <button (click)="refreshRemoteStream(); closeOverlayMenu()" class="btn btn-ghost">Refresh Remote</button>
                <button (click)="refreshLocalVideo(); closeOverlayMenu()" class="btn btn-ghost">Refresh Local</button>
                <button (click)="debugRemoteStream(); closeOverlayMenu()" class="btn btn-ghost">Debug</button>
                <button 
                  *ngIf="remoteStream" 
                  (click)="startFaceScan(); closeOverlayMenu()" 
                  class="btn btn-ghost btn-primary"
                  [disabled]="isFaceScanning"
                  title="Start face scan for patient health assessment"
                >
                  <span *ngIf="!isFaceScanning">🔍 Face Scan</span>
                  <span *ngIf="isFaceScanning">⏳ Scanning...</span>
                </button>
                <button 
                  *ngIf="remoteStream" 
                  (click)="openPrescriptionModal(); closeOverlayMenu()" 
                  class="btn btn-ghost btn-success"
                  title="Create prescription for patient"
                >
                  💊 Prescription
                </button>
                <button 
                  *ngIf="remoteStream" 
                  (click)="openDiagnosisModal(); closeOverlayMenu()" 
                  class="btn btn-ghost btn-warning"
                  title="Create diagnosis for patient"
                >
                  🔍 Diagnosis
                </button>
              </div>
            </div>
            <!-- Bottom-center control group: Camera toggle, Microphone toggle, End Call, Actions dropdown -->
            <div class="remote-overlay-leave" *ngIf="isJoined">
              <div class="overlay-control-group">
                <!-- Camera toggle -->
                <button (click)="toggleCamera()" class="icon-btn icon-neutral" [attr.aria-label]="isCameraOn ? 'Turn off camera' : 'Turn on camera'" [title]="isCameraOn ? 'Turn off camera' : 'Turn on camera'">
                  <img class="icon-img" [src]="isCameraOn ? '/camera-on.png' : '/camera-off.png'" [alt]="isCameraOn ? 'Camera on' : 'Camera off'" />
                </button>

                <!-- Microphone toggle -->
                <button (click)="toggleMicrophone()" class="icon-btn icon-neutral" [attr.aria-label]="isMicrophoneOn ? 'Turn off microphone' : 'Turn on microphone'" [title]="isMicrophoneOn ? 'Turn off microphone' : 'Turn on microphone'">
                  <img class="icon-img" [src]="isMicrophoneOn ? '/mic.png' : '/mute.png'" [alt]="isMicrophoneOn ? 'Microphone on' : 'Microphone off'" />
                </button>

                <button (click)="leave()" class="icon-btn icon-danger" aria-label="End call" title="End call">
                  <img class="icon-img" src="/end-call.png" alt="End call" />
                </button>

                <!-- Actions dropdown: Face Scan, Prescription, Diagnosis -->
                <div class="end-actions-dropdown">
                  <button class="icon-btn icon-neutral" (click)="toggleEndActionsDropdown()" aria-label="More actions" title="More actions">
                    <img class="icon-img" src="/action.png" alt="Actions" />
                  </button>
                  <div class="end-actions-menu" *ngIf="showEndActionsDropdown">
                    <button 
                      *ngIf="remoteStream" 
                      (click)="startFaceScan(); closeEndActionsDropdown()" 
                      class="btn btn-ghost btn-primary"
                      [disabled]="isFaceScanning"
                      title="Start face scan for patient health assessment"
                    >
                      <span *ngIf="!isFaceScanning">🔍 Face Scan</span>
                      <span *ngIf="isFaceScanning">⏳ Scanning...</span>
                    </button>
                    <button 
                      *ngIf="remoteStream" 
                      (click)="openPrescriptionModal(); closeEndActionsDropdown()" 
                      class="btn btn-ghost btn-success"
                      title="Create prescription for patient"
                    >
                      💊 Prescription
                    </button>
                    <button 
                      *ngIf="remoteStream" 
                      (click)="openDiagnosisModal(); closeEndActionsDropdown()" 
                      class="btn btn-ghost btn-warning"
                      title="Create diagnosis for patient"
                    >
                      🔍 Diagnosis
                    </button>
                    <button 
                      *ngIf="remoteStream" 
                      (click)="openLabRequestModal(); closeEndActionsDropdown()" 
                      class="btn btn-ghost btn-info"
                      title="Request lab tests for patient"
                    >
                      🧪 Lab Request
                    </button>
                    <button 
                      *ngIf="remoteStream" 
                      (click)="openScheduleModal(); closeEndActionsDropdown()" 
                      class="btn btn-ghost"
                      title="Schedule patient to another doctor"
                    >
                      📅 Schedule to Another Doctor
                    </button>
                  </div>
                </div>
                <!-- Show Patient Details button when sidebar is collapsed -->
                <button 
                  *ngIf="isSidebarCollapsed" 
                  class="icon-btn icon-neutral" 
                  (click)="toggleSidebar()" 
                  aria-label="Show patient details" 
                  title="Patient Details"
                >
                  👤
                </button>
              </div>
            </div>
            <div *ngIf="!remoteStream" class="waiting-message">
              <p>Waiting for patient to join...</p>
              <!-- Debug connection status -->
              <div class="connection-status-debug" *ngIf="!remoteStream">
                <details>
                  <summary>🔧 Connection Debug (Click to expand)</summary>
                  <div class="debug-info">
                    <p><strong>Room:</strong> {{ roomId }}</p>
                    <p><strong>Status:</strong> {{ getConnectionStatus() }}</p>
                  </div>
                </details>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Patient Details Backdrop for mobile -->
      <div class="patient-details-backdrop" *ngIf="isJoined && !isSidebarCollapsed" (click)="toggleSidebar()"></div>
      
      <!-- Patient Details Sidebar -->
      <div class="patient-details-sidebar" *ngIf="isJoined && !isSidebarCollapsed" (click)="$event.stopPropagation()">
        
        <div class="patient-details-header">
          <h3>👤 Patient Details</h3>
          <div class="header-actions">
            <button 
              class="btn btn-sm btn-outline-secondary" 
              (click)="toggleSidebar()"
              title="Collapse sidebar"
            >
              ⤢
            </button>
          </div>
          <button 
            class="btn btn-sm btn-outline-secondary" 
            (click)="refreshPatientDetails()"
            title="Refresh patient information"
          >
            🔄
          </button>
        </div>
        
        <div class="patient-details-content">
          <!-- Patient Basic Information -->
          <div class="patient-section" *ngIf="patientDetails">
            <h4>Basic Information</h4>
            <div class="patient-info-grid">
              <div class="info-item">
                <span class="info-label">Name:</span>
                <span class="info-value">{{ patientDetails.fullName || 'Unknown' }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Age:</span>
                <span class="info-value">{{ getPatientAge() || 'Not specified' }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Gender:</span>
                <span class="info-value">{{ patientDetails.gender || 'Not specified' }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Height:</span>
                <span class="info-value">{{ patientDetails.height ? patientDetails.height + ' cm' : 'Not specified' }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Weight:</span>
                <span class="info-value">{{ patientDetails.weight ? patientDetails.weight + ' kg' : 'Not specified' }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Blood Type:</span>
                <span class="info-value">{{ patientDetails.bloodType || 'Not specified' }}</span>
              </div>
            </div>
          </div>

          <!-- Medical Information -->
          <div class="patient-section" *ngIf="patientDetails">
            <h4>Medical Information</h4>
            <div class="patient-info-grid">
              <div class="info-item">
                <span class="info-label">Allergies:</span>
                <span class="info-value">{{ patientDetails.allergies || 'None reported' }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Medications:</span>
                <span class="info-value">{{ patientDetails.medications || 'None' }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Medical History:</span>
                <span class="info-value">{{ patientDetails.medicalHistory || 'None reported' }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Mobile Video Controls (shown below video on mobile) -->
      <div class="mobile-video-controls" *ngIf="isJoined">
        <div class="overlay-control-group">
          <!-- Camera toggle -->
          <button (click)="toggleCamera()" class="icon-btn icon-neutral" [attr.aria-label]="isCameraOn ? 'Turn off camera' : 'Turn on camera'" [title]="isCameraOn ? 'Turn off camera' : 'Turn on camera'">
            <img class="icon-img" [src]="isCameraOn ? '/camera-on.png' : '/camera-off.png'" [alt]="isCameraOn ? 'Camera on' : 'Camera off'" />
          </button>

          <!-- Microphone toggle -->
          <button (click)="toggleMicrophone()" class="icon-btn icon-neutral" [attr.aria-label]="isMicrophoneOn ? 'Turn off microphone' : 'Turn on microphone'" [title]="isMicrophoneOn ? 'Turn off microphone' : 'Turn on microphone'">
            <img class="icon-img" [src]="isMicrophoneOn ? '/mic.png' : '/mute.png'" [alt]="isMicrophoneOn ? 'Microphone on' : 'Microphone off'" />
          </button>

          <!-- End Call -->
          <button (click)="leave()" class="icon-btn icon-danger" aria-label="End call" title="End call">
            <img class="icon-img" src="/end-call.png" alt="End call" />
          </button>

          <!-- Actions dropdown -->
          <div class="end-actions-dropdown">
            <button class="icon-btn icon-neutral" (click)="toggleEndActionsDropdown()" aria-label="More actions" title="More actions">
              <img class="icon-img" src="/action.png" alt="Actions" />
            </button>
            <div class="end-actions-menu" *ngIf="showEndActionsDropdown">
              <button 
                *ngIf="remoteStream" 
                (click)="startFaceScan(); closeEndActionsDropdown()" 
                class="btn btn-ghost btn-primary"
                [disabled]="isFaceScanning"
                title="Start face scan for patient health assessment"
              >
                <span *ngIf="!isFaceScanning">🔍 Face Scan</span>
                <span *ngIf="isFaceScanning">⏳ Scanning...</span>
              </button>
              <button 
                *ngIf="remoteStream" 
                (click)="openPrescriptionModal(); closeEndActionsDropdown()" 
                class="btn btn-ghost btn-success"
                title="Create prescription for patient"
              >
                💊 Prescription
              </button>
              <button 
                *ngIf="remoteStream" 
                (click)="openDiagnosisModal(); closeEndActionsDropdown()" 
                class="btn btn-ghost btn-warning"
                title="Create diagnosis for patient"
              >
                🔍 Diagnosis
              </button>
              <button 
                *ngIf="remoteStream" 
                (click)="openLabRequestModal(); closeEndActionsDropdown()" 
                class="btn btn-ghost btn-info"
                title="Request lab tests for patient"
              >
                🧪 Lab Request
              </button>
              <button 
                *ngIf="remoteStream" 
                (click)="openScheduleModal(); closeEndActionsDropdown()" 
                class="btn btn-ghost"
                title="Schedule patient to another doctor"
              >
                📅 Schedule to Another Doctor
              </button>
            </div>
          </div>
          
          <!-- Show Patient Details button when sidebar is collapsed -->
          <button 
            *ngIf="isSidebarCollapsed" 
            class="icon-btn icon-neutral" 
            (click)="toggleSidebar()" 
            aria-label="Show patient details" 
            title="Patient Details"
          >
            👤
          </button>
        </div>
      </div>
      
    </div>
  </div>

  <!-- Face Scan Modal -->
  <div *ngIf="showFaceScanModal" class="face-scan-modal">
    <div class="face-scan-modal-content">
      <div class="face-scan-header">
        <h3>{{ isFaceScanComplete ? 'Face Scan Complete!' : 'Face Scan in Progress' }}</h3>
        <button (click)="closeFaceScanModal()" class="btn-close">&times;</button>
      </div>
      
      <!-- Status only shown during scanning, not when complete -->
      <div *ngIf="!isFaceScanComplete" class="face-scan-status">
        <p>{{ faceScanStatus }}</p>
      </div>
      
      <!-- Face Scan iframe (only show when scanning, not when complete) -->
      <div *ngIf="faceScanIframeUrl && !isFaceScanComplete" class="face-scan-iframe-container">
        <iframe
          #faceScanIframe
          [src]="faceScanIframeUrl"
          title="Face Scan Interface"
          allow="camera; microphone"
          class="face-scan-iframe"
        ></iframe>
      </div>
      
      <!-- Scan Results (only show when complete) -->
      <div *ngIf="isFaceScanComplete && faceScanResults" class="scan-results">
        <div class="results-header">
          <h4>✅ Face Scan Complete!</h4>
          <button 
            (click)="showRawResults = !showRawResults" 
            class="btn btn-sm btn-outline-secondary"
            title="Toggle between formatted and raw results"
          >
            {{ showRawResults ? 'Show Formatted' : 'Show Raw Data' }}
          </button>
        </div>
        <div class="results-content">
          <div *ngIf="!showRawResults">
            <app-health-report-display [results]="faceScanResults"></app-health-report-display>
          </div>
          <div *ngIf="showRawResults">
            <h5>Raw JSON Data</h5>
            <pre>{{ faceScanResults | json }}</pre>
          </div>
        </div>
      </div>
      
      <div class="face-scan-actions">
        <button 
          *ngIf="!isFaceScanComplete" 
          (click)="closeFaceScanModal()" 
          class="btn btn-secondary"
        >
          Cancel Scan
        </button>
        <button 
          (click)="closeFaceScanModal()" 
          class="btn btn-primary"
        >
          {{ isFaceScanComplete ? 'Close' : 'Cancel' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Prescription Modal -->
  <div *ngIf="showPrescriptionModal" class="prescription-modal">
    <div class="prescription-modal-content">
      <div class="prescription-header">
        <h3>💊 Write Prescription</h3>
        <button (click)="closePrescriptionModal()" class="btn-close">&times;</button>
      </div>
      
      <form (ngSubmit)="submitPrescription()" class="prescription-form">
        <!-- Error Message -->
        <div *ngIf="prescriptionError" class="alert alert-error">
          {{ prescriptionError }}
        </div>
        
        <!-- Success Message -->
        <div *ngIf="prescriptionSuccess" class="alert alert-success">
          {{ prescriptionSuccess }}
        </div>
        
        <!-- Patient and Consultation Info Display -->
        <div class="consultation-info">
          <div class="info-item">
            <strong>Patient:</strong> 
            <span [class.loading]="getCurrentPatientName() === 'Patient Name Loading...'"
                  [class.no-patient]="getCurrentPatientName() === 'No Patient Connected'">
              {{ getCurrentPatientName() }}
            </span>
            <span *ngIf="getCurrentPatientName() === 'Patient Name Loading...'" class="loading-spinner">⏳</span>
          </div>
          <div class="info-item" *ngIf="currentConsultation">
            <strong>Consultation ID:</strong> {{ currentConsultation.id }}
          </div>
          <div class="info-item" *ngIf="!currentConsultation && consultationId">
            <strong>Consultation ID:</strong> {{ consultationId }} (Creating...)
          </div>
          <div class="info-item" *ngIf="!currentConsultation && !consultationId">
            <strong>Consultation ID:</strong> Not Available
          </div>
        </div>

        <!-- Multiple Prescription Forms -->
        <div *ngFor="let form of prescriptionForms; let i = index" class="prescription-form-item">
          <div class="prescription-form-header">
            <h4>Prescription {{ i + 1 }}</h4>
            <button 
              *ngIf="prescriptionForms.length > 1" 
              type="button" 
              (click)="removePrescriptionForm(i)" 
              class="btn-remove-prescription"
              title="Remove this prescription"
            >
              ✕
            </button>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label [for]="'medicationName' + i">Medication Name *</label>
              <input 
                type="text" 
                [id]="'medicationName' + i"
                [(ngModel)]="form.medicationName" 
                [name]="'medicationName' + i"
                class="form-control"
                placeholder="e.g., Amoxicillin"
                required
              >
            </div>
            
            <div class="form-group">
              <!-- Empty div for layout balance -->
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label [for]="'dosage' + i">Dosage *</label>
              <input 
                type="text" 
                [id]="'dosage' + i"
                [(ngModel)]="form.dosage" 
                [name]="'dosage' + i"
                class="form-control"
                placeholder="e.g., 500mg"
                required
              >
            </div>
            
            <div class="form-group">
              <label [for]="'frequency' + i">Frequency *</label>
              <select 
                [id]="'frequency' + i"
                [(ngModel)]="form.frequency" 
                [name]="'frequency' + i"
                class="form-control"
                required
              >
                <option value="">Select frequency</option>
                <option value="Once daily">Once daily</option>
                <option value="Twice daily">Twice daily</option>
                <option value="Three times daily">Three times daily</option>
                <option value="Four times daily">Four times daily</option>
                <option value="Every 6 hours">Every 6 hours</option>
                <option value="Every 8 hours">Every 8 hours</option>
                <option value="Every 12 hours">Every 12 hours</option>
                <option value="As needed">As needed</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label [for]="'duration' + i">Duration *</label>
              <input 
                type="text" 
                [id]="'duration' + i"
                [(ngModel)]="form.duration" 
                [name]="'duration' + i"
                class="form-control"
                placeholder="e.g., 7 days, 2 weeks"
                required
              >
            </div>
            
            <div class="form-group">
              <label [for]="'quantity' + i">Quantity</label>
              <input 
                type="number" 
                [id]="'quantity' + i"
                [(ngModel)]="form.quantity" 
                [name]="'quantity' + i"
                class="form-control"
                placeholder="e.g., 30"
                min="1"
              >
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label [for]="'refills' + i">Refills</label>
              <input 
                type="number" 
                [id]="'refills' + i"
                [(ngModel)]="form.refills" 
                [name]="'refills' + i"
                class="form-control"
                placeholder="0"
                min="0"
              >
            </div>
            
            <div class="form-group">
              <label [for]="'prescribedAt' + i">Prescribed Date</label>
              <input 
                type="datetime-local" 
                [id]="'prescribedAt' + i"
                [(ngModel)]="form.prescribedAt" 
                [name]="'prescribedAt' + i"
                class="form-control"
              >
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label [for]="'expiresAt' + i">Expiration Date</label>
              <input 
                type="datetime-local" 
                [id]="'expiresAt' + i"
                [(ngModel)]="form.expiresAt" 
                [name]="'expiresAt' + i"
                class="form-control"
              >
            </div>
            
            <div class="form-group">
              <!-- Empty div for layout balance -->
            </div>
          </div>

          <div class="form-group">
            <label [for]="'instructions' + i">Instructions</label>
            <textarea 
              [id]="'instructions' + i"
              [(ngModel)]="form.instructions" 
              [name]="'instructions' + i"
              class="form-control"
              rows="3"
              placeholder="e.g., Take with food, avoid alcohol"
            ></textarea>
          </div>

          <div class="form-group">
            <label [for]="'notes' + i">Doctor's Notes</label>
            <textarea 
              [id]="'notes' + i"
              [(ngModel)]="form.notes" 
              [name]="'notes' + i"
              class="form-control"
              rows="2"
              placeholder="Additional notes about this prescription"
            ></textarea>
          </div>
        </div>

        <!-- Add Prescription Button -->
        <div class="add-prescription-section">
          <button 
            type="button" 
            (click)="addPrescriptionForm()" 
            class="btn btn-outline-primary"
          >
            ➕ Add Another Prescription
          </button>
        </div>

        <div class="prescription-actions">
          <button 
            type="button" 
            (click)="closePrescriptionModal()" 
            class="btn btn-secondary"
          >
            Cancel
          </button>
          <button 
            type="submit" 
            class="btn btn-success"
            [disabled]="isSubmittingPrescription"
          >
            <span *ngIf="!isSubmittingPrescription">💊 Submit Prescription(s)</span>
            <span *ngIf="isSubmittingPrescription">⏳ Submitting...</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Prescriptions List Modal (if needed) -->
  <div *ngIf="prescriptions.length > 0" class="prescriptions-list">
    <h4>Recent Prescriptions</h4>
    <div class="prescription-item" *ngFor="let prescription of prescriptions; let i = index">
      <div class="prescription-info">
        <strong>{{ prescription.medicationName }}</strong> - {{ prescription.dosage }}
        <br>
        <small>{{ prescription.frequency }} for {{ prescription.duration }}</small>
      </div>
      <div class="prescription-actions">
        <button (click)="editPrescription(i)" class="btn btn-sm btn-outline-primary">Edit</button>
        <button (click)="deletePrescription(i)" class="btn btn-sm btn-outline-danger">Delete</button>
      </div>
    </div>
  </div>

  <!-- Diagnosis Modal -->
  <div *ngIf="showDiagnosisModal" class="diagnosis-modal">
    <div class="diagnosis-modal-content">
      <div class="diagnosis-header">
        <h3>🔍 Create Diagnosis</h3>
        <button (click)="closeDiagnosisModal()" class="btn-close">&times;</button>
      </div>
      
      <form (ngSubmit)="submitDiagnosis()" class="diagnosis-form">
        <!-- Error Message -->
        <div *ngIf="diagnosisError" class="alert alert-error">
          {{ diagnosisError }}
        </div>
        
        <!-- Success Message -->
        <div *ngIf="diagnosisSuccess" class="alert alert-success">
          {{ diagnosisSuccess }}
        </div>
        
        <!-- Patient and Consultation Info Display -->
        <div class="consultation-info">
          <div class="info-item">
            <strong>Patient:</strong> 
            <span [class.no-patient]="getCurrentPatientName() === 'No Patient Connected'">
              {{ getCurrentPatientName() }}
            </span>
          </div>
          <div class="info-item" *ngIf="currentConsultation">
            <strong>Consultation ID:</strong> {{ currentConsultation.id }}
          </div>
          <div class="info-item" *ngIf="!currentConsultation && consultationId">
            <strong>Consultation ID:</strong> {{ consultationId }} (Creating...)
          </div>
          <div class="info-item" *ngIf="!currentConsultation && !consultationId">
            <strong>Consultation ID:</strong> Not Available
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="diagnosisName">Diagnosis Name *</label>
            <input 
              type="text" 
              id="diagnosisName"
              [(ngModel)]="diagnosisForm.diagnosisName" 
              name="diagnosisName"
              class="form-control"
              placeholder="e.g., Hypertension, Diabetes Type 2"
              required
            >
          </div>
          
          <div class="form-group">
            <label for="diagnosisCode">Diagnosis Code</label>
            <input 
              type="text" 
              id="diagnosisCode"
              [(ngModel)]="diagnosisForm.diagnosisCode" 
              name="diagnosisCode"
              class="form-control"
              placeholder="e.g., I10, E11"
            >
          </div>
        </div>

        <div class="form-group">
          <label for="description">Description</label>
          <textarea 
            id="description"
            [(ngModel)]="diagnosisForm.description" 
            name="description"
            class="form-control"
            rows="3"
            placeholder="Detailed description of the diagnosis"
          ></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="severity">Severity *</label>
            <select 
              id="severity"
              [(ngModel)]="diagnosisForm.severity" 
              name="severity"
              class="form-control"
              required
            >
              <option [value]="DiagnosisSeverity.MILD">Mild</option>
              <option [value]="DiagnosisSeverity.MODERATE">Moderate</option>
              <option [value]="DiagnosisSeverity.SEVERE">Severe</option>
              <option [value]="DiagnosisSeverity.CRITICAL">Critical</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="status">Status *</label>
            <select 
              id="status"
              [(ngModel)]="diagnosisForm.status" 
              name="status"
              class="form-control"
              required
            >
              <option [value]="DiagnosisStatus.ACTIVE">Active</option>
              <option [value]="DiagnosisStatus.RESOLVED">Resolved</option>
              <option [value]="DiagnosisStatus.CHRONIC">Chronic</option>
              <option [value]="DiagnosisStatus.SUSPECTED">Suspected</option>
              <option [value]="DiagnosisStatus.RULED_OUT">Ruled Out</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="onsetDate">Onset Date</label>
            <input 
              type="date" 
              id="onsetDate"
              [(ngModel)]="diagnosisForm.onsetDate" 
              name="onsetDate"
              class="form-control"
            >
          </div>
          
          <div class="form-group">
            <label for="resolvedAt">Resolved Date</label>
            <input 
              type="date" 
              id="resolvedAt"
              [(ngModel)]="diagnosisForm.resolvedAt" 
              name="resolvedAt"
              class="form-control"
            >
          </div>
        </div>

        <div class="form-group">
          <label for="notes">Notes</label>
          <textarea 
            id="notes"
            [(ngModel)]="diagnosisForm.notes" 
            name="notes"
            class="form-control"
            rows="2"
            placeholder="Additional notes about this diagnosis"
          ></textarea>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input 
              type="checkbox" 
              [(ngModel)]="diagnosisForm.isPrimary" 
              name="isPrimary"
            >
            <span class="checkmark"></span>
            Primary Diagnosis
          </label>
        </div>

        <div class="diagnosis-actions">
          <button 
            type="button" 
            (click)="closeDiagnosisModal()" 
            class="btn btn-secondary"
          >
            Cancel
          </button>
          <button 
            type="submit" 
            class="btn btn-warning"
            [disabled]="isSubmittingDiagnosis"
          >
            <span *ngIf="!isSubmittingDiagnosis">🔍 Submit Diagnosis</span>
            <span *ngIf="isSubmittingDiagnosis">⏳ Submitting...</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Diagnoses List Modal (if needed) -->
  <div *ngIf="diagnoses.length > 0" class="diagnoses-list">
    <h4>Recent Diagnoses</h4>
    <div class="diagnosis-item" *ngFor="let diagnosis of diagnoses; let i = index">
      <div class="diagnosis-info">
        <strong>{{ diagnosis.diagnosisName }}</strong> - {{ diagnosis.severity }}
        <br>
        <small>{{ diagnosis.status }} | {{ diagnosis.diagnosedAt | date:'short' }}</small>
      </div>
      <div class="diagnosis-actions">
        <button (click)="editDiagnosis(i)" class="btn btn-sm btn-outline-primary">Edit</button>
        <button (click)="deleteDiagnosis(i)" class="btn btn-sm btn-outline-danger">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- Lab Request Modal -->
<div *ngIf="showLabRequestModal" class="lab-request-modal">
  <div class="lab-request-modal-content">
    <div class="lab-request-header">
      <h3>🧪 Lab Request</h3>
      <button (click)="closeLabRequestModal()" class="btn-close">&times;</button>
    </div>
    
    <form (ngSubmit)="submitLabRequest()" class="lab-request-form">
      <!-- Error Message -->
      <div *ngIf="labRequestError" class="alert alert-error">
        {{ labRequestError }}
      </div>
      
      <!-- Success Message -->
      <div *ngIf="labRequestSuccess" class="alert alert-success">
        {{ labRequestSuccess }}
      </div>

      <!-- Patient and Consultation Info Display -->
      <div class="consultation-info">
        <div class="info-item">
          <strong>Patient:</strong> 
          <span [class.no-patient]="getCurrentPatientName() === 'No Patient Connected'">
            {{ getCurrentPatientName() }}
          </span>
        </div>
        <div class="info-item" *ngIf="currentConsultation">
          <strong>Consultation ID:</strong> {{ currentConsultation.id }}
        </div>
        <div class="info-item" *ngIf="!currentConsultation && consultationId">
          <strong>Consultation ID:</strong> {{ consultationId }} (Creating...)
        </div>
        <div class="info-item" *ngIf="!currentConsultation && !consultationId">
          <strong>Consultation ID:</strong> Not Available
        </div>
      </div>

      <div class="form-group full-width">
        <label for="organizationId">Organization *</label>
        <select 
          id="organizationId"
          [(ngModel)]="labRequestForm.organizationId" 
          name="organizationId"
          class="form-control"
          required
          (change)="onLabRequestOrganizationChange()"
        >
          <option value="">Select Organization</option>
          <option *ngFor="let org of organizations" [value]="org.id">{{ org.name }}</option>
        </select>
      </div>

      <div class="form-group full-width">
        <label for="doctorId">Doctor *</label>
        <select 
          id="doctorId"
          [(ngModel)]="labRequestForm.doctorId" 
          name="doctorId"
          class="form-control"
          required
          [disabled]="!labRequestForm.organizationId"
        >
          <option value="">Select Doctor</option>
          <option *ngFor="let doctor of availableDoctors" [value]="doctor.id">
            {{ doctor.firstName }} {{ doctor.lastName }} - {{ doctor.specialization }}
          </option>
        </select>
      </div>

      <div class="form-group full-width">
        <label for="priority">Priority</label>
        <select 
          id="priority"
          [(ngModel)]="labRequestForm.priority" 
          name="priority"
          class="form-control"
        >
          <option [value]="LabRequestPriority.LOW">Low</option>
          <option [value]="LabRequestPriority.NORMAL">Normal</option>
          <option [value]="LabRequestPriority.HIGH">High</option>
          <option [value]="LabRequestPriority.URGENT">Urgent</option>
        </select>
      </div>

      <div class="form-group full-width">
        <label for="requestedTests">Requested Tests</label>
        <textarea 
          id="requestedTests"
          [(ngModel)]="labRequestForm.requestedTests" 
          name="requestedTests"
          class="form-control"
          rows="3"
          placeholder="List the specific lab tests requested (e.g., Complete Blood Count, Lipid Panel, etc.)"
        ></textarea>
      </div>

      <div class="form-group full-width">
        <label for="instructions">Instructions</label>
        <textarea 
          id="instructions"
          [(ngModel)]="labRequestForm.instructions" 
          name="instructions"
          class="form-control"
          rows="2"
          placeholder="Special instructions for the lab (e.g., fasting required, urgent processing, etc.)"
        ></textarea>
      </div>

      <div class="form-group full-width">
        <label for="note">Notes</label>
        <textarea 
          id="note"
          [(ngModel)]="labRequestForm.note" 
          name="note"
          class="form-control"
          rows="3"
          placeholder="Additional notes about the lab request..."
        ></textarea>
      </div>

      <div class="lab-request-actions">
        <button 
          type="button" 
          (click)="closeLabRequestModal()" 
          class="btn btn-secondary"
        >
          Cancel
        </button>
        <button 
          type="submit" 
          class="btn btn-info" 
          [disabled]="!isLabRequestFormValid() || isSubmittingLabRequest"
        >
          <span *ngIf="!isSubmittingLabRequest">🧪 Submit Lab Request</span>
          <span *ngIf="isSubmittingLabRequest">⏳ Submitting...</span>
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Schedule to Another Doctor Modal -->
<div *ngIf="showScheduleModal" class="schedule-modal">
  <div class="schedule-modal-content">
    <div class="schedule-header">
      <h3>📅 Schedule to Another Doctor</h3>
      <button (click)="closeScheduleModal()" class="btn-close">&times;</button>
    </div>
    
    <form (ngSubmit)="submitSchedule()" class="schedule-form">
      <div *ngIf="scheduleError" class="alert alert-error">
        {{ scheduleError }}
      </div>
      
      <div *ngIf="scheduleSuccess" class="alert alert-success">
        {{ scheduleSuccess }}
      </div>
      
      <!-- Patient Info Display -->
      <div class="patient-info">
        <div class="info-item">
          <strong>Patient:</strong> 
          <span [class.no-patient]="getCurrentPatientName() === 'No Patient Connected'">
            {{ getCurrentPatientName() }}
          </span>
        </div>
        <div class="info-item" *ngIf="currentConsultation">
          <strong>Consultation ID:</strong> {{ currentConsultation.id }}
        </div>
        <div class="info-item" *ngIf="!currentConsultation && consultationId">
          <strong>Consultation ID:</strong> {{ consultationId }} (Creating...)
        </div>
        <div class="info-item" *ngIf="!currentConsultation && !consultationId">
          <strong>Consultation ID:</strong> Not Available
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="organizationId">Organization *</label>
          <select 
            id="organizationId"
            [(ngModel)]="scheduleForm.organizationId" 
            name="organizationId"
            class="form-control"
            required
            (change)="onOrganizationChange()"
          >
            <option value="">Select Organization</option>
            <option *ngFor="let org of organizations" [value]="org.id">{{ org.name }}</option>
          </select>
        </div>

        <div class="form-group">
          <label for="doctorId">Doctor *</label>
          <select 
            id="doctorId"
            [(ngModel)]="scheduleForm.doctorId" 
            name="doctorId"
            class="form-control"
            required
            [disabled]="!scheduleForm.organizationId"
          >
            <option value="">Select Doctor</option>
            <option *ngFor="let doctor of availableDoctors" [value]="doctor.id">
              {{ doctor.firstName }} {{ doctor.lastName }} - {{ doctor.specialization }}
            </option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="appointmentDate">Date *</label>
          <input 
            type="date" 
            id="appointmentDate"
            [(ngModel)]="scheduleForm.appointmentDate" 
            name="appointmentDate"
            class="form-control"
            required
            [min]="getMinDate()"
          >
        </div>

        <div class="form-group">
          <label for="appointmentTime">Time *</label>
          <input 
            type="time" 
            id="appointmentTime"
            [(ngModel)]="scheduleForm.appointmentTime" 
            name="appointmentTime"
            class="form-control"
            required
          >
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          
        </div>

        <div class="form-group">
          <label for="priority">Priority</label>
          <select 
            id="priority"
            [(ngModel)]="scheduleForm.priority" 
            name="priority"
            class="form-control"
          >
            <option value="NORMAL">Normal</option>
            <option value="HIGH">High</option>
            <option value="URGENT">Urgent</option>
            <option value="LOW">Low</option>
          </select>
        </div>
      </div>

      <div class="form-group full-width">
        <label for="notes">Notes</label>
        <textarea 
          id="notes"
          [(ngModel)]="scheduleForm.notes" 
          name="notes"
          class="form-control"
          rows="3"
          placeholder="Additional notes for the appointment..."
        ></textarea>
      </div>

      <div class="schedule-actions">
        <button type="button" (click)="closeScheduleModal()" class="btn btn-secondary">Cancel</button>
        <button type="submit" class="btn btn-primary" [disabled]="!isScheduleFormValid()">
          📅 Schedule Appointment
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Notification Toast -->
<div *ngIf="showNotification" class="notification-toast" [ngClass]="'notification-' + notificationType">
  <div class="notification-content">
    <div class="notification-icon">
      <span *ngIf="notificationType === 'success'">✅</span>
      <span *ngIf="notificationType === 'error'">❌</span>
      <span *ngIf="notificationType === 'info'">ℹ️</span>
    </div>
    <div class="notification-message">
      <h4>{{ notificationMessage }}</h4>
    </div>
    <div class="notification-actions">
      <button (click)="hideNotification()" class="btn btn-sm btn-secondary">Dismiss</button>
    </div>
  </div>
</div>
