<div class="schedule-page">
  <div class="top-actions">
    <button class="btn btn-ghost" (click)="openAvailabilityModal()">
      <span class="icon-calendar">üìÖ</span>
      Manage Weekly Availability
    </button>
  </div>
  <h2>All Appointments</h2>
  
  <!-- Pending Appointments -->
  <div class="card" *ngIf="getPendingRequests().length > 0">
    <h3>Pending Requests</h3>
    
    <!-- Desktop Table View -->
    <table class="requests-table">
      <thead>
        <tr>
          <th>Request ID</th>
          <th>Patient</th>
          <th>Reason</th>
          <th>Requested</th>
          <th>Start</th>
          <th>End</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let r of paginatedPendingRequests">
          <td>{{ r.id }}</td>
          <td>{{ r.patient }}</td>
          <td>{{ r.reason }}</td>
          <td>{{ r.requestedAt | date:'MMM d, y, h:mm a' }}</td>
          <td>{{ r.start | date:'MMM d, y, h:mm a' }}</td>
          <td>{{ r.end | date:'MMM d, y, h:mm a' }}</td>
          <td>
            <span class="badge" [ngClass]="r.status">{{ r.status }}</span>
          </td>
          <td>
            <div class="row-actions">
              <button class="btn btn-accept" (click)="accept(r)">Accept</button>
              <button class="btn btn-reject" (click)="reject(r)">Reject</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Mobile Card View -->
    <div class="mobile-cards">
      <div class="mobile-card" *ngFor="let r of paginatedPendingRequests">
        <div class="mobile-card-header">
          <div class="mobile-card-id">Request #{{ r.id }}</div>
          <div class="mobile-card-status">
            <span class="badge" [ngClass]="r.status">{{ r.status }}</span>
          </div>
        </div>
        <div class="mobile-card-content">
          <div class="mobile-card-row">
            <span class="mobile-card-label">Patient:</span>
            <span class="mobile-card-value">{{ r.patient }}</span>
          </div>
          <div class="mobile-card-row">
            <span class="mobile-card-label">Reason:</span>
            <span class="mobile-card-value">{{ r.reason }}</span>
          </div>
          <div class="mobile-card-row">
            <span class="mobile-card-label">Requested:</span>
            <span class="mobile-card-value">{{ r.requestedAt | date:'MMM d, h:mm a' }}</span>
          </div>
          <div class="mobile-card-row">
            <span class="mobile-card-label">Start:</span>
            <span class="mobile-card-value">{{ r.start | date:'MMM d, h:mm a' }}</span>
          </div>
          <div class="mobile-card-row">
            <span class="mobile-card-label">End:</span>
            <span class="mobile-card-value">{{ r.end | date:'MMM d, h:mm a' }}</span>
          </div>
        </div>
        <div class="mobile-card-actions">
          <button class="btn btn-accept" (click)="accept(r)">Accept</button>
          <button class="btn btn-reject" (click)="reject(r)">Reject</button>
        </div>
      </div>
    </div>
    
    <!-- Pagination Controls for Pending Requests -->
    <div class="pagination-container" *ngIf="pendingTotalPages > 1">
      <div class="pagination-info">
        Showing {{ (pendingCurrentPage - 1) * pendingItemsPerPage + 1 }} to {{ getPendingEndIndex() }} of {{ getPendingRequests().length }} pending requests
      </div>
      <div class="pagination-controls">
        <button 
          class="btn btn-ghost pagination-btn" 
          (click)="previousPendingPage()" 
          [disabled]="pendingCurrentPage === 1"
          title="Previous page">
          ‚Äπ
        </button>
        
        <button 
          *ngFor="let page of getPendingPageNumbers()" 
          class="btn pagination-btn" 
          [class.btn-active]="page === pendingCurrentPage"
          [class.btn-ghost]="page !== pendingCurrentPage"
          (click)="goToPendingPage(page)">
          {{ page }}
        </button>
        
        <button 
          class="btn btn-ghost pagination-btn" 
          (click)="nextPendingPage()" 
          [disabled]="pendingCurrentPage === pendingTotalPages"
          title="Next page">
          ‚Ä∫
        </button>
      </div>
    </div>
  </div>

  <!-- Confirmed Appointments -->
  <div class="card" *ngIf="getConfirmedRequests().length > 0">
    <h3>Confirmed Appointments</h3>
    
    <!-- Desktop Table View -->
    <table class="requests-table">
      <thead>
        <tr>
          <th>Request ID</th>
          <th>Patient</th>
          <th>Reason</th>
          <th>Requested</th>
          <th>Start</th>
          <th>End</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let r of paginatedConfirmedRequests">
          <td>{{ r.id }}</td>
          <td>{{ r.patient }}</td>
          <td>{{ r.reason }}</td>
          <td>{{ r.requestedAt | date:'MMM d, y, h:mm a' }}</td>
          <td>{{ r.start | date:'MMM d, y, h:mm a' }}</td>
          <td>{{ r.end | date:'MMM d, y, h:mm a' }}</td>
          <td>
            <span class="badge" [ngClass]="r.status">{{ r.status }}</span>
          </td>
          <td>
            <span class="confirmed-text">‚úì Confirmed</span>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Mobile Card View -->
    <div class="mobile-cards">
      <div class="mobile-card" *ngFor="let r of paginatedConfirmedRequests">
        <div class="mobile-card-header">
          <div class="mobile-card-id">Request #{{ r.id }}</div>
          <div class="mobile-card-status">
            <span class="badge" [ngClass]="r.status">{{ r.status }}</span>
          </div>
        </div>
        <div class="mobile-card-content">
          <div class="mobile-card-row">
            <span class="mobile-card-label">Patient:</span>
            <span class="mobile-card-value">{{ r.patient }}</span>
          </div>
          <div class="mobile-card-row">
            <span class="mobile-card-label">Reason:</span>
            <span class="mobile-card-value">{{ r.reason }}</span>
          </div>
          <div class="mobile-card-row">
            <span class="mobile-card-label">Requested:</span>
            <span class="mobile-card-value">{{ r.requestedAt | date:'MMM d, h:mm a' }}</span>
          </div>
          <div class="mobile-card-row">
            <span class="mobile-card-label">Start:</span>
            <span class="mobile-card-value">{{ r.start | date:'MMM d, h:mm a' }}</span>
          </div>
          <div class="mobile-card-row">
            <span class="mobile-card-label">End:</span>
            <span class="mobile-card-value">{{ r.end | date:'MMM d, h:mm a' }}</span>
          </div>
        </div>
        <div class="mobile-card-actions">
          <span class="confirmed-text">‚úì Confirmed</span>
        </div>
      </div>
    </div>
    
    <!-- Pagination Controls for Confirmed Requests -->
    <div class="pagination-container" *ngIf="confirmedTotalPages > 1">
      <div class="pagination-info">
        Showing {{ (confirmedCurrentPage - 1) * confirmedItemsPerPage + 1 }} to {{ getConfirmedEndIndex() }} of {{ getConfirmedRequests().length }} confirmed appointments
      </div>
      <div class="pagination-controls">
        <button 
          class="btn btn-ghost pagination-btn" 
          (click)="previousConfirmedPage()" 
          [disabled]="confirmedCurrentPage === 1"
          title="Previous page">
          ‚Äπ
        </button>
        
        <button 
          *ngFor="let page of getConfirmedPageNumbers()" 
          class="btn pagination-btn" 
          [class.btn-active]="page === confirmedCurrentPage"
          [class.btn-ghost]="page !== confirmedCurrentPage"
          (click)="goToConfirmedPage(page)">
          {{ page }}
        </button>
        
        <button 
          class="btn btn-ghost pagination-btn" 
          (click)="nextConfirmedPage()" 
          [disabled]="confirmedCurrentPage === confirmedTotalPages"
          title="Next page">
          ‚Ä∫
        </button>
      </div>
    </div>
  </div>

  <div class="calendar-header">
    <h3>{{ current | date:'MMMM y' }}</h3>
    <div class="calendar-nav">
      <button class="btn btn-ghost" (click)="prevMonth()">‚Äπ</button>
      <button class="btn btn-ghost" (click)="nextMonth()">‚Ä∫</button>
    </div>
  </div>

  <div class="calendar card">
    <div class="calendar-grid">
      <div class="dow" *ngFor="let d of ['Mon','Tue','Wed','Thu','Fri','Sat','Sun']">{{ d }}</div>
      <ng-container *ngFor="let week of weeks">
        <div class="day" *ngFor="let c of week" [class.out]="!c.inMonth" [class.appt]="c.hasAppt">
          <span class="num">{{ c.date.getDate() }}</span>
        </div>
      </ng-container>
    </div>
  </div>

  <div class="modal-backdrop" *ngIf="showAvailabilityModal" (click)="closeAvailabilityModal()"></div>
  <div class="modal" *ngIf="showAvailabilityModal" role="dialog" aria-modal="true">
    <div class="modal-header">
      <h3>Weekly Availability</h3>
      <button class="btn btn-ghost" (click)="closeAvailabilityModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <!-- Desktop Table View -->
      <table class="availability-table">
        <thead>
          <tr>
            <th>Day</th>
            <th>Available</th>
            <th>Start</th>
            <th>End</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let d of days">
            <td>{{ d.dayOfWeek }}</td>
            <td>
              <input type="checkbox" [(ngModel)]="d.isAvailable" />
              <span *ngIf="d.hasExistingAppointments" class="warning-text">
                ({{ d.existingAppointments?.length }} appointments)
              </span>
            </td>
            <td>
              <input type="time" [(ngModel)]="d.startTime" [disabled]="!d.isAvailable" />
            </td>
            <td>
              <input type="time" [(ngModel)]="d.endTime" [disabled]="!d.isAvailable" />
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Mobile Card View -->
      <div class="mobile-availability-cards">
        <div class="availability-card" *ngFor="let d of days">
          <div class="availability-card-header">
            <h4>{{ d.dayOfWeek }}</h4>
            <div class="availability-toggle">
              <input type="checkbox" [(ngModel)]="d.isAvailable" id="available-{{ d.dayOfWeek }}" />
              <label for="available-{{ d.dayOfWeek }}" class="toggle-label">
                <span class="toggle-text">{{ d.isAvailable ? 'Available' : 'Not Available' }}</span>
              </label>
            </div>
          </div>
          
          <div class="availability-card-content" [class.disabled]="!d.isAvailable">
            <div class="time-inputs">
              <div class="time-input-group">
                <label>Start Time</label>
                <input type="time" [(ngModel)]="d.startTime" [disabled]="!d.isAvailable" />
              </div>
              <div class="time-input-group">
                <label>End Time</label>
                <input type="time" [(ngModel)]="d.endTime" [disabled]="!d.isAvailable" />
              </div>
            </div>
            
            <div class="appointment-warning" *ngIf="d.hasExistingAppointments">
              <span class="warning-icon">‚ö†Ô∏è</span>
              <span class="warning-text">
                {{ d.existingAppointments?.length }} existing appointment(s)
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div *ngIf="conflictError" class="conflict-warning">
      <h4>Cannot Update Availability</h4>
      <p>{{ conflictError.message }}</p>
      <ul>
        <li *ngFor="let conflict of conflictError.conflicts">{{ conflict }}</li>
      </ul>
      <p>You can request reschedule for affected appointments:</p>
      <div class="conflict-actions">
        <button *ngFor="let conflict of conflictError.conflicts" 
                class="btn btn-ghost" 
                (click)="requestRescheduleForDay(conflict.split(' ')[0])">
          Reschedule {{ conflict.split(' ')[0] }}
        </button>
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="btn btn-ghost" (click)="closeAvailabilityModal()">Cancel</button>
      <button class="btn btn-accept" [disabled]="saving || conflictError" (click)="saveAvailability()">{{ saving ? 'Saving‚Ä¶' : 'Save' }}</button>
    </div>
  </div>

  <!-- Reschedule Modal -->
  <div class="modal-backdrop" *ngIf="showRescheduleModal" (click)="closeRescheduleModal()"></div>
  <div class="modal" *ngIf="showRescheduleModal" role="dialog" aria-modal="true">
    <div class="modal-header">
      <h3>Request Reschedule for {{ conflictDay }}</h3>
      <button class="btn btn-ghost" (click)="closeRescheduleModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <p>This will send reschedule requests to all patients with appointments on {{ conflictDay }}.</p>
      <label>Reason for reschedule:</label>
      <textarea [(ngModel)]="rescheduleReason" placeholder="Please provide a reason for the reschedule request..." rows="3"></textarea>

      <div class="reschedule-inputs">
        <div class="reschedule-input-group">
          <label>Proposed new date (optional)</label>
          <input type="date" [(ngModel)]="rescheduleNewDate" />
        </div>
        <div class="reschedule-input-group">
          <label>Proposed new time (optional)</label>
          <input type="time" [(ngModel)]="rescheduleNewTime" />
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" (click)="closeRescheduleModal()">Cancel</button>
      <button class="btn btn-accept" [disabled]="!rescheduleReason.trim()" (click)="submitReschedule()">Send Reschedule Requests</button>
    </div>
  </div>
</div>
